[1mdiff --git a/src/App.jsx b/src/App.jsx[m
[1mindex 249851f..0c9df85 100644[m
[1m--- a/src/App.jsx[m
[1m+++ b/src/App.jsx[m
[36m@@ -1,47 +1,103 @@[m
 import React from "react";[m
[31m-import { BrowserRouter as Router, Routes, Route } from "react-router-dom";[m
[32m+[m[32mimport {[m
[32m+[m[32m  BrowserRouter as Router,[m
[32m+[m[32m  Routes,[m
[32m+[m[32m  Route,[m
[32m+[m[32m  Navigate,[m
[32m+[m[32m} from "react-router-dom";[m
[32m+[m
 import LandingPage from "./pages/LandingPage";[m
[31m-import AttentionPage from "./pages/AttentionPage";[m
 import MultiStepForm from "./pages/MultiStepForm";[m
 import CekStatus from "./pages/CekStatus";[m
 import HasilCek from "./pages/HasilCek";[m
 import HasilTolak from "./pages/HasilTolak";[m
 import HasilProses from "./pages/HasilProses";[m
 [m
[31m-import { [m
[31m-  AdminLogin, [m
[31m-  Dashboard, [m
[31m-  VerifikasiPersetujuan, [m
[31m-  KartuVisitor, [m
[31m-  RiwayatPengembalian [m
[32m+[m[32mimport {[m
[32m+[m[32m  AdminLogin,[m
[32m+[m[32m  Dashboard,[m
[32m+[m[32m  VerifikasiPersetujuan,[m
[32m+[m[32m  KartuVisitor,[m
[32m+[m[32m  RiwayatPengembalian,[m
 } from "./admin";[m
 import FormDetail from "./admin/FormDetail";[m
[31m-import DetailKerusakan from "./admin/DetailKerusakan";[m
[32m+[m
[32m+[m[32mfunction RequireAuth({ children }) {[m
[32m+[m[32m  const token = localStorage.getItem("token");[m
[32m+[m[32m  if (!token) {[m
[32m+[m[32m    return <Navigate to="/admin" replace />;[m
[32m+[m[32m  }[m
[32m+[m[32m  return children;[m
[32m+[m[32m}[m
 [m
 function App() {[m
   return ([m
     <Router>[m
       <Routes>[m
         <Route path="/" element={<LandingPage />} />[m
[31m-        {/* Routing baru untuk flow pengajuan */}[m
[31m-        <Route path="/apply/attention" element={<AttentionPage />} />[m
[31m-        <Route path="/apply/form" element={<MultiStepForm />} />[m
[32m+[m[32m        <Route path="/apply" element={<MultiStepForm />} />[m
         <Route path="/status" element={<CekStatus />} />[m
         <Route path="/status/approved" element={<HasilCek />} />[m
         <Route path="/status/rejected" element={<HasilTolak />} />[m
         <Route path="/status/processing" element={<HasilProses />} />[m
 [m
[31m-        {/* Admin Routes */}[m
         <Route path="/admin" element={<AdminLogin />} />[m
[31m-        <Route path="/admin/dashboard" element={<Dashboard />} />[m
[31m-        <Route path="/admin/verifikasi" element={<VerifikasiPersetujuan />} />[m
[31m-        <Route path="/admin/kartu-visitor" element={<KartuVisitor />} />[m
[31m-        <Route path="/admin/riwayat" element={<RiwayatPengembalian />} />[m
[31m-        <Route path="/admin/form-detail" element={<FormDetail />} />[m
[31m-        <Route path="/admin/detail-kerusakan" element={<DetailKerusakan />} />[m
[32m+[m
[32m+[m[32m        <Route[m
[32m+[m[32m          path="/admin/dashboard"[m
[32m+[m[32m          element={[m
[32m+[m[32m            <RequireAuth>[m
[32m+[m[32m              <Dashboard />[m
[32m+[m[32m            </RequireAuth>[m
[32m+[m[32m          }[m
[32m+[m[32m        />[m
[32m+[m[32m        <Route[m
[32m+[m[32m          path="/admin/verifikasi"[m
[32m+[m[32m          element={[m
[32m+[m[32m            <RequireAuth>[m
[32m+[m[32m              <VerifikasiPersetujuan />[m
[32m+[m[32m            </RequireAuth>[m
[32m+[m[32m          }[m
[32m+[m[32m        />[m
[32m+[m[32m        <Route[m
[32m+[m[32m          path="/admin/kartu-visitor"[m
[32m+[m[32m          element={[m
[32m+[m[32m            <RequireAuth>[m
[32m+[m[32m              <KartuVisitor />[m
[32m+[m[32m            </RequireAuth>[m
[32m+[m[32m          }[m
[32m+[m[32m        />[m
[32m+[m[32m        <Route[m
[32m+[m[32m          path="/admin/riwayat"[m
[32m+[m[32m          element={[m
[32m+[m[32m            <RequireAuth>[m
[32m+[m[32m              <RiwayatPengembalian />[m
[32m+[m[32m            </RequireAuth>[m
[32m+[m[32m          }[m
[32m+[m[32m        />[m
[32m+[m
[32m+[m[32m        <Route[m
[32m+[m[32m          path="/admin/detail/:reference"[m
[32m+[m[32m          element={[m
[32m+[m[32m            <RequireAuth>[m
[32m+[m[32m              <FormDetail />[m
[32m+[m[32m            </RequireAuth>[m
[32m+[m[32m          }[m
[32m+[m[32m        />[m
[32m+[m
[32m+[m[32m        <Route[m
[32m+[m[32m          path="/admin/form-detail"[m
[32m+[m[32m          element={[m
[32m+[m[32m            <RequireAuth>[m
[32m+[m[32m              <FormDetail />[m
[32m+[m[32m            </RequireAuth>[m
[32m+[m[32m          }[m
[32m+[m[32m        />[m
[32m+[m
[32m+[m[32m        <Route path="*" element={<Navigate to="/" replace />} />[m
       </Routes>[m
     </Router>[m
   );[m
 }[m
 [m
[31m-export default App;[m
\ No newline at end of file[m
[32m+[m[32mexport default App;[m
[1mdiff --git a/src/admin/AdminLogin.jsx b/src/admin/AdminLogin.jsx[m
[1mindex 7dd15f8..8d0c172 100644[m
[1m--- a/src/admin/AdminLogin.jsx[m
[1m+++ b/src/admin/AdminLogin.jsx[m
[36m@@ -4,19 +4,45 @@[m [mimport { FaUser, FaEye, FaEyeSlash } from "react-icons/fa";[m
 import kaiLogo from "../assets/KAI-logo.png";[m
 import trainImg from "../assets/login-train.png";[m
 [m
[32m+[m[32mimport { adminLogin, getAdminMe, setAuthToken } from "../api";[m
[32m+[m
 export default function AdminLogin() {[m
[31m-  const [email, setEmail] = useState("");[m
[32m+[m[32m  const [email, setEmail] = useState("");[m[41m          [m
   const [password, setPassword] = useState("");[m
   const [showPassword, setShowPassword] = useState(false);[m
   const [err, setErr] = useState("");[m
[32m+[m[32m  const [loading, setLoading] = useState(false);[m
   const navigate = useNavigate();[m
 [m
[31m-  const handleLogin = (e) => {[m
[32m+[m[32m  const handleLogin = async (e) => {[m
     e.preventDefault();[m
[31m-    if (email === "admin@kai.id" && password === "admin123") {[m
[32m+[m[32m    setErr("");[m
[32m+[m[32m    setLoading(true);[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m      const { data } = await adminLogin({ email: email.trim(), password });[m
[32m+[m[32m      setAuthToken(data?.token);[m[41m [m
[32m+[m[32m      try {[m
[32m+[m[32m        const me = await getAdminMe();[m
[32m+[m[32m        const adminName =[m
[32m+[m[32m          me?.data?.full_name ||[m
[32m+[m[32m          me?.data?.name ||[m
[32m+[m[32m          data?.user?.full_name ||[m
[32m+[m[32m          data?.user?.name ||[m
[32m+[m[32m          "Admin";[m
[32m+[m[32m        localStorage.setItem("adminName", adminName);[m
[32m+[m[32m      } catch {[m
[32m+[m[32m      }[m
[32m+[m
       navigate("/admin/dashboard");[m
[31m-    } else {[m
[31m-      setErr("Email atau Password salah!");[m
[32m+[m[32m    } catch (error) {[m
[32m+[m[32m      setErr([m
[32m+[m[32m        error?.response?.status === 401[m
[32m+[m[32m          ? "Email atau Password salah!"[m
[32m+[m[32m          : error?.response?.data?.message || "Gagal login"[m
[32m+[m[32m      );[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      setLoading(false);[m
     }[m
   };[m
 [m
[36m@@ -42,42 +68,43 @@[m [mexport default function AdminLogin() {[m
           </div>[m
         </div>[m
 [m
[31m-        {/* Form Login */}[m
[32m+[m[32m        {/* Kanan */}[m
         <div className="w-1/2 h-full flex items-center justify-center bg-white">[m
           <div className="w-[360px]">[m
             <div className="mb-7 text-center">[m
[31m-              <span className="text-[1.4rem] font-poppins font-semibold">[m
[31m-                Login[m
[31m-              </span>[m
[32m+[m[32m              <span className="text-[1.4rem] font-poppins font-semibold">Login</span>[m
             </div>[m
[31m-            [m
[32m+[m
             <form className="flex flex-col gap-6" onSubmit={handleLogin}>[m
               <div className="relative flex items-center">[m
                 <input[m
[31m-                  type="text"[m
[32m+[m[32m                  type="email"[m
                   placeholder="Email"[m
                   value={email}[m
[32m+[m[32m                  autoFocus[m
                   className="w-full h-[44px] pl-4 pr-10 bg-[#E6E6E6] text-[#6A6A6A] rounded-md font-poppins font-medium"[m
[31m-                  onChange={e => setEmail(e.target.value)}[m
[32m+[m[32m                  onChange={(e) => setEmail(e.target.value)}[m
[32m+[m[32m                  required[m
                 />[m
                 <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[#333]">[m
                   <FaUser size={22} />[m
                 </span>[m
               </div>[m
[31m-              [m
[32m+[m
               <div className="relative flex items-center">[m
                 <input[m
                   type={showPassword ? "text" : "password"}[m
                   placeholder="Password"[m
                   value={password}[m
                   className="w-full h-[44px] pl-4 pr-10 bg-[#E6E6E6] text-[#6A6A6A] rounded-md font-poppins font-medium password-field"[m
[31m-                  onChange={e => setPassword(e.target.value)}[m
[32m+[m[32m                  onChange={(e) => setPassword(e.target.value)}[m
[32m+[m[32m                  required[m
                 />[m
[31m-                [m
                 {password && ([m
[31m-                  <span [m
[32m+[m[32m                  <span[m
                     className="absolute right-3 top-1/2 -translate-y-1/2 text-[#333] cursor-pointer"[m
[31m-                    onClick={() => setShowPassword(!showPassword)}[m
[32m+[m[32m                    onClick={() => setShowPassword((v) => !v)}[m
[32m+[m[32m                    aria-label="Toggle password"[m
                   >[m
                     {showPassword ? <FaEyeSlash size={22} /> : <FaEye size={22} />}[m
                   </span>[m
[36m@@ -92,26 +119,25 @@[m [mexport default function AdminLogin() {[m
 [m
               <button[m
                 type="submit"[m
[31m-                className="w-full h-[44px] bg-[#203D8C] rounded-md text-white text-[1rem] font-poppins font-bold mt-1 hover:bg-[#1a3278] transition-colors"[m
[32m+[m[32m                disabled={loading}[m
[32m+[m[32m                className="w-full h-[44px] bg-[#203D8C] rounded-md text-white text-[1rem] font-poppins font-bold mt-1 hover:bg-[#1a3278] transition-colors disabled:opacity-60"[m
               >[m
[31m-                Login[m
[32m+[m[32m                {loading ? "Loading..." : "Login"}[m
               </button>[m
             </form>[m
           </div>[m
         </div>[m
       </div>[m
 [m
[31m-      {/* Custom CSS untuk gradient dan password field */}[m
[32m+[m[32m      {/* Custom CSS */}[m
       <style jsx>{`[m
         .bg-gradient-custom {[m
           background: linear-gradient(90deg, rgba(106,139,176,0.85) 0%, rgba(94,91,173,0.80) 100%);[m
         }[m
[31m-        [m
         .password-field::-ms-reveal,[m
         .password-field::-ms-clear {[m
           display: none;[m
         }[m
[31m-        [m
         .password-field::-webkit-credentials-auto-fill-button {[m
           display: none !important;[m
           visibility: hidden;[m
[36m@@ -122,4 +148,4 @@[m [mexport default function AdminLogin() {[m
       `}</style>[m
     </>[m
   );[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
[1mdiff --git a/src/admin/Dashboard.jsx b/src/admin/Dashboard.jsx[m
[1mindex b020a9b..3e8d967 100644[m
[1m--- a/src/admin/Dashboard.jsx[m
[1m+++ b/src/admin/Dashboard.jsx[m
[36m@@ -1,99 +1,164 @@[m
[31m-import React, { useState, useRef } from "react";[m
[32m+[m[32m// src/admin/Dashboard.jsx[m
[32m+[m[32mimport React, { useState, useRef, useEffect } from "react";[m
 import { useNavigate, useLocation } from "react-router-dom";[m
 import { Icon } from "@iconify/react";[m
 import kaiLogo from "../assets/KAI-logo.png";[m
 [m
[31m-const dummyStats = {[m
[31m-  aktif: 20,[m
[31m-  verifikasi: 5,[m
[31m-  masukHariIni: 10,[m
[31m-  keluarHariIni: 5,[m
[31m-  rusak: 5,[m
[31m-  hilang: 2,[m
[31m-};[m
[32m+[m[32mimport {[m
[32m+[m[32m  getActiveCards,[m
[32m+[m[32m  getVerificationsAll,[m
[32m+[m[32m  getTodayIssued,[m
[32m+[m[32m  getTodayReturned,[m
[32m+[m[32m  getDamagedCards,[m
[32m+[m[32m  getLostCards,[m
[32m+[m[32m  adminLogout,[m
[32m+[m[32m} from "../api";[m
 [m
 const cardConfig = [[m
[31m-  {[m
[31m-    title: "Total Aktif",[m
[31m-    valueKey: "aktif",[m
[31m-    icon: "streamline-plump:user-pin-remix",[m
[31m-  },[m
[31m-  {[m
[31m-    title: "Menunggu Verifikasi",[m
[31m-    valueKey: "verifikasi",[m
[31m-    icon: "streamline-sharp:time-lapse-solid",[m
[31m-  },[m
[31m-  {[m
[31m-    title: "Total Kartu Masuk Hari Ini",[m
[31m-    valueKey: "masukHariIni",[m
[31m-    icon: "solar:card-recive-outline",[m
[31m-  },[m
[31m-  {[m
[31m-    title: "Total Kartu Keluar Hari Ini",[m
[31m-    valueKey: "keluarHariIni",[m
[31m-    icon: "solar:card-send-outline",[m
[31m-  },[m
[31m-  {[m
[31m-    title: "Total Kartu Rusak",[m
[31m-    valueKey: "rusak",[m
[31m-    icon: "mdi:credit-card-remove-outline",[m
[31m-  },[m
[31m-  {[m
[31m-    title: "Kartu Hilang",[m
[31m-    valueKey: "hilang",[m
[31m-    icon: "solar:card-search-broken",[m
[31m-  },[m
[32m+[m[32m  { title: "Total Aktif",                 valueKey: "aktif",        icon: "streamline-plump:user-pin-remix" },[m
[32m+[m[32m  { title: "Menunggu Verifikasi",         valueKey: "verifikasi",   icon: "streamline-sharp:time-lapse-solid" },[m
[32m+[m[32m  { title: "Total Kartu Masuk Hari Ini",  valueKey: "masukHariIni", icon: "solar:card-recive-outline" },[m
[32m+[m[32m  { title: "Total Kartu Keluar Hari Ini", valueKey: "keluarHariIni",icon:"solar:card-send-outline" },[m
[32m+[m[32m  { title: "Total Kartu Rusak",           valueKey: "rusak",        icon: "mdi:credit-card-remove-outline" },[m
[32m+[m[32m  { title: "Total Kartu Hilang",          valueKey: "hilang",       icon: "solar:card-search-broken" },[m
 ];[m
 [m
[32m+[m[32m// =============== helpers ===============[m
[32m+[m[32mfunction extractArray(res) {[m
[32m+[m[32m  const d = res?.data;[m
[32m+[m[32m  if (Array.isArray(d)) return d;[m
[32m+[m[32m  if (Array.isArray(d?.data)) return d.data;[m
[32m+[m[32m  if (Array.isArray(d?.data?.data)) return d.data.data;[m
[32m+[m[32m  return [];[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction isPendingStatus(raw) {[m
[32m+[m[32m  const s = String([m
[32m+[m[32m    raw?.status ?? raw?.application_status ?? raw?.state ?? raw ?? ""[m
[32m+[m[32m  ).toLowerCase();[m
[32m+[m[32m  return ([m
[32m+[m[32m    s === "pending" ||[m
[32m+[m[32m    s === "menunggu" ||[m
[32m+[m[32m    s === "menunggu persetujuan" ||[m
[32m+[m[32m    s === "processing" ||[m
[32m+[m[32m    s === "in_review" ||[m
[32m+[m[32m    s === "review" ||[m
[32m+[m[32m    s.includes("pending") ||[m
[32m+[m[32m    s.includes("menunggu") ||[m
[32m+[m[32m    s.includes("process") ||[m
[32m+[m[32m    s.includes("waiting") ||[m
[32m+[m[32m    s.includes("review")[m
[32m+[m[32m  );[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Baca kondisi dari item aktif (berbagai kemungkinan nama field)[m
[32m+[m[32mfunction readCondition(item) {[m
[32m+[m[32m  return ([m
[32m+[m[32m    item?.condition ??[m
[32m+[m[32m    item?.card_condition ??[m
[32m+[m[32m    item?.kondisi ??[m
[32m+[m[32m    item?.status_condition ??[m
[32m+[m[32m    ""[m
[32m+[m[32m  );[m
[32m+[m[32m}[m
[32m+[m[32mfunction isLost(item) {[m
[32m+[m[32m  const v = String(readCondition(item)).toLowerCase();[m
[32m+[m[32m  return v === "lost" || v === "hilang" || v.includes("lost") || v.includes("hilang");[m
[32m+[m[32m}[m
[32m+[m[32mfunction isDamaged(item) {[m
[32m+[m[32m  const v = String(readCondition(item)).toLowerCase();[m
[32m+[m[32m  return v === "damaged" || v === "rusak" || v.includes("damaged") || v.includes("rusak");[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Parser angka yang toleran berbagai bentuk payload[m
[32m+[m[32mfunction parseFlexibleTotal(res) {[m
[32m+[m[32m  const d = res?.data;[m
[32m+[m
[32m+[m[32m  // angka / string angka langsung[m
[32m+[m[32m  if (typeof d === "number") return d;[m
[32m+[m[32m  if (typeof d === "string" && !isNaN(Number(d))) return Number(d);[m
[32m+[m
[32m+[m[32m  // kunci umum di top-level[m
[32m+[m[32m  const keys = [[m
[32m+[m[32m    "total", "count",[m
[32m+[m[32m    "damaged", "lost", "rusak", "hilang",[m
[32m+[m[32m    "total_damaged", "total_lost",[m
[32m+[m[32m    "totalRusak", "totalHilang",[m
[32m+[m[32m    "count_damaged", "count_lost",[m
[32m+[m[32m    "jumlah_rusak", "jumlah_hilang",[m
[32m+[m[32m  ];[m
[32m+[m[32m  for (const k of keys) {[m
[32m+[m[32m    const v = d?.[k];[m
[32m+[m[32m    if (typeof v === "number") return v;[m
[32m+[m[32m    if (typeof v === "string" && !isNaN(Number(v))) return Number(v);[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  // nested containers[m
[32m+[m[32m  const containers = ["counts", "stats", "data", "result"];[m
[32m+[m[32m  for (const c of containers) {[m
[32m+[m[32m    const obj = d?.[c];[m
[32m+[m[32m    if (obj && typeof obj === "object") {[m
[32m+[m[32m      for (const k of keys) {[m
[32m+[m[32m        const v = obj?.[k];[m
[32m+[m[32m        if (typeof v === "number") return v;[m
[32m+[m[32m        if (typeof v === "string" && !isNaN(Number(v))) return Number(v);[m
[32m+[m[32m      }[m
[32m+[m[32m      if (typeof obj?.total === "number") return obj.total;[m
[32m+[m[32m      if (typeof obj?.count === "number") return obj.count;[m
[32m+[m[32m      if (Array.isArray(obj)) return obj.length;[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  // array[m
[32m+[m[32m  const arr = extractArray(res);[m
[32m+[m[32m  if (Array.isArray(arr)) return arr.length;[m
[32m+[m
[32m+[m[32m  // fallback â€“ jumlahkan angka di object[m
[32m+[m[32m  if (d && typeof d === "object") {[m
[32m+[m[32m    const nums = Object.values(d).filter((v) => typeof v === "number");[m
[32m+[m[32m    if (nums.length === 1) return nums[0];[m
[32m+[m[32m    if (nums.length > 1) return nums.reduce((s, v) => s + v, 0);[m
[32m+[m[32m  }[m
[32m+[m[32m  return 0;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// =============== component ===============[m
 export default function Dashboard() {[m
   const [showDropdown, setShowDropdown] = useState(false);[m
[32m+[m[32m  const [loading, setLoading] = useState(true);[m
[32m+[m[32m  const [firstLoad, setFirstLoad] = useState(true);[m
[32m+[m[32m  const [err, setErr] = useState("");[m
[32m+[m[32m  const [stats, setStats] = useState({[m
[32m+[m[32m    aktif: 0,[m
[32m+[m[32m    verifikasi: 0,[m
[32m+[m[32m    masukHariIni: 0,[m
[32m+[m[32m    keluarHariIni: 0,[m
[32m+[m[32m    rusak: 0,[m
[32m+[m[32m    hilang: 0,[m
[32m+[m[32m  });[m
[32m+[m
[32m+[m[32m  const lastRequestId = useRef(0);[m
[32m+[m[32m  const refreshTimer = useRef(null);[m
[32m+[m
   const dropdownRef = useRef();[m
   const navigate = useNavigate();[m
   const location = useLocation();[m
[31m-  const adminName = "Admin rafi";[m
[31m-[m
[31m-  const menuItems = [[m
[31m-    {[m
[31m-      label: "Dashboard",[m
[31m-      icon: "streamline-plump:user-pin-remix",[m
[31m-      path: "/admin/dashboard",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Verifikasi & Persetujuan",[m
[31m-      icon: "streamline-sharp:time-lapse-solid",[m
[31m-      path: "/admin/verifikasi",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Kartu Visitor",[m
[31m-      icon: "solar:card-recive-outline",[m
[31m-      path: "/admin/kartu-visitor",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Riwayat Pengembalian",[m
[31m-      icon: "solar:card-search-broken",[m
[31m-      path: "/admin/riwayat",[m
[31m-    },[m
[31m-  ];[m
[32m+[m[32m  const adminName = localStorage.getItem("adminName") || "Admin";[m
[32m+[m[32m  const adminInitial = adminName?.[0]?.toUpperCase?.() || "A";[m
 [m
[31m-  // Handle menu navigation[m
[31m-  const handleMenuClick = (path) => {[m
[31m-    navigate(path);[m
[31m-  };[m
[32m+[m[32m  const handleMenuClick = (path) => navigate(path);[m
 [m
[31m-  // Handle logout[m
[31m-  const handleLogout = () => {[m
[31m-    // Clear any authentication data here if needed[m
[32m+[m[32m  const handleLogout = async () => {[m
[32m+[m[32m    try { await adminLogout(); } catch {}[m
[32m+[m[32m    localStorage.removeItem("token");[m
[32m+[m[32m    localStorage.removeItem("adminName");[m
     navigate("/admin");[m
     setShowDropdown(false);[m
   };[m
 [m
[31m-  // Handle click outside dropdown[m
[31m-  React.useEffect(() => {[m
[31m-    function handleClickOutside(event) {[m
[31m-      if ([m
[31m-        dropdownRef.current &&[m
[31m-        !dropdownRef.current.contains(event.target)[m
[31m-      ) {[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    function handleClickOutside(e) {[m
[32m+[m[32m      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {[m
         setShowDropdown(false);[m
       }[m
     }[m
[36m@@ -101,6 +166,207 @@[m [mexport default function Dashboard() {[m
     return () => document.removeEventListener("mousedown", handleClickOutside);[m
   }, []);[m
 [m
[32m+[m[32m  const debouncedRefresh = (opts = { initial: false }, delay = 250) => {[m
[32m+[m[32m    if (refreshTimer.current) clearTimeout(refreshTimer.current);[m
[32m+[m[32m    refreshTimer.current = setTimeout(() => {[m
[32m+[m[32m      loadStats(opts);[m
[32m+[m[32m    }, delay);[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  // Selalu ambil fresh untuk rusak/hilang dan gabungkan dengan aktif[m
[32m+[m[32m  const refreshCounters = async () => {[m
[32m+[m[32m    const ttlOpt = { ttl: 0 }; // paksa tanpa cache[m
[32m+[m[32m    try {[m
[32m+[m[32m      const [damagedRes, lostRes, activeRes] = await Promise.all([[m
[32m+[m[32m        getDamagedCards(ttlOpt),[m
[32m+[m[32m        getLostCards(ttlOpt),[m
[32m+[m[32m        getActiveCards(ttlOpt),[m
[32m+[m[32m      ]);[m
[32m+[m
[32m+[m[32m      const baseDamaged = parseFlexibleTotal(damagedRes);[m
[32m+[m[32m      const baseLost = parseFlexibleTotal(lostRes);[m
[32m+[m
[32m+[m[32m      const activeArr = extractArray(activeRes);[m
[32m+[m[32m      const activeDamaged = activeArr.filter(isDamaged).length;[m
[32m+[m[32m      const activeLost = activeArr.filter(isLost).length;[m
[32m+[m
[32m+[m[32m      setStats((prev) => ({[m
[32m+[m[32m        ...prev,[m
[32m+[m[32m        rusak: baseDamaged + activeDamaged,[m
[32m+[m[32m        hilang: baseLost + activeLost,[m
[32m+[m[32m      }));[m
[32m+[m[32m    } catch {[m
[32m+[m[32m      // jangan blok UI[m
[32m+[m[32m    }[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  // Loader utama + anti-race[m
[32m+[m[32m  const loadStats = async ({ initial = false } = {}) => {[m
[32m+[m[32m    const reqId = ++lastRequestId.current;[m
[32m+[m
[32m+[m[32m    if (initial) {[m
[32m+[m[32m      setLoading(true);[m
[32m+[m[32m      setErr("");[m
[32m+[m[32m    } else {[m
[32m+[m[32m      setErr("");[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m      const [[m
[32m+[m[32m        activeCardsRes,[m
[32m+[m[32m        verificationsRes,[m
[32m+[m[32m        inTodayRes,[m
[32m+[m[32m        outTodayRes,[m
[32m+[m[32m        damagedRes,[m
[32m+[m[32m        lostRes,[m
[32m+[m[32m      ] = await Promise.all([[m
[32m+[m[32m        getActiveCards(),       // boleh cached (lihat api.js: TTL kecil + _ts)[m
[32m+[m[32m        getVerificationsAll(),  // pending/approved/rejected digabung[m
[32m+[m[32m        getTodayIssued(),[m
[32m+[m[32m        getTodayReturned(),[m
[32m+[m[32m        getDamagedCards(),[m
[32m+[m[32m        getLostCards(),[m
[32m+[m[32m      ]);[m
[32m+[m
[32m+[m[32m      if (reqId !== lastRequestId.current) return;[m
[32m+[m
[32m+[m[32m      const activeArr = extractArray(activeCardsRes);[m
[32m+[m[32m      const totalAktif =[m
[32m+[m[32m        typeof activeCardsRes?.data === "number"[m
[32m+[m[32m          ? activeCardsRes.data[m
[32m+[m[32m          : typeof activeCardsRes?.data?.total === "number"[m
[32m+[m[32m          ? activeCardsRes.data.total[m
[32m+[m[32m          : activeArr.length;[m
[32m+[m
[32m+[m[32m      const verifArr = extractArray(verificationsRes);[m
[32m+[m[32m      let totalPending = verifArr.filter(isPendingStatus).length;[m
[32m+[m[32m      if (totalPending === 0 && typeof verificationsRes?.data?.total === "number") {[m
[32m+[m[32m        totalPending = verificationsRes.data.total;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      // gabungkan counter backend + yang masih aktif bertanda rusak/hilang[m
[32m+[m[32m      const activeDamaged = activeArr.filter(isDamaged).length;[m
[32m+[m[32m      const activeLost = activeArr.filter(isLost).length;[m
[32m+[m[32m      const damagedTotal = parseFlexibleTotal(damagedRes) + activeDamaged;[m
[32m+[m[32m      const lostTotal = parseFlexibleTotal(lostRes) + activeLost;[m
[32m+[m
[32m+[m[32m      setStats({[m
[32m+[m[32m        aktif: totalAktif,[m
[32m+[m[32m        verifikasi: totalPending,[m
[32m+[m[32m        masukHariIni: parseFlexibleTotal(inTodayRes),[m
[32m+[m[32m        keluarHariIni: parseFlexibleTotal(outTodayRes),[m
[32m+[m[32m        rusak: damagedTotal,[m
[32m+[m[32m        hilang: lostTotal,[m
[32m+[m[32m      });[m
[32m+[m[32m      setErr("");[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      const msg = e?.response?.data?.message || e?.message || "Gagal memuat dashboard";[m
[32m+[m[32m      setErr(msg);[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      if (reqId === lastRequestId.current) {[m
[32m+[m[32m        if (initial) setLoading(false);[m
[32m+[m[32m        setFirstLoad(false);[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  // initial load[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    loadStats({ initial: true });[m
[32m+[m[32m    refreshCounters().catch(() => {});[m
[32m+[m[32m    // eslint-disable-next-line react-hooks/exhaustive-deps[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  // Focus/visibility refresh[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    const onFocus = () => debouncedRefresh({ initial: false }, 100);[m
[32m+[m[32m    window.addEventListener("focus", onFocus);[m
[32m+[m[32m    return () => window.removeEventListener("focus", onFocus);[m
[32m+[m[32m  }, []);[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    const onVisibility = () => {[m
[32m+[m[32m      if (!document.hidden) debouncedRefresh({ initial: false }, 100);[m
[32m+[m[32m    };[m
[32m+[m[32m    document.addEventListener("visibilitychange", onVisibility);[m
[32m+[m[32m    return () => document.removeEventListener("visibilitychange", onVisibility);[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  // Event bridge dari halaman lain[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    const onChanged = (e) => {[m
[32m+[m[32m      const eventType = e?.detail?.type;[m
[32m+[m[32m      if (eventType === "damaged" || eventType === "lost" || eventType === "condition-updated") {[m
[32m+[m[32m        refreshCounters().catch(() => {});[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m[32m      if (eventType === "issued" || eventType === "returned") {[m
[32m+[m[32m        debouncedRefresh({ initial: false }, 100);[m
[32m+[m[32m      }[m
[32m+[m[32m    };[m
[32m+[m[32m    window.addEventListener("dashboard:changed", onChanged);[m
[32m+[m[32m    return () => window.removeEventListener("dashboard:changed", onChanged);[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  // storage/BroadcastChannel dirty flags[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    function onStorage(e) {[m
[32m+[m[32m      if (e.key === "dirty:cards") {[m
[32m+[m[32m        debouncedRefresh({ initial: false }, 120);[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[32m    window.addEventListener("storage", onStorage);[m
[32m+[m[32m    return () => window.removeEventListener("storage", onStorage);[m
[32m+[m[32m  }, []);[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    let ch = null;[m
[32m+[m[32m    try {[m
[32m+[m[32m      if (typeof BroadcastChannel !== "undefined") {[m
[32m+[m[32m        ch = new BroadcastChannel("cards-channel");[m
[32m+[m[32m        ch.onmessage = (msg) => {[m
[32m+[m[32m          const data = msg?.data || {};[m
[32m+[m[32m          if (data?.type === "dirty:cards") {[m
[32m+[m[32m            debouncedRefresh({ initial: false }, 80);[m
[32m+[m[32m          }[m
[32m+[m[32m        };[m
[32m+[m[32m      }[m
[32m+[m[32m    } catch {}[m
[32m+[m[32m    return () => { try { if (ch) ch.close(); } catch {} };[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  // Incremental bump[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    const onBump = (e) => {[m
[32m+[m[32m      const { field, delta = 1 } = e.detail || {};[m
[32m+[m[32m      if (!field) return;[m
[32m+[m[32m      setStats((prev) => ({[m
[32m+[m[32m        ...prev,[m
[32m+[m[32m        [field]: Math.max(0, (prev?.[field] ?? 0) + Number(delta || 0)),[m
[32m+[m[32m      }));[m
[32m+[m[32m    };[m
[32m+[m[32m    window.addEventListener("dashboard:increment", onBump);[m
[32m+[m[32m    return () => window.removeEventListener("dashboard:increment", onBump);[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  // Reset harian untuk metrik daily[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    let lastDay = new Date().toDateString();[m
[32m+[m[32m    const tick = () => {[m
[32m+[m[32m      const nowDay = new Date().toDateString();[m
[32m+[m[32m      if (nowDay !== lastDay) {[m
[32m+[m[32m        lastDay = nowDay;[m
[32m+[m[32m        setStats((p) => ({ ...p, masukHariIni: 0, keluarHariIni: 0 }));[m
[32m+[m[32m        debouncedRefresh({ initial: false }, 50);[m
[32m+[m[32m      }[m
[32m+[m[32m    };[m
[32m+[m[32m    const iv = setInterval(tick, 60 * 1000);[m
[32m+[m[32m    const onVis = () => { if (!document.hidden) tick(); };[m
[32m+[m[32m    document.addEventListener("visibilitychange", onVis);[m
[32m+[m[32m    return () => {[m
[32m+[m[32m      clearInterval(iv);[m
[32m+[m[32m      document.removeEventListener("visibilitychange", onVis);[m
[32m+[m[32m    };[m
[32m+[m[32m  }, []);[m
[32m+[m
   return ([m
     <div className="min-h-screen flex bg-[#6A8BB0] font-poppins">[m
       {/* Sidebar */}[m
[36m@@ -113,27 +379,26 @@[m [mexport default function Dashboard() {[m
           Admin Panel Kartu Visitor[m
         </div>[m
         <div className="w-full flex justify-center mb-12">[m
[31m-          <div[m
[31m-            style={{[m
[31m-              width: "100%",[m
[31m-              height: 2,[m
[31m-              background: "#C4C4C4",[m
[31m-              borderRadius: 2,[m
[31m-              margin: "0 auto",[m
[31m-            }}[m
[31m-          />[m
[32m+[m[32m          <div style={{ width: "100%", height: 2, background: "#C4C4C4", borderRadius: 2, margin: "0 auto" }} />[m
         </div>[m
[32m+[m
         <nav className="flex flex-col gap-4 mt-2">[m
[31m-          {menuItems.map((item) => {[m
[32m+[m[32m          {[[m
[32m+[m[32m            { label: "Dashboard",                icon: "streamline-plump:user-pin-remix", path: "/admin/dashboard" },[m
[32m+[m[32m            { label: "Verifikasi & Persetujuan", icon: "streamline-sharp:time-lapse-solid", path: "/admin/verifikasi" },[m
[32m+[m[32m            { label: "Kartu Visitor",            icon: "solar:card-recive-outline", path: "/admin/kartu-visitor" },[m
[32m+[m[32m            { label: "Riwayat Pengembalian",     icon: "solar:card-search-broken", path: "/admin/riwayat" },[m
[32m+[m[32m          ].map((item) => {[m
             const isActive = location.pathname === item.path;[m
             return ([m
               <button[m
                 key={item.label}[m
                 onClick={() => handleMenuClick(item.path)}[m
                 className={`flex items-center gap-4 px-4 py-2 text-left transition-all hover:opacity-80[m
[31m-                  ${isActive[m
[31m-                    ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]"[m
[31m-                    : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"[m
[32m+[m[32m                  ${[m
[32m+[m[32m                    isActive[m
[32m+[m[32m                      ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]"[m
[32m+[m[32m                      : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"[m
                   } text-[17px]`}[m
                 style={isActive ? { boxShadow: "0 2px 8px rgba(90,90,140,0.07)" } : {}}[m
               >[m
[36m@@ -152,9 +417,7 @@[m [mexport default function Dashboard() {[m
         className="flex-1 flex flex-col px-2 md:px-12 py-10 transition-all"[m
         style={{ marginLeft: 360, minHeight: "100vh", width: "100%" }}[m
       >[m
[31m-        {/* Dashboard & Profile Card */}[m
         <div className="flex gap-8 mb-10 flex-wrap">[m
[31m-          {/* Card Dashboard & Admin */}[m
           <div[m
             className="w-full max-w-[900px] flex items-center bg-white rounded-[20px] shadow-md px-8 py-4 relative mx-auto"[m
             style={{ minHeight: 70 }}[m
[36m@@ -162,38 +425,26 @@[m [mexport default function Dashboard() {[m
             <span className="font-poppins font-semibold text-[24px] text-[#474646]">[m
               Dashboard[m
             </span>[m
[31m-            {/* Profile section */}[m
[31m-            <div[m
[31m-              className="relative ml-auto"[m
[31m-              style={{ minWidth: 200 }}[m
[31m-              ref={dropdownRef}[m
[31m-            >[m
[31m-              {/* Transparent box behind profile */}[m
[32m+[m
[32m+[m[32m            {/* Profile */}[m
[32m+[m[32m            <div className="relative ml-auto" style={{ minWidth: 200 }} ref={dropdownRef}>[m
               <div[m
                 className="absolute top-0 left-0 w-full h-full"[m
[31m-                style={{[m
[31m-                  background: "rgba(106,139,176,0.13)",[m
[31m-                  borderRadius: 15,[m
[31m-                  zIndex: 0,[m
[31m-                }}[m
[31m-              ></div>[m
[31m-              {/* Profile and name */}[m
[32m+[m[32m                style={{ background: "rgba(106,139,176,0.13)", borderRadius: 15, zIndex: 0 }}[m
[32m+[m[32m              />[m
               <button[m
                 className="relative flex items-center gap-2 px-5 py-2 cursor-pointer z-10 hover:opacity-80 transition-opacity"[m
[31m-                style={{[m
[31m-                  borderRadius: 15,[m
[31m-                  background: "transparent",[m
[31m-                }}[m
[32m+[m[32m                style={{ borderRadius: 15, background: "transparent" }}[m
                 onClick={() => setShowDropdown((prev) => !prev)}[m
               >[m
                 <span className="w-[38px] h-[38px] rounded-full bg-[#6A8BB0] flex items-center justify-center text-white text-[24px] font-poppins font-semibold mr-2">[m
[31m-                  {adminName[0]}[m
[32m+[m[32m                  {adminInitial}[m
                 </span>[m
                 <span className="font-poppins font-medium text-[18px] leading-[36px] text-[#474646]">[m
                   {adminName}[m
                 </span>[m
               </button>[m
[31m-              {/* Dropdown logout */}[m
[32m+[m
               {showDropdown && ([m
                 <div className="absolute top-[62px] right-0 bg-white rounded-[12px] shadow-lg px-6 py-3 z-20 border min-w-[146px] flex items-center gap-3">[m
                   <Icon icon="ic:round-logout" width={34} color="#d61d1d" />[m
[36m@@ -209,7 +460,14 @@[m [mexport default function Dashboard() {[m
           </div>[m
         </div>[m
 [m
[31m-        {/* Cards Section */}[m
[32m+[m[32m        {err && ([m
[32m+[m[32m          <div className="max-w-[900px] mx-auto w-full mb-6">[m
[32m+[m[32m            <div className="bg-red-50 text-red-700 px-4 py-3 rounded-lg border border-red-200">[m
[32m+[m[32m              {err}[m
[32m+[m[32m            </div>[m
[32m+[m[32m          </div>[m
[32m+[m[32m        )}[m
[32m+[m
         <div[m
           className="grid gap-x-8 gap-y-7 w-full"[m
           style={{[m
[36m@@ -218,7 +476,7 @@[m [mexport default function Dashboard() {[m
             margin: "0 auto",[m
           }}[m
         >[m
[31m-          {cardConfig.map((card, idx) => ([m
[32m+[m[32m          {cardConfig.map((card) => ([m
             <div[m
               key={card.title}[m
               className="bg-white rounded-[20px] px-5 py-5 flex flex-col justify-between shadow relative hover:shadow-lg transition-shadow cursor-pointer"[m
[36m@@ -227,16 +485,18 @@[m [mexport default function Dashboard() {[m
                 maxWidth: 440,[m
                 height: 155,[m
                 boxShadow: "0 2px 8px rgba(90,90,140,0.07)",[m
[31m-                display: "flex",[m
               }}[m
               onClick={() => {[m
[31m-                // Navigate to relevant page based on card type[m
[31m-                if (card.valueKey === 'verifikasi') {[m
[31m-                  navigate('/admin/verifikasi');[m
[31m-                } else if (card.valueKey === 'aktif' || card.valueKey === 'masukHariIni' || card.valueKey === 'keluarHariIni') {[m
[31m-                  navigate('/admin/kartu-visitor');[m
[31m-                } else if (card.valueKey === 'rusak' || card.valueKey === 'hilang') {[m
[31m-                  navigate('/admin/riwayat');[m
[32m+[m[32m                if (card.valueKey === "verifikasi") {[m
[32m+[m[32m                  navigate("/admin/verifikasi");[m
[32m+[m[32m                } else if ([m
[32m+[m[32m                  card.valueKey === "aktif" ||[m
[32m+[m[32m                  card.valueKey === "masukHariIni" ||[m
[32m+[m[32m                  card.valueKey === "keluarHariIni"[m
[32m+[m[32m                ) {[m
[32m+[m[32m                  navigate("/admin/kartu-visitor");[m
[32m+[m[32m                } else if (card.valueKey === "rusak" || card.valueKey === "hilang") {[m
[32m+[m[32m                  navigate("/admin/riwayat");[m
                 }[m
               }}[m
             >[m
[36m@@ -244,22 +504,23 @@[m [mexport default function Dashboard() {[m
                 <span className="font-poppins font-semibold text-[18px] text-[#474646]">[m
                   {card.title}[m
                 </span>[m
[31m-                <span[m
[31m-                  className="w-[52px] h-[52px] rounded-[15px] flex items-center justify-center[m
[31m-                    bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD]"[m
[31m-                >[m
[32m+[m[32m                <span className="w-[52px] h-[52px] rounded-[15px] flex items-center justify-center bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD]">[m
                   <Icon icon={card.icon} width={28} height={28} color="#fff" />[m
                 </span>[m
               </div>[m
[32m+[m
               <div className="mt-3 font-poppins font-bold text-[28px] text-[#474646]">[m
[31m-                {dummyStats[card.valueKey]}[m
[32m+[m[32m                {loading && firstLoad ? ([m
[32m+[m[32m                  <span className="animate-pulse inline-block w-16 h-7 rounded-md bg-gray-200" />[m
[32m+[m[32m                ) : ([m
[32m+[m[32m                  stats[card.valueKey] ?? 0[m
[32m+[m[32m                )}[m
               </div>[m
             </div>[m
           ))}[m
         </div>[m
       </main>[m
 [m
[31m-      {/* Font import dan custom CSS */}[m
       <style>{`[m
         @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');[m
         .font-poppins { font-family: 'Poppins', sans-serif; }[m
[36m@@ -273,4 +534,4 @@[m [mexport default function Dashboard() {[m
       `}</style>[m
     </div>[m
   );[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
[1mdiff --git a/src/admin/FormDetail.jsx b/src/admin/FormDetail.jsx[m
[1mindex 3faf540..fc4dc03 100644[m
[1m--- a/src/admin/FormDetail.jsx[m
[1m+++ b/src/admin/FormDetail.jsx[m
[36m@@ -1,222 +1,409 @@[m
[32m+[m[32m// src/admin/FormDetail.jsx[m
 import React, { useState, useEffect } from "react";[m
[31m-import { useNavigate } from "react-router-dom";[m
[32m+[m[32mimport { useNavigate, useParams } from "react-router-dom";[m
 import { Icon } from "@iconify/react";[m
 import kaiLogo from "../assets/KAI-logo.png";[m
 [m
[31m-// Dummy data awal[m
[31m-const initialData = {[m
[31m-  nama: "Azida Kautsar Milla",[m
[31m-  instansi: "Politeknik Elektronika Negeri Surabaya",[m
[31m-  noKtp: "3506132436454600",[m
[31m-  email: "azida@gmail.com",[m
[31m-  tanggal: "08 Agustus 2025",[m
[31m-  dokumen: "Proposal_Magang.pdf",[m
[31m-  handphone: "081324252611",[m
[31m-  stasiun: "Stasiun Lempuyangan",[m
[31m-  selesaiKunjungan: "11 Agustus 2025",[m
[31m-  noPengajuan: "VST-2025-12345677",[m
[31m-  tujuan: "Melakukan observasi dan kegiatan magang di PT KAI",[m
[31m-};[m
[31m-[m
[31m-const adminName = "Rafi";[m
[31m-const STATUS_KEY = "status_pengajuan_azida";[m
[31m-const CATATAN_KEY = "catatan_pengajuan_azida";[m
[32m+[m[32m// API[m
[32m+[m[32mimport {[m
[32m+[m[32m  getVerificationDetail,[m
[32m+[m[32m  approveVerification,[m
[32m+[m[32m  rejectVerification,[m
[32m+[m[32m  ORIGIN,[m
[32m+[m[32m  fetchDocumentBlob,[m
[32m+[m[32m  filenameFromHeaders,[m
[32m+[m[32m} from "../api";[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * Helpers[m
[32m+[m[32m * ========================= */[m
[32m+[m
[32m+[m[32mfunction normalizeStatusLabel(s) {[m
[32m+[m[32m  const v = (s || "").toString().toLowerCase();[m
[32m+[m[32m  if (v === "approved" || v === "disetujui") return "Disetujui";[m
[32m+[m[32m  if (v === "rejected" || v === "ditolak") return "Ditolak";[m
[32m+[m[32m  return "Menunggu";[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction formatTanggalIndo(val) {[m
[32m+[m[32m  if (!val) return "-";[m
[32m+[m[32m  const d = new Date(val);[m
[32m+[m[32m  if (isNaN(d)) return val;[m
[32m+[m[32m  const months = [[m
[32m+[m[32m    "Januari","Februari","Maret","April","Mei","Juni",[m
[32m+[m[32m    "Juli","Agustus","September","Oktober","November","Desember",[m
[32m+[m[32m  ];[m
[32m+[m[32m  return `${String(d.getDate()).padStart(2, "0")} ${months[d.getMonth()]} ${d.getFullYear()}`;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction getFilenameFromUrl(url, fallback = "-") {[m
[32m+[m[32m  if (!url) return fallback;[m
[32m+[m[32m  try {[m
[32m+[m[32m    const u = new URL(url);[m
[32m+[m[32m    const last = u.pathname.split("/").filter(Boolean).pop();[m
[32m+[m[32m    return decodeURIComponent(last || fallback);[m
[32m+[m[32m  } catch {[m
[32m+[m[32m    const last = String(url).split("/").filter(Boolean).pop();[m
[32m+[m[32m    return decodeURIComponent(last || fallback);[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction toFileURL(v) {[m
[32m+[m[32m  if (!v) return "";[m
[32m+[m[32m  if (/^https?:\/\//i.test(v)) return v;[m
[32m+[m[32m  const clean = v.replace(/^\/+/, "");[m
[32m+[m[32m  const finalPath =[m
[32m+[m[32m    clean.startsWith("storage/") || clean.startsWith("uploads/")[m
[32m+[m[32m      ? clean[m
[32m+[m[32m      : `storage/${clean}`;[m
[32m+[m[32m  return `${ORIGIN.replace(/\/+$/,"")}/${finalPath}`;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mconst adminNameFromLS =[m
[32m+[m[32m  localStorage.getItem("adminName") ||[m
[32m+[m[32m  localStorage.getItem("namaPetugas") ||[m
[32m+[m[32m  "Admin";[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * Small Modal (popup kecil)[m
[32m+[m[32m * ========================= */[m
[32m+[m[32mfunction SmallModal({ open, onClose, title, icon, iconColor = "#fff", children }) {[m
[32m+[m[32m  if (!open) return null;[m
[32m+[m[32m  return ([m
[32m+[m[32m    <div[m
[32m+[m[32m      className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-20"[m
[32m+[m[32m      onClick={onClose}[m
[32m+[m[32m    >[m
[32m+[m[32m      <div[m
[32m+[m[32m        className="bg-white rounded-[14px] shadow-lg w-[95%] max-w-[520px] min-w-[360px] relative"[m
[32m+[m[32m        onClick={(e) => e.stopPropagation()}[m
[32m+[m[32m      >[m
[32m+[m[32m        <div[m
[32m+[m[32m          className="flex items-center justify-between px-6 py-4 rounded-t-[14px]"[m
[32m+[m[32m          style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)" }}[m
[32m+[m[32m        >[m
[32m+[m[32m          <div className="flex items-center gap-3">[m
[32m+[m[32m            {icon ? <Icon icon={icon} width={48} height={48} color={iconColor} /> : null}[m
[32m+[m[32m            <span className="font-poppins font-semibold text-white text-[18px]">[m
[32m+[m[32m              {title}[m
[32m+[m[32m            </span>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          {/* Close (X) DIHILANGKAN SESUAI PERMINTAAN */}[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div className="px-6 py-6">{children}</div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    </div>[m
[32m+[m[32m  );[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * Component[m
[32m+[m[32m * ========================= */[m
 [m
 export default function FormDetail() {[m
[31m-  // Ambil status dan catatan dari l[m
[31m-  const getStatusLocal = () => localStorage.getItem(STATUS_KEY) || "Menunggu Persetujuan";[m
[31m-  const getCatatanLocal = () => localStorage.getItem(CATATAN_KEY) || "";[m
[32m+[m[32m  const navigate = useNavigate();[m
[32m+[m[32m  const { reference } = useParams();[m
 [m
   const [showReject, setShowReject] = useState(false);[m
   const [showAccept, setShowAccept] = useState(false);[m
   const [rejectReason, setRejectReason] = useState("");[m
   const [acceptNote, setAcceptNote] = useState("");[m
[31m-  const [status, setStatus] = useState(getStatusLocal());[m
[31m-  const [catatan, setCatatan] = useState(getCatatanLocal());[m
[31m-  const navigate = useNavigate();[m
[32m+[m[32m  const [submitting, setSubmitting] = useState(false);[m
[32m+[m
[32m+[m[32m  const [loading, setLoading] = useState(true);[m
[32m+[m[32m  const [err, setErr] = useState("");[m
[32m+[m
[32m+[m[32m  const [detail, setDetail] = useState({[m
[32m+[m[32m    nama: "-",[m
[32m+[m[32m    instansi: "-",[m
[32m+[m[32m    noKtp: "-",[m
[32m+[m[32m    email: "-",[m
[32m+[m[32m    tanggal: "-",[m
[32m+[m[32m    dokumenNama: "-",[m
[32m+[m[32m    dokumenUrl: "",[m
[32m+[m[32m    dokumenPath: "",[m
[32m+[m[32m    handphone: "-",[m
[32m+[m[32m    stasiun: "-",[m
[32m+[m[32m    selesaiKunjungan: "-",[m
[32m+[m[32m    noPengajuan: reference || "-",[m
[32m+[m[32m    tujuan: "-",[m
[32m+[m[32m    statusLabel: "Menunggu",[m
[32m+[m[32m    catatan: "",[m
[32m+[m[32m    _filenameResolved: false,[m
[32m+[m[32m  });[m
 [m
[31m-  // Sinkron status & catatan dengan localStorage (reload/masuk kembali tetap update)[m
   useEffect(() => {[m
[31m-    setStatus(getStatusLocal());[m
[31m-    setCatatan(getCatatanLocal());[m
[31m-  }, []);[m
[32m+[m[32m    let mounted = true;[m
[32m+[m
[32m+[m[32m    async function fetchDetail() {[m
[32m+[m[32m      if (!reference) {[m
[32m+[m[32m        setErr("Reference number tidak ditemukan.");[m
[32m+[m[32m        setLoading(false);[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      setLoading(true);[m
[32m+[m[32m      setErr("");[m
[32m+[m[32m      try {[m
[32m+[m[32m        const res = await getVerificationDetail({[m
[32m+[m[32m          reference_number: reference,[m
[32m+[m[32m          reference,[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        const raw = res?.data?.data || res?.data || {};[m
[32m+[m
[32m+[m[32m        const nama = raw.applicant_name || raw.full_name || raw.name || "-";[m
[32m+[m[32m        const instansi =[m
[32m+[m[32m          raw.organization || raw.company || raw.institution || raw.agency || "-";[m
[32m+[m[32m        const noKtp = raw.national_id || raw.nik || "-";[m
[32m+[m[32m        const email = raw.email || raw.applicant_email || "-";[m
[32m+[m[32m        const tanggal = formatTanggalIndo([m
[32m+[m[32m          raw.visit_date || raw.visit_start_date || raw.date[m
[32m+[m[32m        );[m
[32m+[m[32m        const selesaiKunjungan = formatTanggalIndo([m
[32m+[m[32m          raw.visit_end_date || raw.end_date || raw.due_date[m
[32m+[m[32m        );[m
[32m+[m[32m        const noPengajuan =[m
[32m+[m[32m          raw.reference_number || raw.reference || raw.ref_no || raw.ref || reference || "-";[m
[32m+[m[32m        const handphone = raw.phone || raw.phone_number || raw.applicant_phone || "-";[m
[32m+[m[32m        const stasiun =[m
[32m+[m[32m          typeof raw.station === "object"[m
[32m+[m[32m            ? raw.station?.name || "-"[m
[32m+[m[32m            : raw.station_name || raw.station || "-";[m
[32m+[m[32m        const tujuan =[m
[32m+[m[32m          raw.purpose || raw.visit_purpose || raw.reason || raw.description || "-";[m
[32m+[m
[32m+[m[32m        const docRaw =[m
[32m+[m[32m          raw.document_url ||[m
[32m+[m[32m          raw.attachment_url ||[m
[32m+[m[32m          raw.document_path ||[m
[32m+[m[32m          raw.document ||[m
[32m+[m[32m          (Array.isArray(raw.documents) ? (raw.documents[0]?.url || raw.documents[0]) : "");[m
[32m+[m
[32m+[m[32m        const dokumenUrl = docRaw ? toFileURL(docRaw) : "";[m
[32m+[m[32m        const dokumenNama =[m
[32m+[m[32m          raw.document_original_name || raw.original_name || getFilenameFromUrl(docRaw, "-");[m
[32m+[m
[32m+[m[32m        const statusLabel = normalizeStatusLabel(raw.status);[m
[32m+[m[32m        const catatan = raw.approval_note || raw.note || raw.rejection_reason || "";[m
[32m+[m
[32m+[m[32m        if (!mounted) return;[m
[32m+[m[32m        setDetail({[m
[32m+[m[32m          nama,[m
[32m+[m[32m          instansi,[m
[32m+[m[32m          noKtp,[m
[32m+[m[32m          email,[m
[32m+[m[32m          tanggal,[m
[32m+[m[32m          dokumenNama,[m
[32m+[m[32m          dokumenUrl,[m
[32m+[m[32m          dokumenPath: docRaw || "",[m
[32m+[m[32m          handphone,[m
[32m+[m[32m          stasiun,[m
[32m+[m[32m          selesaiKunjungan,[m
[32m+[m[32m          noPengajuan,[m
[32m+[m[32m          tujuan,[m
[32m+[m[32m          statusLabel,[m
[32m+[m[32m          catatan,[m
[32m+[m[32m          _filenameResolved: false,[m
[32m+[m[32m        });[m
[32m+[m[32m      } catch (e) {[m
[32m+[m[32m        setErr(e?.response?.data?.message || e?.message || "Gagal memuat detail.");[m
[32m+[m[32m      } finally {[m
[32m+[m[32m        if (mounted) setLoading(false);[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    fetchDetail();[m
[32m+[m[32m    return () => { mounted = false; };[m
[32m+[m[32m  }, [reference]);[m
 [m
[31m-  // Update localStorage setiap kali status/catatan berubah[m
   useEffect(() => {[m
[31m-    localStorage.setItem(STATUS_KEY, status);[m
[31m-    localStorage.setItem(CATATAN_KEY, catatan);[m
[31m-  }, [status, catatan]);[m
[32m+[m[32m    if (!detail.dokumenUrl || detail._filenameResolved) return;[m
[32m+[m
[32m+[m[32m    (async () => {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const resp = await fetchDocumentBlob(detail.dokumenPath || detail.dokumenUrl, {[m
[32m+[m[32m          timeout: 20000,[m
[32m+[m[32m        });[m
[32m+[m[32m        const nameFromHeader = filenameFromHeaders(resp, detail.dokumenNama);[m
[32m+[m[32m        if (nameFromHeader && nameFromHeader !== detail.dokumenNama) {[m
[32m+[m[32m          setDetail((p) => ({ ...p, dokumenNama: nameFromHeader, _filenameResolved: true }));[m
[32m+[m[32m        } else {[m
[32m+[m[32m          setDetail((p) => ({ ...p, _filenameResolved: true }));[m
[32m+[m[32m        }[m
[32m+[m[32m      } catch {[m
[32m+[m[32m        setDetail((p) => ({ ...p, _filenameResolved: true }));[m
[32m+[m[32m      }[m
[32m+[m[32m    })();[m
[32m+[m[32m  }, [detail.dokumenUrl, detail.dokumenPath, detail._filenameResolved, detail.dokumenNama]);[m
[32m+[m
[32m+[m[32m  const handleOpenDocument = async (e) => {[m
[32m+[m[32m    e.preventDefault();[m
[32m+[m[32m    try {[m
[32m+[m[32m      const resp = await fetchDocumentBlob(detail.dokumenPath || detail.dokumenUrl);[m
[32m+[m[32m      const blobUrl = URL.createObjectURL(resp.data);[m
[32m+[m[32m      window.open(blobUrl, "_blank", "noopener,noreferrer");[m
[32m+[m[32m    } catch {[m
[32m+[m[32m      if (detail.dokumenUrl) {[m
[32m+[m[32m        window.open(detail.dokumenUrl, "_blank", "noopener,noreferrer");[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[32m  };[m
 [m
[31m-  // Badge status[m
   const getStatusBadge = () => {[m
[31m-    if (status === "Menunggu Persetujuan") {[m
[32m+[m[32m    if (detail.statusLabel === "Menunggu") {[m
       return ([m
         <span[m
           className="flex items-center px-4 py-2 font-poppins font-semibold text-[16px]"[m
[31m-          style={{[m
[31m-            color: "#D69E2E",[m
[31m-            background: "#FEF5E7",[m
[31m-            borderRadius: 10,[m
[31m-            fontWeight: 600,[m
[31m-          }}[m
[32m+[m[32m          style={{ color: "#D69E2E", background: "#FEF5E7", borderRadius: 10, fontWeight: 600 }}[m
         >[m
[31m-          Menunggu Persetujuan[m
[32m+[m[32m          Menunggu[m
         </span>[m
       );[m
     }[m
[31m-    if (status === "Ditolak") {[m
[32m+[m[32m    if (detail.statusLabel === "Ditolak") {[m
       return ([m
         <span[m
           className="flex items-center px-4 py-2 font-poppins font-semibold text-[16px]"[m
[31m-          style={{[m
[31m-            color: "#FC0000",[m
[31m-            background: "#FFDEDB",[m
[31m-            borderRadius: 10,[m
[31m-            fontWeight: 600,[m
[31m-          }}[m
[32m+[m[32m          style={{ color: "#FC0000", background: "#FFDEDB", borderRadius: 10, fontWeight: 600 }}[m
         >[m
           Persetujuan Ditolak[m
         </span>[m
       );[m
     }[m
[31m-    if (status === "Disetujui") {[m
[32m+[m[32m    if (detail.statusLabel === "Disetujui") {[m
       return ([m
         <span[m
           className="flex items-center px-4 py-2 font-poppins font-semibold text-[16px]"[m
[31m-          style={{[m
[31m-            color: "#47D62E",[m
[31m-            background: "#E7FEED",[m
[31m-            borderRadius: 10,[m
[31m-            fontWeight: 600,[m
[31m-          }}[m
[32m+[m[32m          style={{ color: "#47D62E", background: "#E7FEED", borderRadius: 10, fontWeight: 600 }}[m
         >[m
           Disetujui[m
         </span>[m
       );[m
     }[m
[32m+[m[32m    return null;[m
   };[m
 [m
[31m-  // Pop up aksi[m
[31m-  const handleReject = () => {[m
[31m-    setShowReject(true);[m
[31m-    setRejectReason("");[m
[31m-  };[m
[31m-  const handleAccept = () => {[m
[31m-    setShowAccept(true);[m
[31m-    setAcceptNote("");[m
[31m-  };[m
[31m-  const submitReject = (e) => {[m
[32m+[m[32m  const handleReject = () => { setShowReject(true); setRejectReason(""); };[m
[32m+[m[32m  const handleAccept = () => { setShowAccept(true); setAcceptNote(""); };[m
[32m+[m
[32m+[m[32m  const submitReject = async (e) => {[m
     e.preventDefault();[m
[31m-    setStatus("Ditolak");[m
[31m-    setCatatan(rejectReason);[m
[31m-    setShowReject(false);[m
[31m-    localStorage.setItem(STATUS_KEY, "Ditolak");[m
[31m-    localStorage.setItem(CATATAN_KEY, rejectReason);[m
[32m+[m[32m    if (submitting) return;[m
[32m+[m
[32m+[m[32m    const prevStatus = detail.statusLabel;[m
[32m+[m[32m    const prevCatatan = detail.catatan;[m
[32m+[m
[32m+[m[32m    setSubmitting(true);[m
[32m+[m[32m    setDetail((p) => ({ ...p, statusLabel: "Ditolak", catatan: rejectReason }));[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m      await rejectVerification({ reference_number: reference, reason: rejectReason });[m
[32m+[m[32m      try {[m
[32m+[m[32m        window.dispatchEvent([m
[32m+[m[32m          new CustomEvent("app:data-dirty", {[m
[32m+[m[32m            detail: { type: "verification", action: "rejected", reference },[m
[32m+[m[32m          })[m
[32m+[m[32m        );[m
[32m+[m[32m        sessionStorage.setItem("dirty:verification", String(Date.now()));[m
[32m+[m[32m      } catch {}[m
[32m+[m[32m      setShowReject(false);[m
[32m+[m[32m    } catch (error) {[m
[32m+[m[32m      setDetail((p) => ({ ...p, statusLabel: prevStatus, catatan: prevCatatan }));[m
[32m+[m[32m      alert(error?.response?.data?.message || "Gagal menolak pengajuan.");[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      setSubmitting(false);[m
[32m+[m[32m    }[m
   };[m
[31m-  const submitAccept = (e) => {[m
[32m+[m
[32m+[m[32m  const submitAccept = async (e) => {[m
     e.preventDefault();[m
[31m-    setStatus("Disetujui");[m
[31m-    setCatatan(acceptNote);[m
[31m-    setShowAccept(false);[m
[31m-    localStorage.setItem(STATUS_KEY, "Disetujui");[m
[31m-    localStorage.setItem(CATATAN_KEY, acceptNote);[m
[32m+[m[32m    if (submitting) return;[m
[32m+[m
[32m+[m[32m    const prevStatus = detail.statusLabel;[m
[32m+[m[32m    const prevCatatan = detail.catatan;[m
[32m+[m
[32m+[m[32m    setSubmitting(true);[m
[32m+[m[32m    setDetail((p) => ({ ...p, statusLabel: "Disetujui", catatan: acceptNote }));[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m      await approveVerification({ reference_number: reference, note: acceptNote });[m
[32m+[m[32m      try {[m
[32m+[m[32m        window.dispatchEvent([m
[32m+[m[32m          new CustomEvent("app:data-dirty", {[m
[32m+[m[32m            detail: { type: "verification", action: "approved", reference },[m
[32m+[m[32m          })[m
[32m+[m[32m        );[m
[32m+[m[32m        sessionStorage.setItem("dirty:verification", String(Date.now()));[m
[32m+[m[32m        sessionStorage.setItem("dirty:cards", String(Date.now()));[m
[32m+[m[32m      } catch {}[m
[32m+[m[32m      setShowAccept(false);[m
[32m+[m[32m    } catch (error) {[m
[32m+[m[32m      setDetail((p) => ({ ...p, statusLabel: prevStatus, catatan: prevCatatan }));[m
[32m+[m[32m      alert(error?.response?.data?.message || "Gagal menyetujui pengajuan.");[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      setSubmitting(false);[m
[32m+[m[32m    }[m
   };[m
 [m
[31m-  // Aksi bawah[m
   let actionSection;[m
[31m-  if (status === "Menunggu Persetujuan") {[m
[32m+[m[32m  if (detail.statusLabel === "Menunggu") {[m
     actionSection = ([m
       <div className="flex gap-4 justify-end">[m
         <button[m
           className="px-8 py-2 text-white font-poppins font-semibold rounded-[7px]"[m
[31m-          style={{[m
[31m-            background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
[31m-            fontWeight: 600,[m
[31m-            fontSize: 16,[m
[31m-          }}[m
[32m+[m[32m          style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)", fontWeight: 600, fontSize: 16 }}[m
           onClick={() => navigate("/admin/verifikasi")}[m
         >[m
           Kembali[m
         </button>[m
         <button[m
           className="px-8 py-2 text-white font-poppins font-semibold rounded-[7px]"[m
[31m-          style={{[m
[31m-            background: "#E41D26",[m
[31m-            fontWeight: 600,[m
[31m-            fontSize: 16,[m
[31m-          }}[m
[32m+[m[32m          style={{ background: "#E41D26", fontWeight: 600, fontSize: 16 }}[m
           onClick={handleReject}[m
         >[m
           Tolak[m
         </button>[m
         <button[m
           className="px-8 py-2 text-white font-poppins font-semibold rounded-[7px]"[m
[31m-          style={{[m
[31m-            background: "#1FAF35",[m
[31m-            fontWeight: 600,[m
[31m-            fontSize: 16,[m
[31m-          }}[m
[32m+[m[32m          style={{ background: "#1FAF35", fontWeight: 600, fontSize: 16 }}[m
           onClick={handleAccept}[m
         >[m
           Setuju[m
         </button>[m
       </div>[m
     );[m
[31m-  } else if (status === "Ditolak") {[m
[32m+[m[32m  } else if (detail.statusLabel === "Ditolak") {[m
     actionSection = ([m
       <div className="flex gap-4 items-center">[m
         <div[m
           className="font-poppins font-semibold px-5 py-2 rounded-[8px]"[m
[31m-          style={{[m
[31m-            color: "#FF0004",[m
[31m-            background: "#FFDEDB",[m
[31m-            fontSize: 15,[m
[31m-            borderRadius: 8,[m
[31m-            marginRight: 10,[m
[31m-            minWidth: 0,[m
[31m-            maxWidth: 320,[m
[31m-            overflowWrap: "break-word"[m
[31m-          }}[m
[32m+[m[32m          style={{ color: "#FF0004", background: "#FFDEDB", fontSize: 15, borderRadius: 8, marginRight: 10, minWidth: 0, maxWidth: 320, overflowWrap: "break-word" }}[m
         >[m
[31m-          {catatan || "-"}[m
[32m+[m[32m          {detail.catatan || "-"}[m
         </div>[m
         <div[m
           className="font-poppins font-medium px-5 py-2 rounded-[8px]"[m
[31m-          style={{[m
[31m-            background: "#E3E3E3",[m
[31m-            color: "#242424",[m
[31m-            fontSize: 15,[m
[31m-            borderRadius: 8,[m
[31m-          }}[m
[32m+[m[32m          style={{ background: "#E3E3E3", color: "#242424", fontSize: 15, borderRadius: 8 }}[m
         >[m
[31m-          Petugas : {adminName}[m
[32m+[m[32m          Petugas : {adminNameFromLS}[m
         </div>[m
       </div>[m
     );[m
[31m-  } else if (status === "Disetujui") {[m
[32m+[m[32m  } else if (detail.statusLabel === "Disetujui") {[m
     actionSection = ([m
       <div className="flex gap-4 items-center">[m
         <div[m
           className="font-poppins font-medium px-5 py-2 rounded-[8px]"[m
[31m-          style={{[m
[31m-            background: "#E3E3E3",[m
[31m-            color: "#242424",[m
[31m-            fontSize: 15,[m
[31m-            borderRadius: 8,[m
[31m-          }}[m
[32m+[m[32m          style={{ background: "#E3E3E3", color: "#242424", fontSize: 15, borderRadius: 8 }}[m
         >[m
[31m-          Catatan : {catatan || "-"}[m
[32m+[m[32m          Catatan : {detail.catatan || "-"}[m
         </div>[m
         <div[m
           className="font-poppins font-medium px-5 py-2 rounded-[8px]"[m
[31m-          style={{[m
[31m-            background: "#E3E3E3",[m
[31m-            color: "#242424",[m
[31m-            fontSize: 15,[m
[31m-            borderRadius: 8,[m
[31m-          }}[m
[32m+[m[32m          style={{ background: "#E3E3E3", color: "#242424", fontSize: 15, borderRadius: 8 }}[m
         >[m
[31m-          Petugas : {adminName}[m
[32m+[m[32m          Petugas : {adminNameFromLS}[m
         </div>[m
       </div>[m
     );[m
[36m@@ -234,15 +421,7 @@[m [mexport default function FormDetail() {[m
           Admin Panel Kartu Visitor[m
         </div>[m
         <div className="w-full flex justify-center mb-12">[m
[31m-          <div[m
[31m-            style={{[m
[31m-              width: "100%",[m
[31m-              height: 2,[m
[31m-              background: "#C4C4C4",[m
[31m-              borderRadius: 2,[m
[31m-              margin: "0 auto",[m
[31m-            }}[m
[31m-          />[m
[32m+[m[32m          <div style={{ width: "100%", height: 2, background: "#C4C4C4", borderRadius: 2, margin: "0 auto" }} />[m
         </div>[m
         <nav className="flex flex-col gap-4 mt-2">[m
           {[[m
[36m@@ -257,9 +436,10 @@[m [mexport default function FormDetail() {[m
                 key={item.label}[m
                 onClick={() => navigate(item.path)}[m
                 className={`flex items-center gap-4 px-4 py-2 text-left transition-all hover:opacity-80[m
[31m-                  ${isActive[m
[31m-                    ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]"[m
[31m-                    : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"[m
[32m+[m[32m                  ${[m
[32m+[m[32m                    isActive[m
[32m+[m[32m                      ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]"[m
[32m+[m[32m                      : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"[m
                   } text-[17px]`}[m
                 style={isActive ? { boxShadow: "0 2px 8px rgba(90,90,140,0.07)" } : {}}[m
               >[m
[36m@@ -286,28 +466,17 @@[m [mexport default function FormDetail() {[m
           <span className="font-poppins font-semibold text-[24px] text-[#474646]">[m
             Detail Pengajuan Visitor[m
           </span>[m
[31m-          {/* Profile section */}[m
           <div className="relative ml-auto" style={{ minWidth: 200 }}>[m
[31m-            <div[m
[31m-              className="absolute top-0 left-0 w-full h-full"[m
[31m-              style={{[m
[31m-                background: "rgba(106,139,176,0.13)",[m
[31m-                borderRadius: 15,[m
[31m-                zIndex: 0,[m
[31m-              }}[m
[31m-            ></div>[m
[32m+[m[32m            <div className="absolute top-0 left-0 w-full h-full" style={{ background: "rgba(106,139,176,0.13)", borderRadius: 15, zIndex: 0 }} />[m
             <button[m
               className="relative flex items-center gap-2 px-5 py-2 cursor-pointer z-10 hover:opacity-80 transition-opacity"[m
[31m-              style={{[m
[31m-                borderRadius: 15,[m
[31m-                background: "transparent",[m
[31m-              }}[m
[32m+[m[32m              style={{ borderRadius: 15, background: "transparent" }}[m
             >[m
               <span className="w-[38px] h-[38px] rounded-full bg-[#6A8BB0] flex items-center justify-center text-white text-[24px] font-poppins font-semibold mr-2">[m
[31m-                A[m
[32m+[m[32m                {(adminNameFromLS[0] || "A").toUpperCase()}[m
               </span>[m
               <span className="font-poppins font-medium text-[18px] leading-[36px] text-[#474646]">[m
[31m-                Admin rafi[m
[32m+[m[32m                {adminNameFromLS}[m
               </span>[m
             </button>[m
           </div>[m
[36m@@ -317,211 +486,185 @@[m [mexport default function FormDetail() {[m
         <div className="w-full max-w-[900px] mx-auto">[m
           <div className="bg-white rounded-[20px] shadow-md p-8 relative">[m
             <div className="text-[15px] mb-3 font-poppins flex items-center">[m
[31m-              <span[m
[31m-                className="cursor-pointer"[m
[31m-                style={{ color: "#1E3A8A", fontWeight: 500 }}[m
[31m-                onClick={() => navigate("/admin/verifikasi")}[m
[31m-              >[m
[32m+[m[32m              <span className="cursor-pointer" style={{ color: "#1E3A8A", fontWeight: 500 }} onClick={() => navigate("/admin/verifikasi")}>[m
                 verifikasi & persetujuan[m
               </span>[m
               <span style={{ color: "#8C8C8C", marginLeft: 4 }}>[m
                 {">"} <span>Detail Pengajuan</span>[m
               </span>[m
             </div>[m
[31m-            {/* Nama dan Status */}[m
[31m-            <div className="flex items-center justify-between mb-2">[m
[31m-              <span[m
[31m-                className="font-poppins font-semibold text-[22px]"[m
[31m-                style={{ color: "#242424", letterSpacing: "0.01em" }}[m
[32m+[m
[32m+[m[32m            {err && ([m
[32m+[m[32m              <div[m
[32m+[m[32m                className="mb-3 font-poppins"[m
[32m+[m[32m                style={{ background: "#FFDEDB", color: "#B42318", border: "1px solid #FEE4E2", borderRadius: 10, padding: "10px 12px" }}[m
               >[m
[31m-                {initialData.nama}[m
[32m+[m[32m                {err}[m
[32m+[m[32m              </div>[m
[32m+[m[32m            )}[m
[32m+[m
[32m+[m[32m            <div className="flex items-center justify-between mb-2">[m
[32m+[m[32m              <span className="font-poppins font-semibold text-[22px]" style={{ color: "#242424", letterSpacing: "0.01em" }}>[m
[32m+[m[32m                {loading ? "Memuat..." : detail.nama}[m
               </span>[m
               {getStatusBadge()}[m
             </div>[m
[31m-            {/* Garis bawah */}[m
[31m-            <div[m
[31m-              style={{[m
[31m-                width: "100%",[m
[31m-                height: 2,[m
[31m-                background: "#E3E3E3",[m
[31m-                borderRadius: 2,[m
[31m-                margin: "8px 0 18px 0",[m
[31m-              }}[m
[31m-            />[m
[31m-[m
[31m-            {/* Isi Detail 2 kolom */}[m
[32m+[m
[32m+[m[32m            <div style={{ width: "100%", height: 2, background: "#E3E3E3", borderRadius: 2, margin: "8px 0 18px 0" }} />[m
[32m+[m
             <div className="flex flex-wrap gap-y-5 mb-5">[m
[31m-              {/* Kolom kiri */}[m
               <div className="w-full md:w-1/2 pr-0 md:pr-5 flex flex-col gap-y-4">[m
[31m-                <DetailCol label="Nama Pemohon" value={initialData.nama} />[m
[31m-                <DetailCol label="Nomor KTP" value={initialData.noKtp} />[m
[31m-                <DetailCol label="Email" value={initialData.email} />[m
[31m-                <DetailCol label="Tanggal Kunjungan" value={initialData.tanggal} />[m
[32m+[m[32m                <DetailCol label="Nama Pemohon" value={detail.nama} />[m
[32m+[m[32m                <DetailCol label="Nomor KTP" value={detail.noKtp} />[m
[32m+[m[32m                <DetailCol label="Email" value={detail.email} />[m
[32m+[m[32m                <DetailCol label="Tanggal Kunjungan" value={detail.tanggal} />[m
                 <DetailCol[m
                   label="Dokumen Pendukung"[m
                   value={[m
[31m-                    <a[m
[31m-                      href={"/dummy_files/" + initialData.dokumen}[m
[31m-                      target="_blank"[m
[31m-                      rel="noopener noreferrer"[m
[31m-                      style={{[m
[31m-                        color: "#1E3A8A",[m
[31m-                        textDecoration: "underline",[m
[31m-                        fontWeight: 600,[m
[31m-                        marginLeft: "auto",[m
[31m-                      }}[m
[31m-                    >[m
[31m-                      Lihat[m
[31m-                    </a>[m
[32m+[m[32m                    detail.dokumenUrl ? ([m
[32m+[m[32m                      <a[m
[32m+[m[32m                        href={detail.dokumenUrl}[m
[32m+[m[32m                        target="_blank"[m
[32m+[m[32m                        rel="noopener noreferrer"[m
[32m+[m[32m                        onClick={handleOpenDocument}[m
[32m+[m[32m                        style={{ color: "#1E3A8A", textDecoration: "underline", fontWeight: 600, marginLeft: "auto" }}[m
[32m+[m[32m                      >[m
[32m+[m[32m                        Lihat[m
[32m+[m[32m                      </a>[m
[32m+[m[32m                    ) : ([m
[32m+[m[32m                      "-"[m
[32m+[m[32m                    )[m
                   }[m
[31m-                  fileName={initialData.dokumen}[m
[32m+[m[32m                  fileName={detail.dokumenNama}[m
[32m+[m[32m                  fileUrl={detail.dokumenUrl}[m
                 />[m
               </div>[m
[31m-              {/* Kolom kanan */}[m
[32m+[m
               <div className="w-full md:w-1/2 flex flex-col gap-y-4">[m
[31m-                <DetailCol label="Instansi/Perusahaan" value={initialData.instansi} />[m
[31m-                <DetailCol label="Nomor Handphone" value={initialData.handphone} />[m
[31m-                <DetailCol label="Stasiun Tujuan" value={initialData.stasiun} />[m
[31m-                <DetailCol label="Selesai Kunjungan" value={initialData.selesaiKunjungan} />[m
[31m-                <DetailCol label="Nomor Pengajuan" value={initialData.noPengajuan} />[m
[32m+[m[32m                <DetailCol label="Instansi/Perusahaan" value={detail.instansi} />[m
[32m+[m[32m                <DetailCol label="Nomor Handphone" value={detail.handphone} />[m
[32m+[m[32m                <DetailCol label="Stasiun Tujuan" value={detail.stasiun} />[m
[32m+[m[32m                <DetailCol label="Selesai Kunjungan" value={detail.selesaiKunjungan} />[m
[32m+[m[32m                <DetailCol label="Nomor Pengajuan" value={detail.noPengajuan} />[m
               </div>[m
             </div>[m
[31m-            {/* Tujuan Kunjungan satu baris, full lebar */}[m
[32m+[m
             <div>[m
[31m-              <DetailCol[m
[31m-                label="Tujuan Kunjungan"[m
[31m-                value={initialData.tujuan}[m
[31m-                fullWidth[m
[31m-              />[m
[32m+[m[32m              <DetailCol label="Tujuan Kunjungan" value={detail.tujuan} fullWidth />[m
             </div>[m
 [m
[31m-            {/* Garis bawah kedua */}[m
[31m-            <div[m
[31m-              style={{[m
[31m-                width: "100%",[m
[31m-                height: 2,[m
[31m-                background: "#E3E3E3",[m
[31m-                borderRadius: 2,[m
[31m-                margin: "18px 0 15px 0",[m
[31m-              }}[m
[31m-            />[m
[32m+[m[32m            <div style={{ width: "100%", height: 2, background: "#E3E3E3", borderRadius: 2, margin: "18px 0 15px 0" }} />[m
 [m
             {actionSection}[m
 [m
[31m-            {/* Popup Tolak */}[m
[31m-            {showReject && ([m
[31m-              <div className="fixed inset-0 bg-[rgba(0,0,0,0.15)] flex items-center justify-center z-[60]">[m
[31m-                <form[m
[31m-                  className="bg-white p-10 rounded-[20px] shadow-lg min-w-[400px] w-[99%] max-w-[500px] relative"[m
[31m-                  onSubmit={submitReject}[m
[31m-                >[m
[31m-                  <div className="flex flex-col items-center mb-7">[m
[31m-                    <Icon icon="ic:round-cancel" color="#E41D26" width={56} height={56} />[m
[31m-                    <span className="font-poppins font-bold" style={{ color: "#E41D26", fontSize: 28, marginTop: 16 }}>[m
[31m-                      Konfirmasi Penolakan[m
[31m-                    </span>[m
[31m-                  </div>[m
[31m-                  <div className="mb-2 font-poppins font-medium text-[#474646]">[m
[31m-                    Nama Petugas Penolak[m
[31m-                    <input[m
[31m-                      type="text"[m
[31m-                      value={adminName}[m
[31m-                      readOnly[m
[31m-                      className="mt-1 block w-full rounded-md bg-[#E3E3E3] px-3 py-2 font-poppins"[m
[31m-                      style={{ color: "#4F4D4D", fontWeight: 500, border: "none" }}[m
[31m-                    />[m
[31m-                  </div>[m
[31m-                  <div className="mb-5 font-poppins font-medium text-[#474646]">[m
[31m-                    Alasan Penolakan[m
[31m-                    <textarea[m
[31m-                      value={rejectReason}[m
[31m-                      onChange={e => setRejectReason(e.target.value)}[m
[31m-                      rows={3}[m
[31m-                      placeholder="Masukkan alasan penolakan..."[m
[31m-                      required[m
[31m-                      className="mt-1 block w-full rounded-md bg-[#E3E3E3] px-3 py-2 font-poppins"[m
[31m-                      style={{ color: "#4F4D4D", fontWeight: 500, border: "none", resize: "vertical" }}[m
[31m-                    />[m
[31m-                  </div>[m
[31m-                  <div className="flex gap-3 justify-end">[m
[31m-                    <button[m
[31m-                      type="button"[m
[31m-                      className="px-4 py-2 rounded font-poppins font-semibold"[m
[31m-                      style={{ background: "#E3E3E3", color: "#474646" }}[m
[31m-                      onClick={() => setShowReject(false)}[m
[31m-                    >[m
[31m-                      Batal[m
[31m-                    </button>[m
[31m-                    <button[m
[31m-                      type="submit"[m
[31m-                      className="px-4 py-2 rounded bg-[#E41D26] text-white font-poppins font-semibold"[m
[31m-                    >[m
[31m-                      Tolak[m
[31m-                    </button>[m
[31m-                  </div>[m
[31m-                </form>[m
[31m-              </div>[m
[31m-            )}[m
[32m+[m[32m            {/* Popup Tolak â€” kecil, tanpa tombol X */}[m
[32m+[m[32m            <SmallModal[m
[32m+[m[32m              open={showReject}[m
[32m+[m[32m              onClose={() => setShowReject(false)}[m
[32m+[m[32m              title="Konfirmasi Penolakan"[m
[32m+[m[32m              icon="ic:round-cancel"[m
[32m+[m[32m              iconColor="#fff"[m
[32m+[m[32m            >[m
[32m+[m[32m              <form onSubmit={submitReject}>[m
[32m+[m[32m                <div className="mb-3 font-poppins font-medium text-[#474646]">[m
[32m+[m[32m                  Nama Petugas Penolak[m
[32m+[m[32m                  <input[m
[32m+[m[32m                    type="text"[m
[32m+[m[32m                    value={adminNameFromLS}[m
[32m+[m[32m                    readOnly[m
[32m+[m[32m                    className="mt-1 block w-full rounded-[10px] bg-[#E3E3E3] px-3 py-2 font-poppins"[m
[32m+[m[32m                    style={{ color: "#4F4D4D", fontWeight: 500, border: "none" }}[m
[32m+[m[32m                  />[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div className="mb-5 font-poppins font-medium text-[#474646]">[m
[32m+[m[32m                  Alasan Penolakan[m
[32m+[m[32m                  <textarea[m
[32m+[m[32m                    value={rejectReason}[m
[32m+[m[32m                    onChange={(e) => setRejectReason(e.target.value)}[m
[32m+[m[32m                    rows={3}[m
[32m+[m[32m                    placeholder="Masukkan alasan penolakan..."[m
[32m+[m[32m                    required[m
[32m+[m[32m                    className="mt-1 block w-full rounded-[10px] bg-[#E3E3E3] px-3 py-2 font-poppins"[m
[32m+[m[32m                    style={{ color: "#4F4D4D", fontWeight: 500, border: "none", resize: "vertical" }}[m
[32m+[m[32m                  />[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div className="flex gap-3 justify-end">[m
[32m+[m[32m                  <button[m
[32m+[m[32m                    type="button"[m
[32m+[m[32m                    className="px-4 py-2 rounded-[8px] font-poppins font-semibold"[m
[32m+[m[32m                    style={{ background: "#E3E3E3", color: "#474646" }}[m
[32m+[m[32m                    onClick={() => setShowReject(false)}[m
[32m+[m[32m                    disabled={submitting}[m
[32m+[m[32m                  >[m
[32m+[m[32m                    Batal[m
[32m+[m[32m                  </button>[m
[32m+[m[32m                  <button[m
[32m+[m[32m                    type="submit"[m
[32m+[m[32m                    className="px-4 py-2 rounded-[8px] bg-[#E41D26] text-white font-poppins font-semibold"[m
[32m+[m[32m                    disabled={submitting}[m
[32m+[m[32m                  >[m
[32m+[m[32m                    {submitting ? "Memproses..." : "Tolak"}[m
[32m+[m[32m                  </button>[m
[32m+[m[32m                </div>[m
[32m+[m[32m              </form>[m
[32m+[m[32m            </SmallModal>[m
 [m
[31m-            {/* Popup Setuju */}[m
[31m-            {showAccept && ([m
[31m-              <div className="fixed inset-0 bg-[rgba(0,0,0,0.15)] flex items-center justify-center z-[60]">[m
[31m-                <form[m
[31m-                  className="bg-white p-10 rounded-[20px] shadow-lg min-w-[400px] w-[99%] max-w-[500px] relative"[m
[31m-                  onSubmit={submitAccept}[m
[31m-                >[m
[31m-                  <div className="flex flex-col items-center mb-7">[m
[31m-                    <Icon icon="icon-park-twotone:check-one" color="#1FAF35" width={56} height={56} />[m
[31m-                    <span className="font-poppins font-bold" style={{ color: "#1FAF35", fontSize: 28, marginTop: 16 }}>[m
[31m-                      Konfirmasi Persetujuan[m
[31m-                    </span>[m
[31m-                  </div>[m
[31m-                  <div className="mb-2 font-poppins font-medium text-[#474646]">[m
[31m-                    Nama Petugas[m
[31m-                    <input[m
[31m-                      type="text"[m
[31m-                      value={adminName}[m
[31m-                      readOnly[m
[31m-                      className="mt-1 block w-full rounded-md bg-[#E3E3E3] px-3 py-2 font-poppins"[m
[31m-                      style={{ color: "#4F4D4D", fontWeight: 500, border: "none" }}[m
[31m-                    />[m
[31m-                  </div>[m
[31m-                  <div className="mb-5 font-poppins font-medium text-[#474646]">[m
[31m-                    Catatan Persetujuan[m
[31m-                    <textarea[m
[31m-                      value={acceptNote}[m
[31m-                      onChange={e => setAcceptNote(e.target.value)}[m
[31m-                      rows={3}[m
[31m-                      placeholder="Masukkan catatan tambahan seperti membawa KTP asli"[m
[31m-                      required[m
[31m-                      className="mt-1 block w-full rounded-md bg-[#E3E3E3] px-3 py-2 font-poppins"[m
[31m-                      style={{ color: "#4F4D4D", fontWeight: 500, border: "none", resize: "vertical" }}[m
[31m-                    />[m
[31m-                  </div>[m
[31m-                  <div className="flex gap-3 justify-end">[m
[31m-                    <button[m
[31m-                      type="button"[m
[31m-                      className="px-4 py-2 rounded font-poppins font-semibold"[m
[31m-                      style={{ background: "#E3E3E3", color: "#474646" }}[m
[31m-                      onClick={() => setShowAccept(false)}[m
[31m-                    >[m
[31m-                      Batal[m
[31m-                    </button>[m
[31m-                    <button[m
[31m-                      type="submit"[m
[31m-                      className="px-4 py-2 rounded bg-[#1FAF35] text-white font-poppins font-semibold"[m
[31m-                    >[m
[31m-                      Setuju[m
[31m-                    </button>[m
[31m-                  </div>[m
[31m-                </form>[m
[31m-              </div>[m
[31m-            )}[m
[32m+[m[32m            {/* Popup Setuju â€” kecil, tanpa tombol X */}[m
[32m+[m[32m            <SmallModal[m
[32m+[m[32m              open={showAccept}[m
[32m+[m[32m              onClose={() => setShowAccept(false)}[m
[32m+[m[32m              title="Konfirmasi Persetujuan"[m
[32m+[m[32m              icon="icon-park-twotone:check-one"[m
[32m+[m[32m              iconColor="#fff"[m
[32m+[m[32m            >[m
[32m+[m[32m              <form onSubmit={submitAccept}>[m
[32m+[m[32m                <div className="mb-3 font-poppins font-medium text-[#474646]">[m
[32m+[m[32m                  Nama Petugas[m
[32m+[m[32m                  <input[m
[32m+[m[32m                    type="text"[m
[32m+[m[32m                    value={adminNameFromLS}[m
[32m+[m[32m                    readOnly[m
[32m+[m[32m                    className="mt-1 block w-full rounded-[10px] bg-[#E3E3E3] px-3 py-2 font-poppins"[m
[32m+[m[32m                    style={{ color: "#4F4D4D", fontWeight: 500, border: "none" }}[m
[32m+[m[32m                  />[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div className="mb-5 font-poppins font-medium text-[#474646]">[m
[32m+[m[32m                  Catatan Persetujuan[m
[32m+[m[32m                  <textarea[m
[32m+[m[32m                    value={acceptNote}[m
[32m+[m[32m                    onChange={(e) => setAcceptNote(e.target.value)}[m
[32m+[m[32m                    rows={3}[m
[32m+[m[32m                    placeholder="Masukkan catatan tambahan seperti membawa KTP asli"[m
[32m+[m[32m                    required[m
[32m+[m[32m                    className="mt-1 block w-full rounded-[10px] bg-[#E3E3E3] px-3 py-2 font-poppins"[m
[32m+[m[32m                    style={{ color: "#4F4D4D", fontWeight: 500, border: "none", resize: "vertical" }}[m
[32m+[m[32m                  />[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div className="flex gap-3 justify-end">[m
[32m+[m[32m                  <button[m
[32m+[m[32m                    type="button"[m
[32m+[m[32m                    className="px-4 py-2 rounded-[8px] font-poppins font-semibold"[m
[32m+[m[32m                    style={{ background: "#E3E3E3", color: "#474646" }}[m
[32m+[m[32m                    onClick={() => setShowAccept(false)}[m
[32m+[m[32m                    disabled={submitting}[m
[32m+[m[32m                  >[m
[32m+[m[32m                    Batal[m
[32m+[m[32m                  </button>[m
[32m+[m[32m                  <button[m
[32m+[m[32m                    type="submit"[m
[32m+[m[32m                    className="px-4 py-2 rounded-[8px] text-white font-poppins font-semibold"[m
[32m+[m[32m                    style={{ background: "#1FAF35" }}[m
[32m+[m[32m                    disabled={submitting}[m
[32m+[m[32m                  >[m
[32m+[m[32m                    {submitting ? "Memproses..." : "Setuju"}[m
[32m+[m[32m                  </button>[m
[32m+[m[32m                </div>[m
[32m+[m[32m              </form>[m
[32m+[m[32m            </SmallModal>[m
           </div>[m
         </div>[m
       </main>[m
 [m
[31m-      {/* Custom CSS untuk font dan responsive */}[m
       <style>{`[m
         @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');[m
         .font-poppins { font-family: 'Poppins', sans-serif; }[m
[36m@@ -536,15 +679,14 @@[m [mexport default function FormDetail() {[m
   );[m
 }[m
 [m
[31m-// Komponen detail satu baris[m
[31m-function DetailCol({ label, value, fullWidth, fileName }) {[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * DetailCol[m
[32m+[m[32m * ========================= */[m
[32m+[m[32mfunction DetailCol({ label, value, fullWidth, fileName, fileUrl }) {[m
   if (label === "Dokumen Pendukung" && fileName) {[m
     return ([m
       <div className={fullWidth ? "w-full mb-2" : "mb-2"}>[m
[31m-        <div[m
[31m-          className="font-poppins font-medium text-[15px] mb-1"[m
[31m-          style={{ color: "#242424", fontWeight: 500 }}[m
[31m-        >[m
[32m+[m[32m        <div className="font-poppins font-medium text-[15px] mb-1" style={{ color: "#242424", fontWeight: 500 }}>[m
           {label}[m
         </div>[m
         <div[m
[36m@@ -559,31 +701,28 @@[m [mfunction DetailCol({ label, value, fullWidth, fileName }) {[m
             overflow: "hidden",[m
             textOverflow: "ellipsis",[m
           }}[m
[32m+[m[32m          title={fileName}[m
         >[m
[31m-          <span className="mr-2">{fileName}</span>[m
[31m-          <a[m
[31m-            href={"/dummy_files/" + fileName}[m
[31m-            target="_blank"[m
[31m-            rel="noopener noreferrer"[m
[31m-            style={{[m
[31m-              color: "#1E3A8A",[m
[31m-              textDecoration: "underline",[m
[31m-              fontWeight: 600,[m
[31m-              marginLeft: "auto",[m
[31m-            }}[m
[31m-          >[m
[31m-            Lihat[m
[31m-          </a>[m
[32m+[m[32m          <span className="mr-2 truncate">{fileName}</span>[m
[32m+[m[32m          {fileUrl ? ([m
[32m+[m[32m            <a[m
[32m+[m[32m              href={fileUrl}[m
[32m+[m[32m              target="_blank"[m
[32m+[m[32m              rel="noopener noreferrer"[m
[32m+[m[32m              style={{ color: "#1E3A8A", textDecoration: "underline", fontWeight: 600, marginLeft: "auto" }}[m
[32m+[m[32m            >[m
[32m+[m[32m              Lihat[m
[32m+[m[32m            </a>[m
[32m+[m[32m          ) : ([m
[32m+[m[32m            <span style={{ marginLeft: "auto", color: "#777" }}>-</span>[m
[32m+[m[32m          )}[m
         </div>[m
       </div>[m
     );[m
   }[m
   return ([m
     <div className={fullWidth ? "w-full mb-2" : "mb-2"}>[m
[31m-      <div[m
[31m-        className="font-poppins font-medium text-[15px] mb-1"[m
[31m-        style={{ color: "#242424", fontWeight: 500 }}[m
[31m-      >[m
[32m+[m[32m      <div className="font-poppins font-medium text-[15px] mb-1" style={{ color: "#242424", fontWeight: 500 }}>[m
         {label}[m
       </div>[m
       <div[m
[36m@@ -598,9 +737,10 @@[m [mfunction DetailCol({ label, value, fullWidth, fileName }) {[m
           overflow: "hidden",[m
           textOverflow: "ellipsis",[m
         }}[m
[32m+[m[32m        title={typeof value === "string" ? value : undefined}[m
       >[m
[31m-        {value}[m
[32m+[m[32m        {value || "-"}[m
       </div>[m
     </div>[m
   );[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
[1mdiff --git a/src/admin/KartuVisitor.jsx b/src/admin/KartuVisitor.jsx[m
[1mindex e9dbeb7..5001e53 100644[m
[1m--- a/src/admin/KartuVisitor.jsx[m
[1m+++ b/src/admin/KartuVisitor.jsx[m
[36m@@ -1,151 +1,283 @@[m
[31m-// /mnt/data/KartuVisitor.jsx[m
[31m-import React, { useState } from "react";[m
[32m+[m[32m// src/admin/KartuVisitor.jsx[m
[32m+[m[32mimport React, { useState, useEffect, useRef } from "react";[m
 import { Icon } from "@iconify/react";[m
[32m+[m[32mimport { useNavigate } from "react-router-dom";[m
 import kaiLogo from "../assets/KAI-logo.png";[m
 [m
[31m-// Ganti cara ambil nama petugas sesuai sistem login aplikasi kamu[m
[31m-const namaPetugas = localStorage.getItem("namaPetugas") || "Admin rafi";[m
[31m-[m
[31m-// Data dummy untuk tabel visitor[m
[31m-const initialDummyData = [[m
[31m-  {[m
[31m-    nama: "Azida Kautsar",[m
[31m-    instansi: "Politeknik Elektronika Negeri Surabaya",[m
[31m-    nomorPengajuan: "VST-2025-12345677",[m
[31m-    kunjungan: "Observasi magang",[m
[31m-    email: "azida@gmail.com",[m
[31m-    tanggalPinjam: "2025-08-04",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Baik",[m
[31m-    statusKartu: "Tidak Aktif",[m
[31m-    aksi: "Belum diambil",[m
[31m-    petugasSerah: "",[m
[31m-    alasan: "",[m
[31m-    penanganan: "",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Milano Sitanggang",[m
[31m-    instansi: "CV. Digital Media",[m
[31m-    nomorPengajuan: "VST-2025-1234567",[m
[31m-    kunjungan: "Presentasi proposal vendor",[m
[31m-    email: "milanos@digimedia.com",[m
[31m-    tanggalPinjam: "2025-08-05",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Hilang",[m
[31m-    statusKartu: "Aktif",[m
[31m-    aksi: "Serahkan Kartu",[m
[31m-    petugasSerah: "Rafi",[m
[31m-    alasan: "Kartu hilang saat di perjalanan.",[m
[31m-    penanganan: "Sudah dibuatkan surat kehilangan.",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Azka Mauladina",[m
[31m-    instansi: "PT. Bina Karya",[m
[31m-    nomorPengajuan: "VST-2025-1234588",[m
[31m-    kunjungan: "Magang Observasi",[m
[31m-    email: "azka@binakarya.com",[m
[31m-    tanggalPinjam: "2025-08-03",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Hilang",[m
[31m-    statusKartu: "Tidak Aktif",[m
[31m-    aksi: "Belum diambil",[m
[31m-    petugasSerah: "",[m
[31m-    alasan: "Kartu tidak ditemukan setelah kunjungan.",[m
[31m-    penanganan: "Petugas sudah membuat laporan.",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Yudhita Meika",[m
[31m-    instansi: "PT. Telkom Indonesia",[m
[31m-    nomorPengajuan: "VST-2025-2234567",[m
[31m-    kunjungan: "Inspeksi jaringan",[m
[31m-    email: "yudhita@telkom.co.id",[m
[31m-    tanggalPinjam: "2025-08-06",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Rusak",[m
[31m-    statusKartu: "Tidak Aktif",[m
[31m-    aksi: "Belum diambil",[m
[31m-    petugasSerah: "",[m
[31m-    alasan: "Kartu rusak terlipat & patah.",[m
[31m-    penanganan: "Kartu diganti baru.",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Ahmad Arfan",[m
[31m-    instansi: "PT. Kereta Media",[m
[31m-    nomorPengajuan: "VST-2025-3234567",[m
[31m-    kunjungan: "Liputan media",[m
[31m-    email: "ahmad@keretamedia.com",[m
[31m-    tanggalPinjam: "2025-08-07",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Baik",[m
[31m-    statusKartu: "Aktif",[m
[31m-    aksi: "Serahkan Kartu",[m
[31m-    petugasSerah: "Rafi",[m
[31m-    alasan: "",[m
[31m-    penanganan: "",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Gading Subagio",[m
[31m-    instansi: "PT. Sukses Sentosa",[m
[31m-    nomorPengajuan: "VST-2025-4234567",[m
[31m-    kunjungan: "Kontrol vendor",[m
[31m-    email: "gading@sentosa.com",[m
[31m-    tanggalPinjam: "2025-08-08",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Baik",[m
[31m-    statusKartu: "Aktif",[m
[31m-    aksi: "Belum diambil",[m
[31m-    petugasSerah: "",[m
[31m-    alasan: "",[m
[31m-    penanganan: "",[m
[31m-  },[m
[31m-];[m
[31m-[m
[31m-// Helper untuk cek status aktif/tidak aktif otomatis berdasarkan tanggal kembali[m
[31m-function getStatusKartu(tanggalKembali) {[m
[32m+[m[32mimport {[m
[32m+[m[32m  getApprovedCards,[m
[32m+[m[32m  getActiveCards,[m
[32m+[m[32m  issueCard,[m
[32m+[m[32m  returnCard,[m
[32m+[m[32m  editCardCondition,[m
[32m+[m[32m  exportDailyFlow,[m
[32m+[m[32m  downloadBlob,[m
[32m+[m[32m  adminLogout,[m
[32m+[m[32m} from "../api";[m
[32m+[m
[32m+[m[32mconst namaPetugas =[m
[32m+[m[32m  localStorage.getItem("namaPetugas") ||[m
[32m+[m[32m  localStorage.getItem("adminName") ||[m
[32m+[m[32m  "Admin";[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * Sinkron antar-tab[m
[32m+[m[32m * ========================= */[m
[32m+[m[32mfunction notifyDirtyCards() {[m
[32m+[m[32m  try {[m
[32m+[m[32m    localStorage.setItem("dirty:cards", String(Date.now()));[m
[32m+[m[32m  } catch (_) {}[m
[32m+[m[32m  try {[m
[32m+[m[32m    if (typeof BroadcastChannel !== "undefined") {[m
[32m+[m[32m      const ch = new BroadcastChannel("cards-channel");[m
[32m+[m[32m      ch.postMessage({ type: "dirty:cards", at: Date.now() });[m
[32m+[m[32m      ch.close();[m
[32m+[m[32m    }[m
[32m+[m[32m  } catch (_) {}[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * PATCH untuk Riwayat (override kondisi di FE)[m
[32m+[m[32m * ========================= */[m
[32m+[m[32mconst PATCH_KEY = "riwayat:patches";[m
[32m+[m
[32m+[m[32mfunction saveRiwayatPatch(reference, kondisi) {[m
[32m+[m[32m  if (!reference || !kondisi) return;[m
[32m+[m[32m  try {[m
[32m+[m[32m    const raw = localStorage.getItem(PATCH_KEY);[m
[32m+[m[32m    const map = raw ? JSON.parse(raw) : {};[m
[32m+[m[32m    map[String(reference)] = kondisi; // simpan berdasarkan nomor pengajuan/reference[m
[32m+[m[32m    localStorage.setItem(PATCH_KEY, JSON.stringify(map));[m
[32m+[m[32m  } catch {}[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction broadcastRiwayatPatch(reference, kondisi) {[m
[32m+[m[32m  try {[m
[32m+[m[32m    window.dispatchEvent([m
[32m+[m[32m      new CustomEvent("riwayat:patch", { detail: { reference, kondisi, at: Date.now() } })[m
[32m+[m[32m    );[m
[32m+[m[32m  } catch {}[m
[32m+[m[32m  try {[m
[32m+[m[32m    if (typeof BroadcastChannel !== "undefined") {[m
[32m+[m[32m      const ch = new BroadcastChannel("riwayat-channel");[m
[32m+[m[32m      ch.postMessage({ type: "patch", reference, kondisi, at: Date.now() });[m
[32m+[m[32m      ch.close();[m
[32m+[m[32m    }[m
[32m+[m[32m  } catch {}[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * ID MAP (per reference) untuk visitor_card_id & transaction_id[m
[32m+[m[32m * ========================= */[m
[32m+[m[32mconst IDMAP_KEY = "cards:lastIssuedIDs";[m
[32m+[m[32mfunction loadIdMap() {[m
[32m+[m[32m  try { return JSON.parse(localStorage.getItem(IDMAP_KEY) || "{}"); } catch { return {}; }[m
[32m+[m[32m}[m
[32m+[m[32mfunction saveIdMap(map) {[m
[32m+[m[32m  localStorage.setItem(IDMAP_KEY, JSON.stringify(map));[m
[32m+[m[32m}[m
[32m+[m[32mfunction setIdsForReference(reference, ids) {[m
[32m+[m[32m  if (!reference) return;[m
[32m+[m[32m  const map = loadIdMap();[m
[32m+[m[32m  map[String(reference)] = {[m
[32m+[m[32m    visitor_card_id: ids?.visitor_card_id || ids?.visitorCardId || null,[m
[32m+[m[32m    transaction_id: ids?.transaction_id || ids?.card_transaction_id || ids?.transactionId || null,[m
[32m+[m[32m  };[m
[32m+[m[32m  saveIdMap(map);[m
[32m+[m[32m}[m
[32m+[m[32mfunction getIdsForReference(reference) {[m
[32m+[m[32m  const map = loadIdMap();[m
[32m+[m[32m  return reference ? map[String(reference)] || {} : {};[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * Normalisasi & Pemetaan[m
[32m+[m[32m * ========================= */[m
[32m+[m[32mfunction normalizeConditionLabel(s) {[m
[32m+[m[32m  const v = (s || "").toString().trim().toLowerCase();[m
[32m+[m[32m  if (["rusak", "damage", "damaged", "broken"].includes(v)) return "Rusak";[m
[32m+[m[32m  if (["hilang", "lost", "missing"].includes(v)) return "Hilang";[m
[32m+[m[32m  return "Baik";[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction getStatusKartu(tanggalKembali, opts = {}) {[m
   const today = new Date();[m
[31m-  const kembali = new Date(tanggalKembali);[m
[32m+[m[32m  const kembali = tanggalKembali ? new Date(tanggalKembali) : null;[m
[32m+[m[32m  if (opts?.aksi === "Belum diambil") return "Belum diambil";[m
[32m+[m[32m  if (opts?.isActive === false && kembali && kembali >= today) return "Belum diambil";[m
[32m+[m[32m  if (!kembali || isNaN(kembali)) return opts?.isActive ? "Aktif" : "Tidak Aktif";[m
   return kembali < today ? "Tidak Aktif" : "Aktif";[m
 }[m
 [m
[31m-// Helper warna status[m
 const statusColor = {[m
   Aktif: "#25BF23",[m
   "Tidak Aktif": "#E53A3D",[m
[32m+[m[32m  "Belum diambil": "#6C757D",[m
 };[m
 [m
[31m-// Helper warna kondisi kartu[m
 const kondisiColor = {[m
   Baik: "#28A745",[m
   Hilang: "#DC3545",[m
   Rusak: "#FFC107",[m
 };[m
 [m
[31m-// Helper warna aksi[m
 const aksiColor = {[m
   "Terima Kartu": "#007BFF",[m
   "Serahkan Kartu": "#ED8126",[m
   "Belum diambil": "#6C757D",[m
 };[m
 [m
[31m-/** ===========================[m
[31m- *   POPUP UTAMA (Header sesuai desain)[m
[31m- *  =========================== */[m
[32m+[m[32m// UI -> API[m
[32m+[m[32mfunction mapConditionToAPI(k) {[m
[32m+[m[32m  const v = (k || "").toString().toLowerCase();[m
[32m+[m[32m  if (v.includes("hilang")) return "lost";[m
[32m+[m[32m  if (v.includes("rusak")) return "damaged";[m
[32m+[m[32m  return "good";[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// API -> UI[m
[32m+[m[32mfunction mapApiConditionToLabel(raw) {[m
[32m+[m[32m  const v = (raw ?? "").toString().trim().toLowerCase();[m
[32m+[m[32m  if (!v) return undefined;[m
[32m+[m[32m  if (["good", "baik", "ok", "normal"].includes(v)) return "Baik";[m
[32m+[m[32m  if (["damaged", "rusak", "broken"].includes(v)) return "Rusak";[m
[32m+[m[32m  if (["lost", "hilang", "missing"].includes(v)) return "Hilang";[m
[32m+[m[32m  return undefined;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// Ambil visitor_card_id dari berbagai kemungkinan field[m
[32m+[m[32mfunction findVisitorCardId(x) {[m
[32m+[m[32m  return ([m
[32m+[m[32m    x?.visitorCardId ||[m
[32m+[m[32m    x?.visitor_card_id ||[m
[32m+[m[32m    x?.card_id ||[m
[32m+[m[32m    x?.visitor_card?.id ||[m
[32m+[m[32m    x?.card?.id ||[m
[32m+[m[32m    x?.card?.card_id ||[m
[32m+[m[32m    null[m
[32m+[m[32m  );[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * Meta Cache (persist kondisi/alasan/penanganan)[m
[32m+[m[32m * ========================= */[m
[32m+[m[32mconst META_CACHE_KEY = "visitorCardMetaCache";[m
[32m+[m
[32m+[m[32mfunction loadMetaCache() {[m
[32m+[m[32m  try {[m
[32m+[m[32m    return JSON.parse(localStorage.getItem(META_CACHE_KEY) || "{}");[m
[32m+[m[32m  } catch {[m
[32m+[m[32m    return {};[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m[32mfunction saveMetaCache(cache) {[m
[32m+[m[32m  localStorage.setItem(META_CACHE_KEY, JSON.stringify(cache));[m
[32m+[m[32m}[m
[32m+[m[32mfunction keyForRow(r) {[m
[32m+[m[32m  return String([m
[32m+[m[32m    r?.referenceNumber || r?.nomorPengajuan || r?.transactionId || r?.visitorCardId || r?.id || ""[m
[32m+[m[32m  );[m
[32m+[m[32m}[m
[32m+[m[32mfunction applyMetaCache(list) {[m
[32m+[m[32m  const cache = loadMetaCache();[m
[32m+[m[32m  return list.map((r) => {[m
[32m+[m[32m    const k = keyForRow(r);[m
[32m+[m[32m    const cached = k ? cache[k] : null;[m
[32m+[m[32m    if (!cached) return r;[m
[32m+[m
[32m+[m[32m    const apiK = (r.kondisi || "").toLowerCase();[m
[32m+[m[32m    const shouldUseCachedKondisi = !apiK || apiK === "baik";[m
[32m+[m
[32m+[m[32m    const alasan = r.alasan || (cached.alasan ?? "");[m
[32m+[m[32m    const penanganan = r.penanganan || (cached.penanganan ?? "");[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m      ...r,[m
[32m+[m[32m      kondisi: shouldUseCachedKondisi ? (cached.kondisi || r.kondisi) : r.kondisi,[m
[32m+[m[32m      alasan,[m
[32m+[m[32m      penanganan,[m
[32m+[m[32m    };[m
[32m+[m[32m  });[m
[32m+[m[32m}[m
[32m+[m[32mfunction cacheMeta(rowOrKey, meta) {[m
[32m+[m[32m  const cache = loadMetaCache();[m
[32m+[m[32m  const k = typeof rowOrKey === "string" ? rowOrKey : keyForRow(rowOrKey);[m
[32m+[m[32m  if (!k) return;[m
[32m+[m[32m  const prev = cache[k] || {};[m
[32m+[m[32m  cache[k] = {[m
[32m+[m[32m    kondisi: meta.kondisi ?? prev.kondisi,[m
[32m+[m[32m    alasan: meta.alasan ?? prev.alasan,[m
[32m+[m[32m    penanganan: meta.penanganan ?? prev.penanganan,[m
[32m+[m[32m  };[m
[32m+[m[32m  saveMetaCache(cache);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * Helper Resolusi visitor_card_id (dipakai Serah & Terima)[m
[32m+[m[32m * â€” SELALU ambil data fresh agar tidak ke-cached.[m
[32m+[m[32m * ========================= */[m
[32m+[m[32masync function resolveVisitorCardIdFromActives(hints = {}) {[m
[32m+[m[32m  const { transactionId, refNo, cardNo } = hints;[m
[32m+[m[32m  try {[m
[32m+[m[32m    const res = await getActiveCards({ ttl: 0 }); // anti-cache[m
[32m+[m[32m    const arr = Array.isArray(res?.data) ? res.data : res?.data?.data || [];[m
[32m+[m
[32m+[m[32m    const getRef = (x) => x?.reference_number || x?.reference || x?.ref_no || x?.ref || null;[m
[32m+[m
[32m+[m[32m    let found = null;[m
[32m+[m[32m    if (transactionId) {[m
[32m+[m[32m      found = arr.find([m
[32m+[m[32m        (x) =>[m
[32m+[m[32m          String(x?.card_transaction_id || x?.transaction_id || x?.id) === String(transactionId)[m
[32m+[m[32m      );[m
[32m+[m[32m    }[m
[32m+[m[32m    if (!found && refNo) {[m
[32m+[m[32m      found = arr.find((x) => String(getRef(x)) === String(refNo));[m
[32m+[m[32m    }[m
[32m+[m[32m    if (!found && cardNo) {[m
[32m+[m[32m      found = arr.find((x) => String(x?.card_number || x?.card_no) === String(cardNo));[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    if (found) {[m
[32m+[m[32m      return ([m
[32m+[m[32m        found?.visitor_card_id ||[m
[32m+[m[32m        found?.card_id ||[m
[32m+[m[32m        found?.visitor_card?.id ||[m
[32m+[m[32m        found?.card?.id ||[m
[32m+[m[32m        null[m
[32m+[m[32m      );[m
[32m+[m[32m    }[m
[32m+[m[32m    return null;[m
[32m+[m[32m  } catch (e) {[m
[32m+[m[32m    console.warn("resolveVisitorCardIdFromActives gagal:", e?.message || e);[m
[32m+[m[32m    return null;[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =========================[m
[32m+[m[32m * UI Bagian Kecil[m
[32m+[m[32m * ========================= */[m
 function Popup({ show, onClose, children, title }) {[m
   if (!show) return null;[m
   return ([m
     <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-20">[m
       <div className="bg-white rounded-[14px] p-0 min-w-[400px] max-w-[520px] w-[97%] shadow-lg relative">[m
[31m-        {/* Header gradient (circle rounded look) */}[m
[31m-        <div className="flex items-center justify-between px-6 py-4 rounded-t-[14px]"[m
[31m-             style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)" }}>[m
[32m+[m[32m        <div[m
[32m+[m[32m          className="flex items-center justify-between px-6 py-4 rounded-t-[14px]"[m
[32m+[m[32m          style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)" }}[m
[32m+[m[32m        >[m
           <div className="flex items-center gap-2">[m
             <div className="w-9 h-9 rounded-full bg-white/15 flex items-center justify-center">[m
               <Icon icon="material-symbols:id-card-rounded" width={22} color="#fff" />[m
             </div>[m
             <span className="font-poppins font-semibold text-white text-[18px]">{title}</span>[m
           </div>[m
[31m-          <button onClick={onClose}[m
[31m-                  className="ml-2 text-white text-[22px] font-bold hover:opacity-80 transition">Ã—</button>[m
[32m+[m[32m          <button[m
[32m+[m[32m            onClick={onClose}[m
[32m+[m[32m            className="ml-2 text-white text-[22px] font-bold hover:opacity-80 transition"[m
[32m+[m[32m          >[m
[32m+[m[32m            Ã—[m
[32m+[m[32m          </button>[m
         </div>[m
         <div className="px-7 py-7">{children}</div>[m
       </div>[m
[36m@@ -155,8 +287,10 @@[m [mfunction Popup({ show, onClose, children, title }) {[m
 [m
 function DataSection({ title, thick = 2, children }) {[m
   return ([m
[31m-    <div className="rounded-[10px] overflow-hidden mb-4"[m
[31m-         style={{ background: "rgba(100,115,175,0.07)", border: "1px solid rgba(208,205,205,0.56)" }}>[m
[32m+[m[32m    <div[m
[32m+[m[32m      className="rounded-[10px] overflow-hidden mb-4"[m
[32m+[m[32m      style={{ background: "rgba(100,115,175,0.07)", border: "1px solid rgba(208,205,205,0.56)" }}[m
[32m+[m[32m    >[m
       <div className="px-4 pt-3 pb-2">[m
         <div className="font-poppins font-medium text-[#919090] text-[14px]">{title}</div>[m
       </div>[m
[36m@@ -168,8 +302,10 @@[m [mfunction DataSection({ title, thick = 2, children }) {[m
 [m
 function Row({ label, value }) {[m
   return ([m
[31m-    <div className="py-2 flex gap-2 text-[14.5px]"[m
[31m-         style={{ borderBottom: "1px solid rgba(208,205,205,0.56)" }}>[m
[32m+[m[32m    <div[m
[32m+[m[32m      className="py-2 flex gap-2 text-[14.5px]"[m
[32m+[m[32m      style={{ borderBottom: "1px solid rgba(208,205,205,0.56)" }}[m
[32m+[m[32m    >[m
       <div className="min-w-[150px] text-[#474646] font-poppins font-medium">{label}</div>[m
       <div className="text-[#474646] font-poppins font-medium">: {value}</div>[m
     </div>[m
[36m@@ -178,8 +314,10 @@[m [mfunction Row({ label, value }) {[m
 [m
 function BoxPetugas({ label, value }) {[m
   return ([m
[31m-    <div className="rounded-[10px] px-4 py-3 mb-2"[m
[31m-         style={{ border: "1px solid rgba(208,205,205,0.56)", background: "#FFFFFF" }}>[m
[32m+[m[32m    <div[m
[32m+[m[32m      className="rounded-[10px] px-4 py-3 mb-2"[m
[32m+[m[32m      style={{ border: "1px solid rgba(208,205,205,0.56)", background: "#FFFFFF" }}[m
[32m+[m[32m    >[m
       <span className="font-poppins font-medium text-[#474646]">[m
         {label} : {value}[m
       </span>[m
[36m@@ -187,139 +325,752 @@[m [mfunction BoxPetugas({ label, value }) {[m
   );[m
 }[m
 [m
[32m+[m[32m/* =========================[m
[32m+[m[32m * Komponen Utama[m
[32m+[m[32m * ========================= */[m
 export default function KartuVisitor() {[m
[31m-  const [dummyData, setDummyData] = useState(initialDummyData);[m
[32m+[m[32m  const [dummyData, setDummyData] = useState([]); // gabungan active + approved[m
   const [showPopup, setShowPopup] = useState(false);[m
[31m-  const [popupType, setPopupType] = useState(""); // "serah", "terima", "terima-read", "laporan"[m
[31m-  const [selectedIdx, setSelectedIdx] = useState(null);[m
[32m+[m[32m  const [popupType, setPopupType] = useState("");[m
[32m+[m[32m  // GANTI: gunakan key stabil (bukan index)[m
[32m+[m[32m  const [selectedKey, setSelectedKey] = useState(null);[m
[32m+[m
   const [laporanKondisi, setLaporanKondisi] = useState("");[m
   const [laporanAlasan, setLaporanAlasan] = useState("");[m
   const [laporanPenanganan, setLaporanPenanganan] = useState("");[m
   const [readonlyLaporan, setReadonlyLaporan] = useState(false);[m
 [m
[31m-  // Export laporan (download file excel/csv dummy)[m
[31m-  const exportLaporan = () => {[m
[31m-    const header = [[m
[31m-      "Nama Pemohon",[m
[31m-      "Instansi",[m
[31m-      "Nomor Pengajuan",[m
[31m-      "Tanggal Pinjam",[m
[31m-      "Tanggal Kembali",[m
[31m-      "Kondisi Kartu",[m
[31m-      "Status",[m
[31m-      "Petugas",[m
[31m-    ].join(",");[m
[31m-    const rows = dummyData.map((d) =>[m
[31m-      [[m
[31m-        d.nama,[m
[31m-        d.instansi,[m
[31m-        d.nomorPengajuan,[m
[31m-        d.tanggalPinjam,[m
[31m-        d.tanggalKembali,[m
[31m-        d.kondisi,[m
[31m-        getStatusKartu(d.tanggalKembali),[m
[31m-        d.petugasSerah || "-",[m
[31m-      ].join(",")[m
[32m+[m[32m  const [submittingSerah, setSubmittingSerah] = useState(false);[m
[32m+[m[32m  const [submittingTerima, setSubmittingTerima] = useState(false);[m
[32m+[m[32m  const [submittingLaporan, setSubmittingLaporan] = useState(false);[m
[32m+[m
[32m+[m[32m  const [showDropdown, setShowDropdown] = useState(false);[m
[32m+[m[32m  const dropdownRef = useRef();[m
[32m+[m
[32m+[m[32m  const navigate = useNavigate();[m
[32m+[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    function handleClickOutside(e) {[m
[32m+[m[32m      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {[m
[32m+[m[32m        setShowDropdown(false);[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[32m    document.addEventListener("mousedown", handleClickOutside);[m
[32m+[m[32m    return () => document.removeEventListener("mousedown", handleClickOutside);[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  const handleLogout = async () => {[m
[32m+[m[32m    try {[m
[32m+[m[32m      await adminLogout?.();[m
[32m+[m[32m    } catch (_) {[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      localStorage.removeItem("token");[m
[32m+[m[32m      localStorage.removeItem("adminName");[m
[32m+[m[32m      localStorage.removeItem("namaPetugas");[m
[32m+[m[32m      try {[m
[32m+[m[32m        localStorage.removeItem(META_CACHE_KEY);[m
[32m+[m[32m      } catch {}[m
[32m+[m[32m      window.location.href = "/admin";[m
[32m+[m[32m    }[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  const formatISO = (v) => (v ? new Date(v).toISOString().slice(0, 10) : "");[m
[32m+[m[32m  function formatTanggal(str) {[m
[32m+[m[32m    const months = [[m
[32m+[m[32m      "Januari","Februari","Maret","April","Mei","Juni",[m
[32m+[m[32m      "Juli","Agustus","September","Oktober","November","Desember",[m
[32m+[m[32m    ];[m
[32m+[m[32m    const d = new Date(str);[m
[32m+[m[32m    if (isNaN(d)) return str || "-";[m
[32m+[m[32m    return `${String(d.getDate()).padStart(2, "0")} ${months[d.getMonth()]} ${d.getFullYear()}`;[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  // map approved -> â€œBelum diambilâ€[m
[32m+[m[32m  const mapApproved = (x) => {[m
[32m+[m[32m    const nama =[m
[32m+[m[32m      x.applicant_name || x.full_name || x.name || x.user_name || x.visitor_name || "-";[m
[32m+[m[32m    const instansi = x.company || x.organization || x.institution || x.agency || "-";[m
[32m+[m[32m    const nomorPengajuan = x.reference_number || x.reference || x.ref_no || x.ref || "-";[m
[32m+[m[32m    const email = x.email || x.applicant_email || x.user_email || "-";[m
[32m+[m[32m    const visitStart = x.visit_date || x.visit_start_date || x.date || x.approved_at || "";[m
[32m+[m[32m    const visitEnd = x.visit_end_date || x.expected_return_date || x.return_date || "";[m
[32m+[m
[32m+[m[32m    const apiCond = mapApiConditionToLabel([m
[32m+[m[32m      x.condition || x.card_condition || x.status_condition || x.kondisi[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m      id: x.id,[m
[32m+[m[32m      transactionId: null,[m
[32m+[m[32m      visitorCardId: findVisitorCardId(x),[m
[32m+[m[32m      referenceNumber: nomorPengajuan,[m
[32m+[m[32m      nama,[m
[32m+[m[32m      instansi,[m
[32m+[m[32m      nomorPengajuan,[m
[32m+[m[32m      kunjungan: formatTanggal(visitStart || new Date()),[m
[32m+[m[32m      email,[m
[32m+[m[32m      tanggalPinjam: formatISO(visitStart) || "",[m
[32m+[m[32m      tanggalKembali: formatISO(visitEnd) || "",[m
[32m+[m[32m      kondisi: apiCond ?? "Baik", // default; akan di-apply cache[m
[32m+[m[32m      aksi: "Belum diambil",[m
[32m+[m[32m      petugasSerah:[m
[32m+[m[32m        x.performed_by_name ||[m
[32m+[m[32m        x.issued_by_name ||[m
[32m+[m[32m        x.petugas_serah ||[m
[32m+[m[32m        x.petugasPenyerah ||[m
[32m+[m[32m        "",[m
[32m+[m[32m      petugas_penyerah:[m
[32m+[m[32m        x.performed_by_name || x.issued_by_name || x.petugas_serah || "",[m
[32m+[m[32m      petugasPenerima:[m
[32m+[m[32m        x.returned_by_name || x.received_by_name || x.petugas_penerima || "",[m
[32m+[m[32m      petugas_penerima:[m
[32m+[m[32m        x.returned_by_name || x.received_by_name || x.petugas_penerima || "",[m
[32m+[m[32m      alasan: x.reason || x.alasan || "",[m
[32m+[m[32m      penanganan: x.handling || x.penanganan || "",[m
[32m+[m[32m      isActive: false,[m
[32m+[m[32m    };[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  // map active -> â€œSerahkan Kartuâ€[m
[32m+[m[32m  const mapActive = (x) => {[m
[32m+[m[32m    const nama =[m
[32m+[m[32m      x.applicant_name || x.full_name || x.name || x.user_name || x.visitor_name || "-";[m
[32m+[m[32m    const instansi = x.company || x.organization || x.institution || x.agency || "-";[m
[32m+[m[32m    const nomorPengajuan = x.reference_number || x.reference || x.ref_no || x.ref || "-";[m
[32m+[m[32m    const email = x.email || x.applicant_email || x.user_email || "-";[m
[32m+[m[32m    const issuedAt = x.issued_at || x.start_date || x.created_at || "";[m
[32m+[m[32m    const due = x.expected_return_date || x.due_date || x.return_date || "";[m
[32m+[m
[32m+[m[32m    const apiCond = mapApiConditionToLabel([m
[32m+[m[32m      x.condition || x.card_condition || x.kondisi[m
[32m+[m[32m    );[m
[32m+[m
[32m+[m[32m    const issuer = x.performed_by_name || x.issued_by_name || x.performed_by || "";[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m      id: x.id,[m
[32m+[m[32m      transactionId: x.card_transaction_id || x.transaction_id || x.id,[m
[32m+[m[32m      visitorCardId: findVisitorCardId(x),[m
[32m+[m[32m      referenceNumber: nomorPengajuan,[m
[32m+[m[32m      nama,[m
[32m+[m[32m      instansi,[m
[32m+[m[32m      nomorPengajuan,[m
[32m+[m[32m      kunjungan: formatTanggal(issuedAt || new Date()),[m
[32m+[m[32m      email,[m
[32m+[m[32m      tanggalPinjam: formatISO(issuedAt) || "",[m
[32m+[m[32m      tanggalKembali: formatISO(due) || "",[m
[32m+[m[32m      kondisi: apiCond ?? "Baik", // default; akan di-apply cache[m
[32m+[m[32m      aksi: "Serahkan Kartu",[m
[32m+[m[32m      petugasSerah: issuer || namaPetugas,[m
[32m+[m[32m      petugasPenyerah: issuer || namaPetugas,[m
[32m+[m[32m      petugas_serah: issuer || namaPetugas,[m
[32m+[m[32m      petugasPenerima: x.returned_by_name || x.received_by_name || "",[m
[32m+[m[32m      petugas_penerima: x.returned_by_name || x.received_by_name || "",[m
[32m+[m[32m      alasan: x.reason || x.alasan || "",[m
[32m+[m[32m      penanganan: x.handling || x.penanganan || "",[m
[32m+[m[32m      isActive: true,[m
[32m+[m[32m    };[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  // Kunci unik untuk rekonsiliasi[m
[32m+[m[32m  function rowKey(r) {[m
[32m+[m[32m    return ([m
[32m+[m[32m      r.transactionId ||[m
[32m+[m[32m      r.referenceNumber ||[m
[32m+[m[32m      r.nomorPengajuan ||[m
[32m+[m[32m      r.visitorCardId ||[m
[32m+[m[32m      r.id[m
     );[m
[31m-    const csv = [header, ...rows].join("\n");[m
[31m-    const blob = new Blob([csv], { type: "text/csv" });[m
[31m-    const url = URL.createObjectURL(blob);[m
[31m-[m
[31m-    const a = document.createElement("a");[m
[31m-    a.href = url;[m
[31m-    a.download = "laporan_kartu_visitor.csv";[m
[31m-    a.click();[m
[31m-    URL.revokeObjectURL(url);[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  function pickRowByKey(key) {[m
[32m+[m[32m    if (!key) return null;[m
[32m+[m[32m    return (dummyData || []).find((r) => String(rowKey(r)) === String(key)) || null;[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  // Rekonsiliasi kondisi lokal (jangan ketimpa "Baik" dari server)[m
[32m+[m[32m  function reconcileKeepLocalKondisi(prevList, nextList) {[m
[32m+[m[32m    const mapPrev = new Map();[m
[32m+[m[32m    (prevList || []).forEach((p) => {[m
[32m+[m[32m      const k = rowKey(p);[m
[32m+[m[32m      if (k) mapPrev.set(String(k), p);[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    return nextList.map((n) => {[m
[32m+[m[32m      const k = rowKey(n);[m
[32m+[m[32m      if (!k) return n;[m
[32m+[m[32m      const old = mapPrev.get(String(k));[m
[32m+[m[32m      if (!old) return n;[m
[32m+[m
[32m+[m[32m      const oldK = (old.kondisi || "").toLowerCase();[m
[32m+[m[32m      const newK = (n.kondisi || "").toLowerCase();[m
[32m+[m
[32m+[m[32m      const isOldSpecific = oldK === "rusak" || oldK === "hilang";[m
[32m+[m[32m      const isNewBlankOrBaik = !newK || newK === "baik";[m
[32m+[m
[32m+[m[32m      if (isOldSpecific && isNewBlankOrBaik) {[m
[32m+[m[32m        return {[m
[32m+[m[32m          ...n,[m
[32m+[m[32m          kondisi: old.kondisi,[m
[32m+[m[32m          alasan: old.alasan,[m
[32m+[m[32m          penanganan: old.penanganan,[m
[32m+[m[32m        };[m
[32m+[m[32m      }[m
[32m+[m[32m      return n;[m
[32m+[m[32m    });[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  async function reloadData() {[m
[32m+[m[32m    try {[m
[32m+[m[32m      // anti-cache untuk daftar dinamis[m
[32m+[m[32m      const [approvedRes, activeRes] = await Promise.all([[m
[32m+[m[32m        getApprovedCards({ ttl: 0 }),[m
[32m+[m[32m        getActiveCards({ ttl: 0 }),[m
[32m+[m[32m      ]);[m
[32m+[m
[32m+[m[32m      const approvedRaw = Array.isArray(approvedRes?.data)[m
[32m+[m[32m        ? approvedRes.data[m
[32m+[m[32m        : approvedRes?.data?.data || [];[m
[32m+[m[32m      const activeRaw = Array.isArray(activeRes?.data)[m
[32m+[m[32m        ? activeRes.data[m
[32m+[m[32m        : activeRes?.data?.data || [];[m
[32m+[m
[32m+[m[32m      const approved = approvedRaw.map(mapApproved);[m
[32m+[m[32m      const active = activeRaw.map(mapActive);[m
[32m+[m
[32m+[m[32m      const merged = [...active, ...approved];[m
[32m+[m[32m      const reconciled = reconcileKeepLocalKondisi(dummyData, merged);[m
[32m+[m[32m      const withCache = applyMetaCache(reconciled);[m
[32m+[m
[32m+[m[32m      setDummyData(withCache);[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m      console.error("reloadData gagal:", err);[m
[32m+[m[32m      setDummyData(applyMetaCache([]));[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    reloadData();[m
[32m+[m[32m    // eslint-disable-next-line react-hooks/exhaustive-deps[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  const exportLaporan = async () => {[m
[32m+[m[32m    try {[m
[32m+[m[32m      const resp = await exportDailyFlow();[m
[32m+[m[32m      const filename = `laporan_kartu_visitor_harian_${new Date()[m
[32m+[m[32m        .toISOString()[m
[32m+[m[32m        .slice(0, 10)}.xlsx`;[m
[32m+[m[32m      downloadBlob(resp.data, filename);[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      const header = [[m
[32m+[m[32m        "Nama Pemohon",[m
[32m+[m[32m        "Instansi",[m
[32m+[m[32m        "Nomor Pengajuan",[m
[32m+[m[32m        "Tanggal Pinjam",[m
[32m+[m[32m        "Tanggal Kembali",[m
[32m+[m[32m        "Kondisi Kartu",[m
[32m+[m[32m        "Status",[m
[32m+[m[32m        "Petugas",[m
[32m+[m[32m      ].join(",");[m
[32m+[m[32m      const rows = dummyData.map((d) => {[m
[32m+[m[32m        const status = getStatusKartu(d.tanggalKembali, {[m
[32m+[m[32m          isActive: d.isActive,[m
[32m+[m[32m          aksi: d.aksi,[m
[32m+[m[32m        });[m
[32m+[m[32m        return [[m
[32m+[m[32m          d.nama,[m
[32m+[m[32m          d.instansi,[m
[32m+[m[32m          d.nomorPengajuan,[m
[32m+[m[32m          d.tanggalPinjam || "-",[m
[32m+[m[32m          d.tanggalKembali || "-",[m
[32m+[m[32m          d.kondisi || "-",[m
[32m+[m[32m          status,[m
[32m+[m[32m          d.petugasSerah || d.petugas_serah || "-",[m
[32m+[m[32m        ].join(",");[m
[32m+[m[32m      });[m
[32m+[m[32m      const csv = [header, ...rows].join("\n");[m
[32m+[m[32m      const blob = new Blob([csv], { type: "text/csv" });[m
[32m+[m[32m      const url = URL.createObjectURL(blob);[m
[32m+[m[32m      const a = document.createElement("a");[m
[32m+[m[32m      a.href = url;[m
[32m+[m[32m      a.download = "laporan_kartu_visitor.csv";[m
[32m+[m[32m      a.click();[m
[32m+[m[32m      URL.revokeObjectURL(url);[m
[32m+[m[32m    }[m
   };[m
 [m
[31m-  // Pop up konfirmasi serah kartu[m
[32m+[m[32m  // ==== Open Popups (gunakan key stabil) ====[m
   const openSerahPopup = (idx) => {[m
[31m-    setSelectedIdx(idx);[m
[32m+[m[32m    setSelectedKey(rowKey(dummyData[idx]));[m
     setPopupType("serah");[m
     setShowPopup(true);[m
   };[m
[31m-[m
[31m-  // Pop up konfirmasi terima kartu (ada tombol konfirmasi)[m
   const openTerimaPopup = (idx) => {[m
[31m-    setSelectedIdx(idx);[m
[32m+[m[32m    setSelectedKey(rowKey(dummyData[idx]));[m
     setPopupType("terima");[m
     setShowPopup(true);[m
   };[m
[31m-[m
[31m-  // Pop up read-only terima kartu[m
   const openTerimaPopupRead = (idx) => {[m
[31m-    setSelectedIdx(idx);[m
[32m+[m[32m    setSelectedKey(rowKey(dummyData[idx]));[m
     setPopupType("terima-read");[m
     setShowPopup(true);[m
   };[m
[31m-[m
[31m-  // Pop up laporan kartu rusak/hilang[m
   const openLaporanPopup = (idx, readonly = false) => {[m
[31m-    setSelectedIdx(idx);[m
[31m-    setLaporanKondisi(dummyData[idx].kondisi);[m
[31m-    setLaporanAlasan(dummyData[idx].alasan);[m
[31m-    setLaporanPenanganan(dummyData[idx].penanganan);[m
[32m+[m[32m    const r = dummyData[idx];[m
[32m+[m[32m    setSelectedKey(rowKey(r));[m
[32m+[m[32m    setLaporanKondisi(r.kondisi || "Baik");[m
[32m+[m[32m    setLaporanAlasan(r.alasan || "");[m
[32m+[m[32m    setLaporanPenanganan(r.penanganan || "");[m
     setReadonlyLaporan(readonly);[m
     setPopupType("laporan");[m
     setShowPopup(true);[m
   };[m
 [m
[31m-  // Ketika konfirmasi serah kartu[m
[31m-  const handleKonfirmasiSerah = () => {[m
[31m-    setShowPopup(false);[m
[31m-    setDummyData((prev) =>[m
[31m-      prev.map((row, idx) =>[m
[31m-        idx === selectedIdx ? { ...row, aksi: "Serahkan Kartu", petugasSerah: namaPetugas } : row[m
[31m-      )[m
[31m-    );[m
[32m+[m[32m  /* =========================[m
[32m+[m[32m   * Serahkan Kartu -> Approved => Active[m
[32m+[m[32m   * ========================= */[m
[32m+[m[32m  const handleKonfirmasiSerah = async () => {[m
[32m+[m[32m    const row = pickRowByKey(selectedKey);[m
[32m+[m[32m    if (!row) return;[m
[32m+[m
[32m+[m[32m    let visitorCardId = findVisitorCardId(row);[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m      setSubmittingSerah(true);[m
[32m+[m
[32m+[m[32m      const condApi = mapConditionToAPI(row.kondisi || "Baik");[m
[32m+[m
[32m+[m[32m      const payload = {[m
[32m+[m[32m        card_condition: condApi,[m
[32m+[m[32m        condition: condApi,[m
[32m+[m[32m        performed_by_name: namaPetugas,[m
[32m+[m[32m      };[m
[32m+[m[32m      if (visitorCardId) payload.visitor_card_id = visitorCardId;[m
[32m+[m[32m      else if (row?.referenceNumber || row?.nomorPengajuan) {[m
[32m+[m[32m        payload.reference_number = row?.referenceNumber || row?.nomorPengajuan;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      const resp = await issueCard(payload);[m
[32m+[m
[32m+[m[32m      const tx = resp?.data?.data || resp?.data || {};[m
[32m+[m[32m      const newTransactionId =[m
[32m+[m[32m        tx.card_transaction_id ||[m
[32m+[m[32m        tx.transaction_id ||[m
[32m+[m[32m        tx.id ||[m
[32m+[m[32m        tx?.transaction?.id ||[m
[32m+[m[32m        null;[m
[32m+[m
[32m+[m[32m      const newVisitorCardId =[m
[32m+[m[32m        tx.visitor_card_id ||[m
[32m+[m[32m        tx.card_id ||[m
[32m+[m[32m        tx.card?.id ||[m
[32m+[m[32m        tx.visitor_card?.id ||[m
[32m+[m[32m        tx.card?.visitor_card_id ||[m
[32m+[m[32m        tx?.transaction?.visitor_card_id ||[m
[32m+[m[32m        null;[m
[32m+[m
[32m+[m[32m      let resolvedVisitorCardId = newVisitorCardId || visitorCardId;[m
[32m+[m[32m      if (!resolvedVisitorCardId && (newTransactionId || payload.reference_number)) {[m
[32m+[m[32m        const fallbackId = await resolveVisitorCardIdFromActives({[m
[32m+[m[32m          transactionId: newTransactionId,[m
[32m+[m[32m          refNo: payload.reference_number,[m
[32m+[m[32m        });[m
[32m+[m[32m        if (fallbackId) resolvedVisitorCardId = fallbackId;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      // Simpan ke IDMap berdasarkan reference[m
[32m+[m[32m      const refForIdMap = row?.referenceNumber || row?.nomorPengajuan;[m
[32m+[m[32m      setIdsForReference(refForIdMap, {[m
[32m+[m[32m        visitor_card_id: resolvedVisitorCardId || null,[m
[32m+[m[32m        transaction_id: newTransactionId || null,[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      setDummyData((prev) =>[m
[32m+[m[32m        prev.map((r) =>[m
[32m+[m[32m          String(rowKey(r)) === String(selectedKey)[m
[32m+[m[32m            ? {[m
[32m+[m[32m                ...r,[m
[32m+[m[32m                transactionId: newTransactionId ?? r.transactionId,[m
[32m+[m[32m                aksi: "Serahkan Kartu",[m
[32m+[m[32m                petugasSerah: namaPetugas,[m
[32m+[m[32m                petugasPenyerah: namaPetugas,[m
[32m+[m[32m                petugas_serah: namaPetugas,[m
[32m+[m[32m                isActive: true,[m
[32m+[m[32m                tanggalPinjam: new Date().toISOString().slice(0, 10),[m
[32m+[m[32m                visitorCardId: resolvedVisitorCardId || r.visitorCardId || null,[m
[32m+[m[32m                kondisi: r.kondisi || "Baik",[m
[32m+[m[32m              }[m
[32m+[m[32m            : r[m
[32m+[m[32m        )[m
[32m+[m[32m      );[m
[32m+[m[32m      setShowPopup(false);[m
[32m+[m
[32m+[m[32m      cacheMeta([m
[32m+[m[32m        { ...row, visitorCardId: resolvedVisitorCardId || row.visitorCardId },[m
[32m+[m[32m        {[m
[32m+[m[32m          kondisi: row.kondisi,[m
[32m+[m[32m          alasan: row.alasan,[m
[32m+[m[32m          penanganan: row.penanganan,[m
[32m+[m[32m        }[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m      try {[m
[32m+[m[32m        window.dispatchEvent([m
[32m+[m[32m          new CustomEvent("dashboard:changed", { detail: { type: "issued" } })[m
[32m+[m[32m        );[m
[32m+[m[32m        window.dispatchEvent([m
[32m+[m[32m          new CustomEvent("dashboard:increment", {[m
[32m+[m[32m            detail: { field: "keluarHariIni", delta: 1 },[m
[32m+[m[32m          })[m
[32m+[m[32m        );[m
[32m+[m[32m        window.dispatchEvent(new CustomEvent("riwayat:refresh"));[m
[32m+[m[32m        notifyDirtyCards();[m
[32m+[m[32m      } catch {}[m
[32m+[m[32m      try {[m
[32m+[m[32m        await reloadData();[m
[32m+[m[32m      } catch (_e) {}[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      const msg =[m
[32m+[m[32m        e?.response?.data?.message ||[m
[32m+[m[32m        e?.message ||[m
[32m+[m[32m        "Gagal menyerahkan kartu.";[m
[32m+[m[32m      if ([m
[32m+[m[32m        e?.response?.status === 422 ||[m
[32m+[m[32m        (e?.response?.data && typeof e.response.data === "object")[m
[32m+[m[32m      ) {[m
[32m+[m[32m        alert([m
[32m+[m[32m          msg +[m
[32m+[m[32m            "\nPastikan backend menerima reference_number atau mengembalikan visitor_card_id pada respons issueCard."[m
[32m+[m[32m        );[m
[32m+[m[32m      } else {[m
[32m+[m[32m        alert(msg);[m
[32m+[m[32m      }[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      setSubmittingSerah(false);[m
[32m+[m[32m    }[m
   };[m
 [m
[31m-  // Ketika konfirmasi terima kartu[m
[31m-  const handleKonfirmasiTerima = () => {[m
[31m-    setShowPopup(false);[m
[31m-    setDummyData((prev) =>[m
[31m-      prev.map((row, idx) => (idx === selectedIdx ? { ...row, aksi: "Terima Kartu" } : row))[m
[31m-    );[m
[32m+[m[32m  /* =========================[m
[32m+[m[32m   * Terima Kartu -> Active => Selesai[m
[32m+[m[32m   * (utamakan IDMap -> fallback resolver)[m
[32m+[m[32m   * ========================= */[m
[32m+[m[32m  const handleKonfirmasiTerima = async () => {[m
[32m+[m[32m    const row = pickRowByKey(selectedKey);[m
[32m+[m[32m    if (!row) return;[m
[32m+[m
[32m+[m[32m    let transactionId = row?.transactionId || row?.id || null;[m
[32m+[m[32m    const refNo = row?.referenceNumber || row?.nomorPengajuan || null;[m
[32m+[m[32m    const cardNo = row?.card_number || row?.cardNo || null;[m
[32m+[m
[32m+[m[32m    let visitorCardId = findVisitorCardId(row);[m
[32m+[m
[32m+[m[32m    // Ambil dari IDMap jika tersedia[m
[32m+[m[32m    const idFromMap = getIdsForReference(refNo);[m
[32m+[m[32m    if (!visitorCardId && idFromMap?.visitor_card_id) visitorCardId = idFromMap.visitor_card_id;[m
[32m+[m[32m    if (!transactionId && idFromMap?.transaction_id) transactionId = idFromMap.transaction_id;[m
[32m+[m
[32m+[m[32m    const buildPayload = (withVisitorId) => ({[m
[32m+[m[32m      ...(withVisitorId && visitorCardId[m
[32m+[m[32m        ? { visitor_card_id: visitorCardId }[m
[32m+[m[32m        : {}),[m
[32m+[m[32m      ...(transactionId[m
[32m+[m[32m        ? {[m
[32m+[m[32m            card_transaction_id: transactionId,[m
[32m+[m[32m            transaction_id: transactionId,[m
[32m+[m[32m          }[m
[32m+[m[32m        : {}),[m
[32m+[m[32m      ...(refNo ? { reference_number: refNo } : {}),[m
[32m+[m[32m      card_condition: mapConditionToAPI(row.kondisi || "Baik"),[m
[32m+[m[32m      condition: mapConditionToAPI(row.kondisi || "Baik"),[m
[32m+[m[32m      notes: row.alasan || row.penanganan || "",[m
[32m+[m[32m      returned_by_name: namaPetugas,[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m      setSubmittingTerima(true);[m
[32m+[m
[32m+[m[32m      try {[m
[32m+[m[32m        await returnCard(buildPayload(!!visitorCardId));[m
[32m+[m[32m      } catch (err1) {[m
[32m+[m[32m        const msg = err1?.response?.data?.message || "";[m
[32m+[m[32m        const needsVisitorId =[m
[32m+[m[32m          err1?.response?.status === 422 ||[m
[32m+[m[32m          /visitor[_ ]?card[_ ]?id/i.test(msg);[m
[32m+[m
[32m+[m[32m        if (needsVisitorId && !visitorCardId) {[m
[32m+[m[32m          visitorCardId = await resolveVisitorCardIdFromActives({[m
[32m+[m[32m            transactionId,[m
[32m+[m[32m            refNo,[m
[32m+[m[32m            cardNo,[m
[32m+[m[32m          });[m
[32m+[m[32m          if (!visitorCardId) {[m
[32m+[m[32m            alert([m
[32m+[m[32m              "Visitor Card ID tidak ditemukan.\n" +[m
[32m+[m[32m                "Pastikan kartu sudah DISERAHKAN sebelumnya.\n" +[m
[32m+[m[32m                "Jika backend memerlukan visitor_card_id, pastikan endpoint issueCard mengembalikannya."[m
[32m+[m[32m            );[m
[32m+[m[32m            setSubmittingTerima(false);[m
[32m+[m[32m            return;[m
[32m+[m[32m          }[m
[32m+[m[32m          await returnCard(buildPayload(true));[m
[32m+[m[32m        } else {[m
[32m+[m[32m          throw err1;[m
[32m+[m[32m        }[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      // --- PATCH: paksa kondisi konsisten di Riwayat ---[m
[32m+[m[32m      const normalized = normalizeConditionLabel(row.kondisi);[m
[32m+[m[32m      const referenceForPatch =[m
[32m+[m[32m        refNo || row?.nomorPengajuan || row?.referenceNumber;[m
[32m+[m[32m      saveRiwayatPatch(referenceForPatch, normalized);[m
[32m+[m[32m      broadcastRiwayatPatch(referenceForPatch, normalized);[m
[32m+[m[32m      // --------------------------------------------------[m
[32m+[m
[32m+[m[32m      // Statistik & meta[m
[32m+[m[32m      window.dispatchEvent([m
[32m+[m[32m        new CustomEvent("dashboard:changed", { detail: { type: "returned" } })[m
[32m+[m[32m      );[m
[32m+[m[32m      window.dispatchEvent([m
[32m+[m[32m        new CustomEvent("dashboard:increment", {[m
[32m+[m[32m          detail: { field: "masukHariIni", delta: 1 },[m
[32m+[m[32m        })[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m      if (normalized === "Rusak") {[m
[32m+[m[32m        window.dispatchEvent([m
[32m+[m[32m          new CustomEvent("dashboard:changed", { detail: { type: "damaged" } })[m
[32m+[m[32m        );[m
[32m+[m[32m        window.dispatchEvent([m
[32m+[m[32m          new CustomEvent("dashboard:increment", {[m
[32m+[m[32m            detail: { field: "rusak", delta: 1 },[m
[32m+[m[32m          })[m
[32m+[m[32m        );[m
[32m+[m[32m      } else if (normalized === "Hilang") {[m
[32m+[m[32m        window.dispatchEvent([m
[32m+[m[32m          new CustomEvent("dashboard:changed", { detail: { type: "lost" } })[m
[32m+[m[32m        );[m
[32m+[m[32m        window.dispatchEvent([m
[32m+[m[32m          new CustomEvent("dashboard:increment", {[m
[32m+[m[32m            detail: { field: "hilang", delta: 1 },[m
[32m+[m[32m          })[m
[32m+[m[32m        );[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      const todayISO = new Date().toISOString().slice(0, 10);[m
[32m+[m[32m      const updatedRow = {[m
[32m+[m[32m        ...row,[m
[32m+[m[32m        aksi: "Terima Kartu",[m
[32m+[m[32m        isActive: false,[m
[32m+[m[32m        tanggalKembali: row.tanggalKembali || todayISO,[m
[32m+[m[32m        visitorCardId: visitorCardId || row.visitorCardId || null,[m
[32m+[m[32m        petugasPenerima: namaPetugas,[m
[32m+[m[32m        petugas_penerima: namaPetugas,[m
[32m+[m[32m        kondisi: row.kondisi || "Baik",[m
[32m+[m[32m      };[m
[32m+[m[32m      cacheMeta(updatedRow, {[m
[32m+[m[32m        kondisi: updatedRow.kondisi,[m
[32m+[m[32m        alasan: updatedRow.alasan,[m
[32m+[m[32m        penanganan: updatedRow.penanganan,[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      // Hapus baris berdasarkan key stabil[m
[32m+[m[32m      setDummyData((prev) => prev.filter((r) => String(rowKey(r)) !== String(selectedKey)));[m
[32m+[m[32m      setShowPopup(false);[m
[32m+[m
[32m+[m[32m      try {[m
[32m+[m[32m        window.dispatchEvent(new CustomEvent("riwayat:refresh"));[m
[32m+[m[32m        notifyDirtyCards();[m
[32m+[m[32m      } catch {}[m
[32m+[m
[32m+[m[32m      // Opsional: bersihkan IDMap untuk reference ini[m
[32m+[m[32m      try {[m
[32m+[m[32m        if (refNo) {[m
[32m+[m[32m          const map = loadIdMap();[m
[32m+[m[32m          if (map[refNo]) {[m
[32m+[m[32m            delete map[refNo];[m
[32m+[m[32m            saveIdMap(map);[m
[32m+[m[32m          }[m
[32m+[m[32m        }[m
[32m+[m[32m      } catch {}[m
[32m+[m
[32m+[m[32m      navigate("/admin/riwayat");[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      alert([m
[32m+[m[32m        e?.response?.data?.message || e?.message || "Gagal menerima kartu."[m
[32m+[m[32m      );[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      setSubmittingTerima(false);[m
[32m+[m[32m    }[m
   };[m
 [m
[31m-  // Ketika simpan laporan kondisi kartu hilang/rusak[m
[31m-  const handleSimpanLaporan = () => {[m
[31m-    setDummyData((prev) =>[m
[31m-      prev.map((row, idx) =>[m
[31m-        idx === selectedIdx[m
[31m-          ? {[m
[31m-              ...row,[m
[31m-              kondisi: laporanKondisi,[m
[31m-              alasan: laporanAlasan,[m
[31m-              penanganan: laporanPenanganan,[m
[31m-              petugasSerah: namaPetugas,[m
[31m-            }[m
[31m-          : row[m
[31m-      )[m
[31m-    );[m
[31m-    setShowPopup(false);[m
[32m+[m[32m  /* =========================[m
[32m+[m[32m   * Simpan Laporan (Rusak/Hilang)[m
[32m+[m[32m   * ========================= */[m
[32m+[m[32m  const handleSimpanLaporan = async () => {[m
[32m+[m[32m    const row = pickRowByKey(selectedKey);[m
[32m+[m[32m    if (!row) return;[m
[32m+[m
[32m+[m[32m    let transactionId = row.transactionId || null;[m
[32m+[m[32m    const visitorCardId = findVisitorCardId(row);[m
[32m+[m[32m    const refNo = row.referenceNumber || row.nomorPengajuan || null;[m
[32m+[m
[32m+[m[32m    if (!transactionId && !visitorCardId && !refNo) {[m
[32m+[m[32m      alert([m
[32m+[m[32m        "Tidak dapat menemukan ID untuk memperbarui kondisi. Pastikan kartu sudah diserahkan atau ada reference number."[m
[32m+[m[32m      );[m
[32m+[m[32m      return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m      setSubmittingLaporan(true);[m
[32m+[m
[32m+[m[32m      if (!transactionId) {[m
[32m+[m[32m        try {[m
[32m+[m[32m          const issuePayload = {[m
[32m+[m[32m            performed_by_name: namaPetugas,[m
[32m+[m[32m            card_condition: mapConditionToAPI(laporanKondisi || "Baik"),[m
[32m+[m[32m            condition: mapConditionToAPI(laporanKondisi || "Baik"),[m
[32m+[m[32m          };[m
[32m+[m[32m          if (visitorCardId) issuePayload.visitor_card_id = visitorCardId;[m
[32m+[m[32m          if (refNo) issuePayload.reference_number = refNo;[m
[32m+[m
[32m+[m[32m          const issueResp = await issueCard(issuePayload);[m
[32m+[m[32m          const tx = issueResp?.data?.data || issueResp?.data || {};[m
[32m+[m[32m          transactionId =[m
[32m+[m[32m            tx.card_transaction_id ||[m
[32m+[m[32m            tx.transaction_id ||[m
[32m+[m[32m            tx.id ||[m
[32m+[m[32m            tx?.transaction?.id ||[m
[32m+[m[32m            null;[m
[32m+[m
[32m+[m[32m          const newVisitorCardId =[m
[32m+[m[32m            tx.visitor_card_id || tx.card_id || tx.card?.id || tx.visitor_card?.id || null;[m
[32m+[m
[32m+[m[32m          // Simpan ID ke IDMap juga agar â€œTerimaâ€ setelahnya aman[m
[32m+[m[32m          setIdsForReference(refNo, {[m
[32m+[m[32m            visitor_card_id: newVisitorCardId || null,[m
[32m+[m[32m            transaction_id: transactionId || null,[m
[32m+[m[32m          });[m
[32m+[m
[32m+[m[32m          setDummyData((prev) =>[m
[32m+[m[32m            prev.map((r) =>[m
[32m+[m[32m              String(rowKey(r)) === String(selectedKey)[m
[32m+[m[32m                ? {[m
[32m+[m[32m                    ...r,[m
[32m+[m[32m                    transactionId: transactionId || r.transactionId,[m
[32m+[m[32m                    visitorCardId: newVisitorCardId || r.visitorCardId,[m
[32m+[m[32m                    aksi: "Serahkan Kartu",[m
[32m+[m[32m                    isActive: true,[m
[32m+[m[32m                    petugasSerah: namaPetugas,[m
[32m+[m[32m                    petugasPenyerah: namaPetugas,[m
[32m+[m[32m                    petugas_serah: namaPetugas,[m
[32m+[m[32m                    tanggalPinjam:[m
[32m+[m[32m                      r.tanggalPinjam || new Date().toISOString().slice(0, 10),[m
[32m+[m[32m                    kondisi: laporanKondisi || r.kondisi || "Baik",[m
[32m+[m[32m                  }[m
[32m+[m[32m                : r[m
[32m+[m[32m            )[m
[32m+[m[32m          );[m
[32m+[m[32m        } catch (issueErr) {[m
[32m+[m[32m          console.warn("Auto-issue gagal:", issueErr);[m
[32m+[m[32m          alert([m
[32m+[m[32m            "Gagal membuat transaksi kartu. Harap lakukan penyerahan kartu terlebih dahulu sebelum melaporkan kondisi."[m
[32m+[m[32m          );[m
[32m+[m[32m          return;[m
[32m+[m[32m        }[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      if (!transactionId) {[m
[32m+[m[32m        alert([m
[32m+[m[32m          "Transaction ID tidak ditemukan setelah percobaan. Pembaruan kondisi dibatalkan."[m
[32m+[m[32m        );[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      const payload = {[m
[32m+[m[32m        card_transaction_id: transactionId,[m
[32m+[m[32m        card_condition: mapConditionToAPI(laporanKondisi),[m
[32m+[m[32m        condition: mapConditionToAPI(laporanKondisi),[m
[32m+[m[32m        reason: laporanAlasan,[m
[32m+[m[32m        handling: laporanPenanganan,[m
[32m+[m[32m      };[m
[32m+[m
[32m+[m[32m      await editCardCondition(transactionId, payload);[m
[32m+[m
[32m+[m[32m      const cacheKey = keyForRow(row);[m
[32m+[m[32m      cacheMeta(cacheKey, {[m
[32m+[m[32m        kondisi: laporanKondisi,[m
[32m+[m[32m        alasan: laporanAlasan,[m
[32m+[m[32m        penanganan: laporanPenanganan,[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      // --- PATCH: paksa kondisi konsisten di Riwayat ---[m
[32m+[m[32m      const refForPatch = refNo || row?.nomorPengajuan || row?.referenceNumber;[m
[32m+[m[32m      const normalized = normalizeConditionLabel(laporanKondisi);[m
[32m+[m[32m      saveRiwayatPatch(refForPatch, normalized);[m
[32m+[m[32m      broadcastRiwayatPatch(refForPatch, normalized);[m
[32m+[m[32m      // --------------------------------------------------[m
[32m+[m
[32m+[m[32m      setDummyData((prev) =>[m
[32m+[m[32m        prev.map((r) =>[m
[32m+[m[32m          String(rowKey(r)) === String(selectedKey)[m
[32m+[m[32m            ? {[m
[32m+[m[32m                ...r,[m
[32m+[m[32m                kondisi: laporanKondisi,[m
[32m+[m[32m                alasan: laporanAlasan,[m
[32m+[m[32m                penanganan: laporanPenanganan,[m
[32m+[m[32m              }[m
[32m+[m[32m            : r[m
[32m+[m[32m        )[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m      try {[m
[32m+[m[32m        await reloadData();[m
[32m+[m[32m      } catch (_err) {}[m
[32m+[m
[32m+[m[32m      setShowPopup(false);[m
[32m+[m
[32m+[m[32m      try {[m
[32m+[m[32m        if (normalized === "Hilang") {[m
[32m+[m[32m          window.dispatchEvent([m
[32m+[m[32m            new CustomEvent("dashboard:changed", { detail: { type: "lost" } })[m
[32m+[m[32m          );[m
[32m+[m[32m          window.dispatchEvent([m
[32m+[m[32m            new CustomEvent("dashboard:increment", {[m
[32m+[m[32m              detail: { field: "hilang", delta: 1 },[m
[32m+[m[32m            })[m
[32m+[m[32m          );[m
[32m+[m[32m        } else if (normalized === "Rusak") {[m
[32m+[m[32m          window.dispatchEvent([m
[32m+[m[32m            new CustomEvent("dashboard:changed", { detail: { type: "damaged" } })[m
[32m+[m[32m          );[m
[32m+[m[32m          window.dispatchEvent([m
[32m+[m[32m            new CustomEvent("dashboard:increment", {[m
[32m+[m[32m              detail: { field: "rusak", delta: 1 },[m
[32m+[m[32m            })[m
[32m+[m[32m          );[m
[32m+[m[32m        } else {[m
[32m+[m[32m          window.dispatchEvent([m
[32m+[m[32m            new CustomEvent("dashboard:changed", {[m
[32m+[m[32m              detail: { type: "condition-updated" },[m
[32m+[m[32m            })[m
[32m+[m[32m          );[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        notifyDirtyCards();[m
[32m+[m[32m        window.dispatchEvent(new CustomEvent("riwayat:refresh"));[m
[32m+[m[32m      } catch {}[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      alert(e?.response?.data?.message || "Gagal menyimpan laporan kondisi.");[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      setSubmittingLaporan(false);[m
[32m+[m[32m    }[m
   };[m
 [m
[31m-  // Format tanggal jadi "DD MMMM YYYY"[m
[31m-  function formatTanggal(str) {[m
[31m-    const months = [[m
[31m-      "Januari",[m
[31m-      "Februari",[m
[31m-      "Maret",[m
[31m-      "April",[m
[31m-      "Mei",[m
[31m-      "Juni",[m
[31m-      "Juli",[m
[31m-      "Agustus",[m
[31m-      "September",[m
[31m-      "Oktober",[m
[31m-      "November",[m
[31m-      "Desember",[m
[31m-    ];[m
[31m-    const d = new Date(str);[m
[31m-    if (isNaN(d)) return str;[m
[31m-    return `${String(d.getDate()).padStart(2, "0")} ${months[d.getMonth()]} ${d.getFullYear()}`;[m
[31m-  }[m
[32m+[m[32m  /* =========================[m
[32m+[m[32m   * Render[m
[32m+[m[32m   * ========================= */[m
[32m+[m[32m  const selectedRow = pickRowByKey(selectedKey);[m
 [m
   return ([m
     <div className="min-h-screen flex bg-[#6A8BB0] font-poppins">[m
[36m@@ -332,23 +1083,38 @@[m [mexport default function KartuVisitor() {[m
         <div className="text-[18px] font-poppins font-medium text-[#242424] text-center mb-7 leading-[20px]">[m
           Admin Panel Kartu Visitor[m
         </div>[m
[31m-        <div className="w-full flex justify-center mb-12">[m
[31m-          <div[m
[31m-            style={{[m
[31m-              width: "100%",[m
[31m-              height: 2,[m
[31m-              background: "#C4C4C4",[m
[31m-              borderRadius: 2,[m
[31m-              margin: "0 auto",[m
[31m-            }}[m
[31m-          />[m
[31m-        </div>[m
[32m+[m[32m        <div[m
[32m+[m[32m          className="w-full flex justify-center mb-12"[m
[32m+[m[32m          style={{[m
[32m+[m[32m            width: "100%",[m
[32m+[m[32m            height: 2,[m
[32m+[m[32m            background: "#C4C4C4",[m
[32m+[m[32m            borderRadius: 2,[m
[32m+[m[32m            margin: "0 auto",[m
[32m+[m[32m          }}[m
[32m+[m[32m        />[m
         <nav className="flex flex-col gap-4 mt-2">[m
           {[[m
[31m-            { label: "Dashboard", icon: "streamline-plump:user-pin-remix", path: "/admin/dashboard" },[m
[31m-            { label: "Verifikasi & Persetujuan", icon: "streamline-sharp:time-lapse-solid", path: "/admin/verifikasi" },[m
[31m-            { label: "Kartu Visitor", icon: "solar:card-recive-outline", path: "/admin/kartu-visitor" },[m
[31m-            { label: "Riwayat Pengembalian", icon: "solar:card-search-broken", path: "/admin/riwayat" },[m
[32m+[m[32m            {[m
[32m+[m[32m              label: "Dashboard",[m
[32m+[m[32m              icon: "streamline-plump:user-pin-remix",[m
[32m+[m[32m              path: "/admin/dashboard",[m
[32m+[m[32m            },[m
[32m+[m[32m            {[m
[32m+[m[32m              label: "Verifikasi & Persetujuan",[m
[32m+[m[32m              icon: "streamline-sharp:time-lapse-solid",[m
[32m+[m[32m              path: "/admin/verifikasi",[m
[32m+[m[32m            },[m
[32m+[m[32m            {[m
[32m+[m[32m              label: "Kartu Visitor",[m
[32m+[m[32m              icon: "solar:card-recive-outline",[m
[32m+[m[32m              path: "/admin/kartu-visitor",[m
[32m+[m[32m            },[m
[32m+[m[32m            {[m
[32m+[m[32m              label: "Riwayat Pengembalian",[m
[32m+[m[32m              icon: "solar:card-search-broken",[m
[32m+[m[32m              path: "/admin/riwayat",[m
[32m+[m[32m            },[m
           ].map((item) => {[m
             const isActive = window.location.pathname === item.path;[m
             return ([m
[36m@@ -361,7 +1127,9 @@[m [mexport default function KartuVisitor() {[m
                       ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]"[m
                       : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"[m
                   } text-[17px]`}[m
[31m-                style={isActive ? { boxShadow: "0 2px 8px rgba(90,90,140,0.07)" } : {}}[m
[32m+[m[32m                style={[m
[32m+[m[32m                  isActive ? { boxShadow: "0 2px 8px rgba(90,90,140,0.07)" } : {}[m
[32m+[m[32m                }[m
               >[m
                 <span className="flex items-center">[m
                   <Icon icon={item.icon} width={32} height={32} />[m
[36m@@ -387,8 +1155,12 @@[m [mexport default function KartuVisitor() {[m
             <span className="font-poppins font-semibold text-[24px] text-[#474646]">[m
               Kartu Visitor[m
             </span>[m
[31m-            {/* Profile section */}[m
[31m-            <div className="relative ml-auto" style={{ minWidth: 200 }}>[m
[32m+[m[32m            {/* Profile + Dropdown Logout */}[m
[32m+[m[32m            <div[m
[32m+[m[32m              className="relative ml-auto"[m
[32m+[m[32m              style={{ minWidth: 200 }}[m
[32m+[m[32m              ref={dropdownRef}[m
[32m+[m[32m            >[m
               <div[m
                 className="absolute top-0 left-0 w-full h-full"[m
                 style={{[m
[36m@@ -396,21 +1168,31 @@[m [mexport default function KartuVisitor() {[m
                   borderRadius: 15,[m
                   zIndex: 0,[m
                 }}[m
[31m-              ></div>[m
[32m+[m[32m              />[m
               <button[m
                 className="relative flex items-center gap-2 px-5 py-2 cursor-pointer z-10 hover:opacity-80 transition-opacity"[m
[31m-                style={{[m
[31m-                  borderRadius: 15,[m
[31m-                  background: "transparent",[m
[31m-                }}[m
[32m+[m[32m                style={{ borderRadius: 15, background: "transparent" }}[m
[32m+[m[32m                onClick={() => setShowDropdown((p) => !p)}[m
               >[m
                 <span className="w-[38px] h-[38px] rounded-full bg-[#6A8BB0] flex items-center justify-center text-white text-[24px] font-poppins font-semibold mr-2">[m
[31m-                  {namaPetugas[0]}[m
[32m+[m[32m                  {(namaPetugas?.[0] || "A").toUpperCase()}[m
                 </span>[m
                 <span className="font-poppins font-medium text-[18px] leading-[36px] text-[#474646]">[m
                   {namaPetugas}[m
                 </span>[m
               </button>[m
[32m+[m
[32m+[m[32m              {showDropdown && ([m
[32m+[m[32m                <div className="absolute top-[62px] right-0 bg-white rounded-[12px] shadow-lg px-6 py-3 z-20 border min-w-[146px] flex items-center gap-3">[m
[32m+[m[32m                  <Icon icon="ic:round-logout" width={34} color="#d61d1d" />[m
[32m+[m[32m                  <button[m
[32m+[m[32m                    className="w-full text-left text-[#474646] font-poppins font-medium text-[18px] py-2 hover:bg-[#F1F2F6] rounded-md transition-colors"[m
[32m+[m[32m                    onClick={handleLogout}[m
[32m+[m[32m                  >[m
[32m+[m[32m                    Log Out[m
[32m+[m[32m                  </button>[m
[32m+[m[32m                </div>[m
[32m+[m[32m              )}[m
             </div>[m
           </div>[m
         </div>[m
[36m@@ -418,7 +1200,6 @@[m [mexport default function KartuVisitor() {[m
         {/* Content Area */}[m
         <div className="w-full max-w-[900px] mx-auto">[m
           <div className="bg-white rounded-[20px] shadow-md px-0 py-0">[m
[31m-            {/* Judul dan tombol export */}[m
             <div className="flex items-center justify-between px-8 pt-8 pb-3">[m
               <span className="font-poppins font-medium text-[18px] text-[#474646]">[m
                 Laporan Penyerahan & Pengembalian Kartu Harian[m
[36m@@ -426,7 +1207,8 @@[m [mexport default function KartuVisitor() {[m
               <button[m
                 className="px-5 py-2 rounded-[8px] font-poppins font-medium text-white"[m
                 style={{[m
[31m-                  background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
[32m+[m[32m                  background:[m
[32m+[m[32m                    "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
                   fontWeight: 500,[m
                 }}[m
                 onClick={exportLaporan}[m
[36m@@ -434,22 +1216,23 @@[m [mexport default function KartuVisitor() {[m
                 Export Laporan[m
               </button>[m
             </div>[m
[32m+[m
             {/* Table */}[m
             <div className="overflow-x-auto pb-8">[m
               <table className="w-full min-w-[730px]">[m
                 <thead>[m
                   <tr style={{ background: "#F4F4F4" }}>[m
                     <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[31m-                      Nama Pemohon[m
[32m+[m[32m                      Nama<br />Pemohon[m
                     </th>[m
                     <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[31m-                      Tanggal Pinjam[m
[32m+[m[32m                      Tanggal<br />Pinjam[m
                     </th>[m
                     <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[31m-                      Tanggal Kembali[m
[32m+[m[32m                      Tanggal<br />Kembali[m
                     </th>[m
                     <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[31m-                      Kondisi Kartu[m
[32m+[m[32m                      Kondisi<br />Kartu[m
                     </th>[m
                     <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
                       Keterangan[m
[36m@@ -461,31 +1244,41 @@[m [mexport default function KartuVisitor() {[m
                 </thead>[m
                 <tbody>[m
                   {dummyData.map((row, idx) => {[m
[31m-                    const statusAuto = getStatusKartu(row.tanggalKembali);[m
[32m+[m[32m                    const statusAuto = getStatusKartu(row.tanggalKembali, {[m
[32m+[m[32m                      isActive: row.isActive,[m
[32m+[m[32m                      aksi: row.aksi,[m
[32m+[m[32m                    });[m
 [m
[31m-                    let kondisiBtn = ([m
[32m+[m[32m                    const kondisiBtn = ([m
                       <button[m
                         className="font-poppins font-medium rounded-[7px]"[m
                         style={{[m
[31m-                          background: kondisiColor[row.kondisi] + "99",[m
[32m+[m[32m                          background:[m
[32m+[m[32m                            (kondisiColor[row.kondisi] || "#ACB3BB") + "99",[m
                           color: "#212529",[m
                           fontWeight: 600,[m
                           minWidth: 90,[m
                           width: 110,[m
                           height: 36,[m
                           display: "inline-block",[m
[32m+[m[32m                          whiteSpace: "nowrap",[m
                         }}[m
                         onClick={() =>[m
                           row.kondisi === "Baik"[m
                             ? openLaporanPopup(idx, false)[m
                             : openLaporanPopup(idx, true)[m
                         }[m
[32m+[m[32m                        title={[m
[32m+[m[32m                          row.kondisi === "Baik"[m
[32m+[m[32m                            ? "Klik untuk ubah/laporkan kondisi"[m
[32m+[m[32m                            : "Hanya baca (sudah dilaporkan)"[m
[32m+[m[32m                        }[m
                       >[m
                         {row.kondisi}[m
                       </button>[m
                     );[m
 [m
[31m-                    let statusBtn = ([m
[32m+[m[32m                    const statusBtn = ([m
                       <span[m
                         className="font-poppins font-medium rounded-[7px] flex items-center justify-center"[m
                         style={{[m
[36m@@ -493,12 +1286,16 @@[m [mexport default function KartuVisitor() {[m
                           color: "#fff",[m
                           fontWeight: 500,[m
                           minWidth: 90,[m
[31m-                          width: 110,[m
[32m+[m[32m                          width: 120,[m
                           height: 36,[m
                           display: "inline-flex",[m
                           alignItems: "center",[m
                           justifyContent: "center",[m
[32m+[m[32m                          whiteSpace: "nowrap",[m
[32m+[m[32m                          fontSize:[m
[32m+[m[32m                            statusAuto === "Belum diambil" ? 12.5 : 15,[m
                         }}[m
[32m+[m[32m                        title={statusAuto}[m
                       >[m
                         {statusAuto}[m
                       </span>[m
[36m@@ -508,7 +1305,7 @@[m [mexport default function KartuVisitor() {[m
                     if (row.aksi === "Belum diambil") {[m
                       aksiBtn = ([m
                         <button[m
[31m-                          className="font-poppins font-medium rounded-[7px] flex items-center justify-center"[m
[32m+[m[32m                          className="font-poppins font-medium rounded-[7px] flex items-center justify-center disabled:opacity-60"[m
                           style={{[m
                             background: aksiColor["Belum diambil"],[m
                             color: "#fff",[m
[36m@@ -520,14 +1317,15 @@[m [mexport default function KartuVisitor() {[m
                             justifyContent: "center",[m
                           }}[m
                           onClick={() => openSerahPopup(idx)}[m
[32m+[m[32m                          disabled={submittingSerah}[m
                         >[m
[31m-                          Serahkan Kartu [m
[32m+[m[32m                          Serahkan Kartu[m
                         </button>[m
                       );[m
                     } else if (row.aksi === "Serahkan Kartu") {[m
                       aksiBtn = ([m
                         <button[m
[31m-                          className="font-poppins font-medium rounded-[7px] flex items-center justify-center"[m
[32m+[m[32m                          className="font-poppins font-medium rounded-[7px] flex items-center justify-center disabled:opacity-60"[m
                           style={{[m
                             background: aksiColor["Serahkan Kartu"],[m
                             color: "#fff",[m
[36m@@ -539,6 +1337,7 @@[m [mexport default function KartuVisitor() {[m
                             justifyContent: "center",[m
                           }}[m
                           onClick={() => openTerimaPopup(idx)}[m
[32m+[m[32m                          disabled={submittingTerima}[m
                         >[m
                           Terima Kartu[m
                         </button>[m
[36m@@ -559,21 +1358,28 @@[m [mexport default function KartuVisitor() {[m
                           }}[m
                           onClick={() => openTerimaPopupRead(idx)}[m
                         >[m
[31m-                         Selesai[m
[32m+[m[32m                          Selesai[m
                         </button>[m
                       );[m
                     }[m
 [m
                     return ([m
[31m-                      <tr key={idx} className={idx % 2 === 0 ? "" : "bg-[#F8F8F8]"}>[m
[32m+[m[32m                      <tr[m
[32m+[m[32m                        key={row.id ?? idx}[m
[32m+[m[32m                        className={idx % 2 === 0 ? "" : "bg-[#F8F8F8]"}[m
[32m+[m[32m                      >[m
                         <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">[m
                           {row.nama}[m
                         </td>[m
                         <td className="py-2 px-2 text-center font-poppins font-medium text-[15px] text-[#474646]">[m
[31m-                          {formatTanggal(row.tanggalPinjam)}[m
[32m+[m[32m                          {row.tanggalPinjam[m
[32m+[m[32m                            ? formatTanggal(row.tanggalPinjam)[m
[32m+[m[32m                            : "-"}[m
                         </td>[m
                         <td className="py-2 px-2 text-center font-poppins font-medium text-[15px] text-[#474646]">[m
[31m-                          {formatTanggal(row.tanggalKembali)}[m
[32m+[m[32m                          {row.tanggalKembali[m
[32m+[m[32m                            ? formatTanggal(row.tanggalKembali)[m
[32m+[m[32m                            : "-"}[m
                         </td>[m
                         <td className="py-2 px-2 text-center">{kondisiBtn}</td>[m
                         <td className="py-2 px-2 text-center">{statusBtn}</td>[m
[36m@@ -587,20 +1393,20 @@[m [mexport default function KartuVisitor() {[m
           </div>[m
         </div>[m
 [m
[31m-        {/* POPUP SERAH */}[m
[32m+[m[32m        {/* Popups */}[m
         <Popup[m
           show={showPopup && popupType === "serah"}[m
           title="Konfirmasi Penyerahan Kartu Visitor"[m
           onClose={() => setShowPopup(false)}[m
         >[m
[31m-          {selectedIdx !== null && ([m
[32m+[m[32m          {selectedRow && ([m
             <>[m
               <DataSection title="Data Penerima Kartu" thick={2}>[m
[31m-                <Row label="Nama Lengkap" value={dummyData[selectedIdx].nama} />[m
[31m-                <Row label="Nomor Pengajuan" value={dummyData[selectedIdx].nomorPengajuan} />[m
[31m-                <Row label="Instansi" value={dummyData[selectedIdx].instansi} />[m
[31m-                <Row label="Tanggal Kunjungan" value={dummyData[selectedIdx].kunjungan} />[m
[31m-                <Row label="Email" value={dummyData[selectedIdx].email} />[m
[32m+[m[32m                <Row label="Nama Lengkap" value={selectedRow.nama} />[m
[32m+[m[32m                <Row label="Nomor Pengajuan" value={selectedRow.nomorPengajuan || "-"} />[m
[32m+[m[32m                <Row label="Instansi" value={selectedRow.instansi || "-"} />[m
[32m+[m[32m                <Row label="Tanggal Kunjungan" value={selectedRow.kunjungan || "-"} />[m
[32m+[m[32m                <Row label="Email" value={selectedRow.email || "-"} />[m
               </DataSection>[m
 [m
               <BoxPetugas label="Petugas" value={namaPetugas} />[m
[36m@@ -614,36 +1420,39 @@[m [mexport default function KartuVisitor() {[m
                   Kembali[m
                 </button>[m
                 <button[m
[31m-                  className="px-7 py-2 rounded-[7px] font-poppins font-medium text-white"[m
[31m-                  style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)" }}[m
[32m+[m[32m                  className="px-7 py-2 rounded-[7px] font-poppins font-medium text-white disabled:opacity-60"[m
[32m+[m[32m                  style={{[m
[32m+[m[32m                    background:[m
[32m+[m[32m                      "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
[32m+[m[32m                  }}[m
                   onClick={handleKonfirmasiSerah}[m
[32m+[m[32m                  disabled={submittingSerah}[m
                 >[m
[31m-                  Konfirmasi[m
[32m+[m[32m                  {submittingSerah ? "Memproses..." : "Konfirmasi"}[m
                 </button>[m
               </div>[m
             </>[m
           )}[m
         </Popup>[m
 [m
[31m-        {/* POPUP TERIMA */}[m
         <Popup[m
           show={showPopup && popupType === "terima"}[m
           title="Konfirmasi Penerimaan Kartu Visitor"[m
           onClose={() => setShowPopup(false)}[m
         >[m
[31m-          {selectedIdx !== null && ([m
[32m+[m[32m          {selectedRow && ([m
             <>[m
               <DataSection title="Data Penerima Kartu" thick={2}>[m
[31m-                <Row label="Nama Lengkap" value={dummyData[selectedIdx].nama} />[m
[31m-                <Row label="Nomor Pengajuan" value={dummyData[selectedIdx].nomorPengajuan} />[m
[31m-                <Row label="Instansi" value={dummyData[selectedIdx].instansi} />[m
[31m-                <Row label="Tanggal Kunjungan" value={dummyData[selectedIdx].kunjungan} />[m
[31m-                <Row label="Email" value={dummyData[selectedIdx].email} />[m
[32m+[m[32m                <Row label="Nama Lengkap" value={selectedRow.nama} />[m
[32m+[m[32m                <Row label="Nomor Pengajuan" value={selectedRow.nomorPengajuan || "-"} />[m
[32m+[m[32m                <Row label="Instansi" value={selectedRow.instansi || "-"} />[m
[32m+[m[32m                <Row label="Tanggal Kunjungan" value={selectedRow.kunjungan || "-"} />[m
[32m+[m[32m                <Row label="Email" value={selectedRow.email || "-"} />[m
               </DataSection>[m
 [m
               <BoxPetugas[m
                 label="Petugas Penyerah"[m
[31m-                value={dummyData[selectedIdx].petugasSerah || namaPetugas}[m
[32m+[m[32m                value={selectedRow.petugasSerah || selectedRow.petugas_serah || namaPetugas}[m
               />[m
               <BoxPetugas label="Petugas Penerima" value={namaPetugas} />[m
 [m
[36m@@ -656,36 +1465,39 @@[m [mexport default function KartuVisitor() {[m
                   Kembali[m
                 </button>[m
                 <button[m
[31m-                  className="px-7 py-2 rounded-[7px] font-poppins font-medium text-white"[m
[31m-                  style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)" }}[m
[32m+[m[32m                  className="px-7 py-2 rounded-[7px] font-poppins font-medium text-white disabled:opacity-60"[m
[32m+[m[32m                  style={{[m
[32m+[m[32m                    background:[m
[32m+[m[32m                      "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
[32m+[m[32m                  }}[m
                   onClick={handleKonfirmasiTerima}[m
[32m+[m[32m                  disabled={submittingTerima}[m
                 >[m
[31m-                  Konfirmasi[m
[32m+[m[32m                  {submittingTerima ? "Memproses..." : "Konfirmasi"}[m
                 </button>[m
               </div>[m
             </>[m
           )}[m
         </Popup>[m
 [m
[31m-        {/* POPUP TERIMA (READ ONLY) */}[m
         <Popup[m
           show={showPopup && popupType === "terima-read"}[m
           title="Konfirmasi Penerimaan Kartu Visitor"[m
           onClose={() => setShowPopup(false)}[m
         >[m
[31m-          {selectedIdx !== null && ([m
[32m+[m[32m          {selectedRow && ([m
             <>[m
               <DataSection title="Data Penerima Kartu" thick={2}>[m
[31m-                <Row label="Nama Lengkap" value={dummyData[selectedIdx].nama} />[m
[31m-                <Row label="Nomor Pengajuan" value={dummyData[selectedIdx].nomorPengajuan} />[m
[31m-                <Row label="Instansi" value={dummyData[selectedIdx].instansi} />[m
[31m-                <Row label="Tanggal Kunjungan" value={dummyData[selectedIdx].kunjungan} />[m
[31m-                <Row label="Email" value={dummyData[selectedIdx].email} />[m
[32m+[m[32m                <Row label="Nama Lengkap" value={selectedRow.nama} />[m
[32m+[m[32m                <Row label="Nomor Pengajuan" value={selectedRow.nomorPengajuan || "-"} />[m
[32m+[m[32m                <Row label="Instansi" value={selectedRow.instansi || "-"} />[m
[32m+[m[32m                <Row label="Tanggal Kunjungan" value={selectedRow.kunjungan || "-"} />[m
[32m+[m[32m                <Row label="Email" value={selectedRow.email || "-"} />[m
               </DataSection>[m
 [m
               <BoxPetugas[m
                 label="Petugas Penyerah"[m
[31m-                value={dummyData[selectedIdx].petugasSerah || namaPetugas}[m
[32m+[m[32m                value={selectedRow.petugasSerah || selectedRow.petugas_serah || namaPetugas}[m
               />[m
               <BoxPetugas label="Petugas Penerima" value={namaPetugas} />[m
 [m
[36m@@ -702,45 +1514,43 @@[m [mexport default function KartuVisitor() {[m
           )}[m
         </Popup>[m
 [m
[31m-        {/* POPUP LAPORAN */}[m
         <Popup[m
           show={showPopup && popupType === "laporan"}[m
           title="Laporan Kartu Rusak/Hilang"[m
           onClose={() => setShowPopup(false)}[m
         >[m
[31m-          {selectedIdx !== null && ([m
[31m-            <div[m
[31m-              style={{[m
[31m-                maxHeight: 400,[m
[31m-                overflowY: "auto",[m
[31m-                paddingRight: 4,[m
[31m-                // padding bottom to avoid button overlap[m
[31m-              }}[m
[31m-              className="custom-scrollbar"[m
[31m-            >[m
[32m+[m[32m          {selectedRow && ([m
[32m+[m[32m            <>[m
               <DataSection title="Laporan Kartu" thick={3}>[m
[31m-                <Row label="Nama Lengkap" value={dummyData[selectedIdx].nama} />[m
[31m-                <Row label="Instansi" value={dummyData[selectedIdx].instansi} />[m
[31m-                <Row label="Tanggal Kunjungan" value={formatTanggal(dummyData[selectedIdx].tanggalPinjam)} />[m
[31m-                <div className="py-2 flex gap-2 text-[14.5px]"[m
[31m-                     style={{ borderBottom: "1px solid rgba(208,205,205,0.56)" }}>[m
[32m+[m[32m                <Row label="Nama Lengkap" value={selectedRow.nama} />[m
[32m+[m[32m                <Row label="Instansi" value={selectedRow.instansi || "-"} />[m
[32m+[m[32m                <Row label="Tanggal Kunjungan" value={formatTanggal(selectedRow.tanggalPinjam)} />[m
[32m+[m[32m                <div[m
[32m+[m[32m                  className="py-2 flex gap-2 text-[14.5px]"[m
[32m+[m[32m                  style={{[m
[32m+[m[32m                    borderBottom: "1px solid rgba(208,205,205,0.56)",[m
[32m+[m[32m                  }}[m
[32m+[m[32m                >[m
                   <div className="min-w-[150px] text-[#474646] font-poppins font-medium">[m
                     Kondisi Kartu[m
                   </div>[m
                   <div className="text-[#474646] font-poppins font-medium">[m
                     :{" "}[m
                     {readonlyLaporan ? ([m
[31m-                      <span>{dummyData[selectedIdx].kondisi}</span>[m
[32m+[m[32m                      <span>{selectedRow.kondisi}</span>[m
                     ) : ([m
                       <select[m
                         className="rounded-[7px] px-3 py-2 font-poppins"[m
                         style={{[m
                           minWidth: 110,[m
                           background: "#F7F7F7",[m
[31m-                          border: "1px solid rgba(208,205,205,0.56)",[m
[32m+[m[32m                          border:[m
[32m+[m[32m                            "1px solid rgba(208,205,205,0.56)",[m
                         }}[m
                         value={laporanKondisi}[m
[31m-                        onChange={(e) => setLaporanKondisi(e.target.value)}[m
[32m+[m[32m                        onChange={(e) =>[m
[32m+[m[32m                          setLaporanKondisi(e.target.value)[m
[32m+[m[32m                        }[m
                       >[m
                         <option value="Baik">Baik</option>[m
                         <option value="Hilang">Hilang</option>[m
[36m@@ -752,7 +1562,10 @@[m [mexport default function KartuVisitor() {[m
                 <Row label="Petugas" value={namaPetugas} />[m
               </DataSection>[m
 [m
[31m-              <div className="mb-2 font-poppins font-medium" style={{ color: "#474646" }}>[m
[32m+[m[32m              <div[m
[32m+[m[32m                className="mb-2 font-poppins font-medium"[m
[32m+[m[32m                style={{ color: "#474646" }}[m
[32m+[m[32m              >[m
                 Alasan :[m
               </div>[m
               <textarea[m
[36m@@ -766,7 +1579,10 @@[m [mexport default function KartuVisitor() {[m
                 onChange={(e) => setLaporanAlasan(e.target.value)}[m
                 disabled={readonlyLaporan}[m
               />[m
[31m-              <div className="mb-2 font-poppins font-medium" style={{ color: "#474646" }}>[m
[32m+[m[32m              <div[m
[32m+[m[32m                className="mb-2 font-poppins font-medium"[m
[32m+[m[32m                style={{ color: "#474646" }}[m
[32m+[m[32m              >[m
                 Penanganan :[m
               </div>[m
               <textarea[m
[36m@@ -781,7 +1597,7 @@[m [mexport default function KartuVisitor() {[m
                 disabled={readonlyLaporan}[m
               />[m
 [m
[31m-              <div className="flex justify-end gap-3 mt-3 pb-1">[m
[32m+[m[32m              <div className="flex justify-end gap-3 mt-3">[m
                 <button[m
                   className="px-7 py-2 rounded-[7px] font-poppins font-medium text-white"[m
                   style={{ background: "#ACB3BB" }}[m
[36m@@ -791,35 +1607,28 @@[m [mexport default function KartuVisitor() {[m
                 </button>[m
                 {!readonlyLaporan && ([m
                   <button[m
[31m-                    className="px-7 py-2 rounded-[7px] font-poppins font-medium text-white"[m
[31m-                    style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)" }}[m
[32m+[m[32m                    className="px-7 py-2 rounded-[7px] font-poppins font-medium text-white disabled:opacity-60"[m
[32m+[m[32m                    style={{[m
[32m+[m[32m                      background:[m
[32m+[m[32m                        "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
[32m+[m[32m                    }}[m
                     onClick={handleSimpanLaporan}[m
[32m+[m[32m                    disabled={submittingLaporan}[m
                   >[m
[31m-                    Simpan[m
[32m+[m[32m                    {submittingLaporan ? "Menyimpan..." : "Simpan"}[m
                   </button>[m
                 )}[m
               </div>[m
[31m-            </div>[m
[32m+[m[32m            </>[m
           )}[m
         </Popup>[m
       </main>[m
[32m+[m
       <style>{`[m
         @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&display=swap');[m
         .font-poppins { font-family: 'Poppins', sans-serif; }[m
         th, td { vertical-align: middle !important; }[m
[31m-        /* Custom scrollbar for laporan popup */[m
[31m-        .custom-scrollbar::-webkit-scrollbar {[m
[31m-          width: 8px;[m
[31m-        }[m
[31m-        .custom-scrollbar::-webkit-scrollbar-thumb {[m
[31m-          background: #d6dae2;[m
[31m-          border-radius: 6px;[m
[31m-        }[m
[31m-        .custom-scrollbar {[m
[31m-          scrollbar-width: thin;[m
[31m-          scrollbar-color: #d6dae2 #f4f4f4;[m
[31m-        }[m
       `}</style>[m
     </div>[m
   );[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
[1mdiff --git a/src/admin/RiwayatPengembalian.jsx b/src/admin/RiwayatPengembalian.jsx[m
[1mindex aa698d4..8a09a01 100644[m
[1m--- a/src/admin/RiwayatPengembalian.jsx[m
[1m+++ b/src/admin/RiwayatPengembalian.jsx[m
[36m@@ -1,363 +1,910 @@[m
[31m-import React, { useState, useRef } from "react";[m
[32m+[m[32m// src/admin/RiwayatPengembalian.jsx[m
[32m+[m[32mimport React, { useState, useRef, useEffect } from "react";[m
 import { useNavigate, useLocation } from "react-router-dom";[m
 import { Icon } from "@iconify/react";[m
 import kaiLogo from "../assets/KAI-logo.png";[m
[32m+[m[32mimport {[m
[32m+[m[32m  getReturnedCards,[m
[32m+[m[32m  exportCardCondition,[m
[32m+[m[32m  downloadBlob,[m
[32m+[m[32m  fetchDocumentBlob,[m
[32m+[m[32m  filenameFromHeaders,[m
[32m+[m[32m  ORIGIN,[m
[32m+[m[32m  getVerificationDetail,[m
[32m+[m[32m} from "../api";[m
 [m
[31m-const dummyData = [[m
[31m-  {[m
[31m-    nama: "Azida Kautsar",[m
[31m-    tanggalPinjam: "2025-08-04",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Baik",[m
[31m-    keterangan: "Selesai",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Milano Sitanggang",[m
[31m-    tanggalPinjam: "2025-08-05",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Hilang",[m
[31m-    keterangan: "Selesai",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Azka Mauladina",[m
[31m-    tanggalPinjam: "2025-08-03",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Hilang",[m
[31m-    keterangan: "Selesai",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Yudhita Meika",[m
[31m-    tanggalPinjam: "2025-08-06",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Rusak",[m
[31m-    keterangan: "Selesai",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Ahmad Arfan",[m
[31m-    tanggalPinjam: "2025-08-07",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Baik",[m
[31m-    keterangan: "Selesai",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Gading Subagio",[m
[31m-    tanggalPinjam: "2025-08-08",[m
[31m-    tanggalKembali: "2025-08-08",[m
[31m-    kondisi: "Rusak",[m
[31m-    keterangan: "Selesai",[m
[31m-  },[m
[31m-];[m
[31m-[m
[32m+[m[32m/* ===== Utils ===== */[m
 function formatTanggal(str) {[m
   const months = [[m
[31m-    "Januari", "Februari", "Maret", "April", "Mei", "Juni",[m
[31m-    "Juli", "Agustus", "September", "Oktober", "November", "Desember"[m
[32m+[m[32m    "Januari","Februari","Maret","April","Mei","Juni",[m
[32m+[m[32m    "Juli","Agustus","September","Oktober","November","Desember"[m
   ];[m
[32m+[m[32m  if (!str) return "-";[m
   const d = new Date(str);[m
[31m-  if (isNaN(d)) return str;[m
[32m+[m[32m  if (isNaN(d)) return "-";[m
   return `${String(d.getDate()).padStart(2, "0")} ${months[d.getMonth()]} ${d.getFullYear()}`;[m
 }[m
[32m+[m[32mconst val = (v, f = "-") => (v == null || v === "" ? f : String(v));[m
[32m+[m
[32m+[m[32mfunction normalizeCondition(c) {[m
[32m+[m[32m  const raw = (c ?? "").toString().trim().toLowerCase();[m
[32m+[m[32m  if (!raw) return "Baik";[m
[32m+[m[32m  if (raw === "1" || raw.includes("lost") || raw.includes("hilang")) return "Hilang";[m
[32m+[m[32m  if (raw === "2" || raw.includes("damaged") || raw.includes("rusak") || raw.includes("broken")) return "Rusak";[m
[32m+[m[32m  if (raw.includes("baik") || raw.includes("good") || raw === "0") return "Baik";[m
[32m+[m[32m  return "Baik";[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mconst kondisiBadge = { Baik: "#28A745", Hilang: "#DC3545", Rusak: "#FFC107" };[m
[32m+[m
[32m+[m[32mfunction toFileURL(v) {[m
[32m+[m[32m  if (!v) return null;[m
[32m+[m[32m  if (/^https?:\/\//i.test(v)) return v;[m
[32m+[m[32m  const clean = String(v).replace(/^\/+/, "");[m
[32m+[m[32m  const finalPath = clean.startsWith("storage/") || clean.startsWith("uploads/") ? clean : `storage/${clean}`;[m
[32m+[m[32m  return `${ORIGIN}/${finalPath}`;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// treat "-", "â€”", "â€“", "" as empty  <-- TAMBAHAN[m
[32m+[m[32mconst isBlank = (v) =>[m
[32m+[m[32m  v == null || String(v).trim() === "" || ["-", "â€”", "â€“"].includes(String(v).trim());[m
[32m+[m[32mconst pickNonBlank = (...vals) => vals.find((v) => !isBlank(v));[m
[32m+[m
[32m+[m[32m/* ====== PATCH & META CACHE ====== */[m
[32m+[m[32mconst PATCH_KEY = "riwayat:patches";[m
[32m+[m[32mconst META_CACHE_KEY = "visitorCardMetaCache";[m
[32m+[m
[32m+[m[32mfunction loadPatches() {[m
[32m+[m[32m  try { const raw = localStorage.getItem(PATCH_KEY); return raw ? JSON.parse(raw) : {}; } catch { return {}; }[m
[32m+[m[32m}[m
[32m+[m[32mfunction applyPatchToRows(rows) {[m
[32m+[m[32m  const map = loadPatches();[m
[32m+[m[32m  if (!map || typeof map !== "object") return rows;[m
[32m+[m[32m  return rows.map((r) => {[m
[32m+[m[32m    const ref = r.reference || r.nomorPengajuan;[m
[32m+[m[32m    const patched = ref ? map[String(ref)] : null;[m
[32m+[m[32m    return patched ? { ...r, kondisi: patched } : r;[m
[32m+[m[32m  });[m
[32m+[m[32m}[m
[32m+[m[32mfunction loadMetaCache() {[m
[32m+[m[32m  try { return JSON.parse(localStorage.getItem(META_CACHE_KEY) || "{}"); } catch { return {}; }[m
[32m+[m[32m}[m
[32m+[m[32mfunction getMetaForRow(row) {[m
[32m+[m[32m  const cache = loadMetaCache();[m
[32m+[m[32m  const keys = [[m
[32m+[m[32m    row?.reference,[m
[32m+[m[32m    row?.nomorPengajuan,[m
[32m+[m[32m    row?.key,[m
[32m+[m[32m    row?.raw?.card_transaction_id,[m
[32m+[m[32m    row?.raw?.transaction_id,[m
[32m+[m[32m    row?.raw?.visitor_card_id[m
[32m+[m[32m  ].filter(Boolean).map(String);[m
[32m+[m[32m  for (const k of keys) {[m
[32m+[m[32m    if (cache[k]) {[m
[32m+[m[32m      return { kondisi: cache[k].kondisi, alasan: cache[k].alasan, penanganan: cache[k].penanganan };[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m[32m  return { kondisi: row?.kondisi || "Baik", alasan: "", penanganan: "" };[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* === INSTANSI CACHE (untuk enrichment cepat) === */[m
[32m+[m[32mconst INSTANSI_CACHE_KEY = "riwayat:instansiCache";[m
[32m+[m[32mfunction loadInstansiCache() {[m
[32m+[m[32m  try { return JSON.parse(localStorage.getItem(INSTANSI_CACHE_KEY) || "{}"); } catch { return {}; }[m
[32m+[m[32m}[m
[32m+[m[32mfunction saveInstansiToCache(key, val) {[m
[32m+[m[32m  try {[m
[32m+[m[32m    const cur = loadInstansiCache();[m
[32m+[m[32m    cur[key] = val;[m
[32m+[m[32m    localStorage.setItem(INSTANSI_CACHE_KEY, JSON.stringify(cur));[m
[32m+[m[32m  } catch {}[m
[32m+[m[32m}[m
[32m+[m[32mfunction getInstansiFromCache(key) {[m
[32m+[m[32m  const m = loadInstansiCache();[m
[32m+[m[32m  return m?.[key];[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* ==== Ambil Instansi dari berbagai kemungkinan field ==== */[m
[32m+[m[32mfunction resolveInstansi(x) {[m
[32m+[m[32m  const n = (obj, ...paths) => {[m
[32m+[m[32m    for (const p of paths) { if (!obj) return undefined; obj = obj[p]; }[m
[32m+[m[32m    return obj;[m
[32m+[m[32m  };[m
[32m+[m[32m  const cand =[m
[32m+[m[32m    x?.instansi ||[m
[32m+[m[32m    x?.instansi_name ||[m
[32m+[m[32m    x?.organization ||[m
[32m+[m[32m    x?.organization_name ||[m
[32m+[m[32m    x?.company ||[m
[32m+[m[32m    x?.company_name ||[m
[32m+[m[32m    x?.institution ||[m
[32m+[m[32m    x?.institution_name ||[m
[32m+[m[32m    x?.agency ||[m
[32m+[m[32m    x?.agency_name ||[m
[32m+[m[32m    x?.applicant_company ||[m
[32m+[m[32m    x?.applicant_organization ||[m
[32m+[m[32m    x?.borrower_company ||[m
[32m+[m[32m    x?.visitor_company ||[m
[32m+[m[32m    // nested: application / transaction / card_transaction / visitor / user / visit / visitor_card / card[m
[32m+[m[32m    n(x, "application", "instansi") ||[m
[32m+[m[32m    n(x, "application", "organization") ||[m
[32m+[m[32m    n(x, "application", "organization_name") ||[m
[32m+[m[32m    n(x, "application", "company") ||[m
[32m+[m[32m    n(x, "application", "company_name") ||[m
[32m+[m[32m    n(x, "transaction", "company") ||[m
[32m+[m[32m    n(x, "transaction", "company_name") ||[m
[32m+[m[32m    n(x, "card_transaction", "company") ||[m
[32m+[m[32m    n(x, "card_transaction", "company_name") ||[m
[32m+[m[32m    n(x, "card_transaction", "applicant_company") ||[m
[32m+[m[32m    n(x, "visitor", "company") ||[m
[32m+[m[32m    n(x, "visitor", "company_name") ||[m
[32m+[m[32m    n(x, "user", "company") ||[m
[32m+[m[32m    n(x, "user", "company_name") ||[m
[32m+[m[32m    n(x, "visit", "company") ||[m
[32m+[m[32m    n(x, "visit", "company_name") ||[m
[32m+[m[32m    n(x, "visitor_card", "company") ||[m
[32m+[m[32m    n(x, "visitor_card", "company_name") ||[m
[32m+[m[32m    n(x, "card", "company") ||[m
[32m+[m[32m    n(x, "card", "company_name");[m
[32m+[m[32m  return cand ?? "-";[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* ===== Small Popup (reusable) ===== */[m
[32m+[m[32mfunction Popup({ show, onClose, title, children }) {[m
[32m+[m[32m  if (!show) return null;[m
[32m+[m[32m  return ([m
[32m+[m[32m    <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-20" onClick={onClose}>[m
[32m+[m[32m      <div className="bg-white rounded-[14px] p-0 min-w-[380px] max-w-[600px] w-[97%] shadow-lg relative" onClick={(e) => e.stopPropagation()}>[m
[32m+[m[32m        <div className="flex items-center justify-between px-6 py-4 rounded-t-[14px]" style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)" }}>[m
[32m+[m[32m          <div className="flex items-center gap-2">[m
[32m+[m[32m            <div className="w-9 h-9 rounded-full bg-white/15 flex items-center justify-center">[m
[32m+[m[32m              <Icon icon="material-symbols:id-card-rounded" width={22} color="#fff" />[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <span className="font-poppins font-semibold text-white text-[18px]">{title}</span>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <button onClick={onClose} className="ml-2 text-white text-[22px] font-bold hover:opacity-80 transition">Ã—</button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div className="px-7 py-7">{children}</div>[m
[32m+[m[32m      </div>[m
[32m+[m[32m    </div>[m
[32m+[m[32m  );[m
[32m+[m[32m}[m
 [m
[32m+[m[32m/* ===== Component ===== */[m
 export default function RiwayatPengembalian() {[m
   const [showDropdown, setShowDropdown] = useState(false);[m
[32m+[m[32m  const adminName = localStorage.getItem("adminName") || "Admin";[m
   const [query, setQuery] = useState("");[m
[32m+[m[32m  const [rows, setRows] = useState([]);[m
[32m+[m[32m  const [loading, setLoading] = useState(true);[m
[32m+[m[32m  const [err, setErr] = useState("");[m
[32m+[m
[32m+[m[32m  // detail modal states[m
[32m+[m[32m  const [detailOpen, setDetailOpen] = useState(false);[m
[32m+[m[32m  const [detailLoading, setDetailLoading] = useState(false);[m
[32m+[m[32m  const [detailErr, setDetailErr] = useState("");[m
[32m+[m[32m  const [detailData, setDetailData] = useState(null);[m
[32m+[m
[32m+[m[32m  // laporan (read-only) untuk Rusak/Hilang[m
[32m+[m[32m  const [laporanOpen, setLaporanOpen] = useState(false);[m
[32m+[m[32m  const [laporanData, setLaporanData] = useState({[m
[32m+[m[32m    nama: "-",[m
[32m+[m[32m    instansi: "-",[m
[32m+[m[32m    tanggal: null,[m
[32m+[m[32m    kondisi: "Baik",[m
[32m+[m[32m    alasan: "",[m
[32m+[m[32m    penanganan: ""[m
[32m+[m[32m  });[m
[32m+[m
   const dropdownRef = useRef();[m
   const navigate = useNavigate();[m
   const location = useLocation();[m
[31m-  const adminName = "Admin rafi";[m
[31m-[m
[31m-  const menuItems = [[m
[31m-    {[m
[31m-      label: "Dashboard",[m
[31m-      icon: "streamline-plump:user-pin-remix",[m
[31m-      path: "/admin/dashboard",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Verifikasi & Persetujuan",[m
[31m-      icon: "streamline-sharp:time-lapse-solid",[m
[31m-      path: "/admin/verifikasi",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Kartu Visitor",[m
[31m-      icon: "solar:card-recive-outline",[m
[31m-      path: "/admin/kartu-visitor",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Riwayat Pengembalian",[m
[31m-      icon: "solar:card-search-broken",[m
[31m-      path: "/admin/riwayat",[m
[31m-    },[m
[31m-  ];[m
 [m
[31m-  const handleMenuClick = (path) => {[m
[31m-    navigate(path);[m
[31m-  };[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    function outside(e) {[m
[32m+[m[32m      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setShowDropdown(false);[m
[32m+[m[32m    }[m
[32m+[m[32m    document.addEventListener("mousedown", outside);[m
[32m+[m[32m    return () => document.removeEventListener("mousedown", outside);[m
[32m+[m[32m  }, []);[m
 [m
   const handleLogout = () => {[m
[32m+[m[32m    localStorage.removeItem("token");[m
[32m+[m[32m    localStorage.removeItem("adminName");[m
     navigate("/admin");[m
[31m-    setShowDropdown(false);[m
   };[m
 [m
[31m-  React.useEffect(() => {[m
[31m-    function handleClickOutside(event) {[m
[31m-      if ([m
[31m-        dropdownRef.current &&[m
[31m-        !dropdownRef.current.contains(event.target)[m
[31m-      ) {[m
[31m-        setShowDropdown(false);[m
[31m-      }[m
[32m+[m[32m  /* ---- LOAD DATA ---- */[m
[32m+[m[32m  const load = async () => {[m
[32m+[m[32m    setLoading(true);[m
[32m+[m[32m    setErr("");[m
[32m+[m[32m    try {[m
[32m+[m[32m      const res = await getReturnedCards();[m
[32m+[m[32m      const list = Array.isArray(res?.data) ? res.data : res?.data?.data || [];[m
[32m+[m
[32m+[m[32m      const mapped = list.map((x, i) => {[m
[32m+[m[32m        const n = (obj, ...paths) => {[m
[32m+[m[32m          for (const p of paths) { if (!obj) return undefined; obj = obj[p]; }[m
[32m+[m[32m          return obj;[m
[32m+[m[32m        };[m
[32m+[m
[32m+[m[32m        const nama =[m
[32m+[m[32m          x.applicant_name || x.borrower_name || x.full_name || x.name || x.visitor_name || x.user_name ||[m
[32m+[m[32m          n(x, "user", "name") || n(x, "visitor", "full_name") || n(x, "visitor_card", "full_name") ||[m
[32m+[m[32m          n(x, "card_transaction", "applicant_name") || n(x, "transaction", "applicant_name") ||[m
[32m+[m[32m          n(x, "card", "visitor_name") || n(x, "application", "applicant_name") || "-";[m
[32m+[m
[32m+[m[32m        const tPinjam =[m
[32m+[m[32m          x.issued_at || x.start_date || x.borrowed_at || x.created_at || x.date || n(x, "card_transaction", "issued_at") || null;[m
[32m+[m
[32m+[m[32m        const tKembali =[m
[32m+[m[32m          x.returned_at || x.actual_return_date || x.actual_returned_at || x.card_returned_at || x.completed_at ||[m
[32m+[m[32m          x.end_date || n(x, "card_transaction", "returned_at") || x.updated_at || null;[m
[32m+[m
[32m+[m[32m        const kondisiRaw =[m
[32m+[m[32m          x.kondisi || x.card_condition || x.condition || x.transaction_condition ||[m
[32m+[m[32m          n(x, "card_transaction", "return_condition") || n(x, "card_transaction", "card_condition") || "";[m
[32m+[m[32m        const kondisi = normalizeCondition(kondisiRaw);[m
[32m+[m
[32m+[m[32m        const reference =[m
[32m+[m[32m          x.reference_number || x.reference || x.ref_no || x.ref ||[m
[32m+[m[32m          n(x, "application", "reference_number") || n(x, "visit", "reference_number") ||[m
[32m+[m[32m          n(x, "card_transaction", "reference_number") || n(x, "transaction", "reference_number") ||[m
[32m+[m[32m          n(x, "visitor_card", "reference_number") || null;[m
[32m+[m
[32m+[m[32m        const nomorPengajuan =[m
[32m+[m[32m          reference || x.reference_number || n(x, "visitor_card", "reference_number") ||[m
[32m+[m[32m          n(x, "card_transaction", "reference_number") || null;[m
[32m+[m
[32m+[m[32m        // Mapping petugas: HAPUS default "â€”", biarkan undefined bila kosong[m
[32m+[m[32m        const petugasPenerima =[m
[32m+[m[32m          x.petugasPenerima || x.petugas_penerima || x.returned_by_name || x.returned_by ||[m
[32m+[m[32m          x.received_by_name || x.receiver_name || n(x, "card_transaction", "returned_by_name") ||[m
[32m+[m[32m          n(x, "card_transaction", "received_by_name") || n(x, "visitor_card", "last_received_by") ||[m
[32m+[m[32m          localStorage.getItem("namaPetugas") || undefined;[m
[32m+[m
[32m+[m[32m        const petugasPenyerah =[m
[32m+[m[32m          x.petugasPenyerah || x.petugas_penyerah || x.petugasSerah || x.petugas_serah ||[m
[32m+[m[32m          x.issued_by_name || x.issued_by || x.performed_by_name || x.performed_by ||[m
[32m+[m[32m          n(x, "card_transaction", "issued_by_name") || n(x, "visitor_card", "last_issued_by") ||[m
[32m+[m[32m          localStorage.getItem("namaPetugas") || undefined;[m
[32m+[m
[32m+[m[32m        const key = x.id ?? n(x, "card_transaction", "id") ?? n(x, "transaction", "id") ?? i;[m
[32m+[m
[32m+[m[32m        return {[m
[32m+[m[32m          key,[m
[32m+[m[32m          nama: val(nama),[m
[32m+[m[32m          instansi: val(resolveInstansi(x), "-"),[m
[32m+[m[32m          tanggalPinjam: tPinjam,[m
[32m+[m[32m          tanggalKembali: tKembali,[m
[32m+[m[32m          kondisi,[m
[32m+[m[32m          kondisiRaw,[m
[32m+[m[32m          keterangan: "Selesai",[m
[32m+[m[32m          reference,[m
[32m+[m[32m          nomorPengajuan,[m
[32m+[m[32m          petugasPenerima,[m
[32m+[m[32m          tanggalTerima: tPinjam,[m
[32m+[m[32m          petugasPenyerah,[m
[32m+[m[32m          tanggalSerah: tKembali,[m
[32m+[m[32m          raw: x,[m
[32m+[m[32m        };[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      // Render cepat dulu[m
[32m+[m[32m      setRows(applyPatchToRows(mapped));[m
[32m+[m
[32m+[m[32m      // ===== Enrichment instansi (eager) =====[m
[32m+[m[32m      (async () => {[m
[32m+[m[32m        // kandidat baris yang masih butuh instansi[m
[32m+[m[32m        const need = mapped.filter(r => (!r.instansi || r.instansi === "-") && (r.reference || r.nomorPengajuan));[m
[32m+[m
[32m+[m[32m        // 1) isi dari cache kalau ada[m
[32m+[m[32m        need.forEach(r => {[m
[32m+[m[32m          const ref = r.reference || r.nomorPengajuan;[m
[32m+[m[32m          const cached = ref ? getInstansiFromCache(String(ref)) : null;[m
[32m+[m[32m          if (cached) {[m
[32m+[m[32m            setRows(prev => prev.map(p => ((p.reference || p.nomorPengajuan) === ref ? { ...p, instansi: cached } : p)));[m
[32m+[m[32m          }[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        // 2) fetch detail untuk sisanya (dengan limiter sederhana)[m
[32m+[m[32m        const toFetch = need.filter(r => {[m
[32m+[m[32m          const ref = r.reference || r.nomorPengajuan;[m
[32m+[m[32m          return ref && !getInstansiFromCache(String(ref));[m
[32m+[m[32m        });[m
[32m+[m
[32m+[m[32m        const maxConcurrent = 5;[m
[32m+[m[32m        let i = 0;[m
[32m+[m[32m        async function worker() {[m
[32m+[m[32m          while (i < toFetch.length) {[m
[32m+[m[32m            const r = toFetch[i++];[m
[32m+[m[32m            const ref = r.reference || r.nomorPengajuan;[m
[32m+[m[32m            try {[m
[32m+[m[32m              const res = await getVerificationDetail({ reference_number: ref, reference: ref });[m
[32m+[m[32m              const raw = res?.data?.data || res?.data || {};[m
[32m+[m[32m              const detInstansi = resolveInstansi(raw);[m
[32m+[m[32m              if (detInstansi && detInstansi !== "-") {[m
[32m+[m[32m                saveInstansiToCache(String(ref), detInstansi);[m
[32m+[m[32m                setRows(prev => prev.map(p =>[m
[32m+[m[32m                  ((p.reference || p.nomorPengajuan) === ref ? { ...p, instansi: detInstansi } : p)[m
[32m+[m[32m                ));[m
[32m+[m[32m              }[m
[32m+[m[32m            } catch { /* abaikan error per-item */ }[m
[32m+[m[32m          }[m
[32m+[m[32m        }[m
[32m+[m[32m        await Promise.all([...Array(Math.min(maxConcurrent, toFetch.length))].map(worker));[m
[32m+[m[32m      })();[m
[32m+[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      setErr(e?.response?.data?.message || e?.message || "Gagal memuat riwayat pengembalian");[m
[32m+[m[32m      setRows([]);[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      setLoading(false);[m
     }[m
[31m-    document.addEventListener("mousedown", handleClickOutside);[m
[31m-    return () => document.removeEventListener("mousedown", handleClickOutside);[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    load();[m
[32m+[m[32m    const refresh = () => load();[m
[32m+[m[32m    window.addEventListener("riwayat:refresh", refresh);[m
[32m+[m[32m    window.addEventListener("dashboard:changed", refresh);[m
[32m+[m
[32m+[m[32m    const onPatch = (e) => {[m
[32m+[m[32m      const { reference, kondisi } = e?.detail || {};[m
[32m+[m[32m      if (!reference || !kondisi) return;[m
[32m+[m[32m      setRows((prev) =>[m
[32m+[m[32m        prev.map((r) => {[m
[32m+[m[32m          const ref = r.reference || r.nomorPengajuan;[m
[32m+[m[32m          return String(ref) === String(reference) ? { ...r, kondisi } : r;[m
[32m+[m[32m        })[m
[32m+[m[32m      );[m
[32m+[m[32m    };[m
[32m+[m[32m    window.addEventListener("riwayat:patch", onPatch);[m
[32m+[m
[32m+[m[32m    let ch = null;[m
[32m+[m[32m    try {[m
[32m+[m[32m      if (typeof BroadcastChannel !== "undefined") {[m
[32m+[m[32m        ch = new BroadcastChannel("riwayat-channel");[m
[32m+[m[32m        ch.onmessage = (msg) => {[m
[32m+[m[32m          if (msg?.data?.type === "patch") {[m
[32m+[m[32m            const { reference, kondisi } = msg.data;[m
[32m+[m[32m            if (!reference || !kondisi) return;[m
[32m+[m[32m            setRows((prev) =>[m
[32m+[m[32m              prev.map((r) => {[m
[32m+[m[32m                const ref = r.reference || r.nomorPengajuan;[m
[32m+[m[32m                return String(ref) === String(reference) ? { ...r, kondisi } : r;[m
[32m+[m[32m              })[m
[32m+[m[32m            );[m
[32m+[m[32m          }[m
[32m+[m[32m        };[m
[32m+[m[32m      }[m
[32m+[m[32m    } catch {}[m
[32m+[m
[32m+[m[32m    return () => {[m
[32m+[m[32m      window.removeEventListener("riwayat:refresh", refresh);[m
[32m+[m[32m      window.removeEventListener("dashboard:changed", refresh);[m
[32m+[m[32m      window.removeEventListener("riwayat:patch", onPatch);[m
[32m+[m[32m      try { ch && ch.close(); } catch {}[m
[32m+[m[32m    };[m
   }, []);[m
 [m
[31m-  // Filter berdasarkan nama[m
[31m-  const filteredData = dummyData.filter((row) =>[m
[31m-    row.nama.toLowerCase().includes(query.toLowerCase())[m
[32m+[m[32m  const filtered = rows.filter((r) =>[m
[32m+[m[32m    (r.nama || "").toLowerCase().includes(query.trim().toLowerCase())[m
   );[m
 [m
[31m-  // Export dummy laporan[m
[31m-  const exportLaporan = () => {[m
[31m-    const header = [[m
[31m-      "Nama Pemohon",[m
[31m-      "Tanggal Pinjam",[m
[31m-      "Tanggal Kembali",[m
[31m-      "Kondisi Kartu",[m
[31m-      "Keterangan",[m
[31m-    ].join(",");[m
[31m-    const rows = filteredData.map(d =>[m
[31m-      [[m
[31m-        d.nama,[m
[31m-        formatTanggal(d.tanggalPinjam),[m
[31m-        formatTanggal(d.tanggalKembali),[m
[31m-        d.kondisi,[m
[31m-        d.keterangan,[m
[31m-      ].join(",")[m
[32m+[m[32m  /* ---- Export ---- */[m
[32m+[m[32m  const exportLaporan = async () => {[m
[32m+[m[32m    try {[m
[32m+[m[32m      const resp = await exportCardCondition();[m
[32m+[m[32m      downloadBlob(resp.data, `riwayat_kondisi_kartu_${new Date().toISOString().slice(0,10)}.xlsx`);[m
[32m+[m[32m    } catch {[m
[32m+[m[32m      const header = ["Nama Pemohon","Tanggal Pinjam","Tanggal Kembali","Kondisi Kartu","Keterangan"].join(",");[m
[32m+[m[32m      const csvRows = filtered.map((r) =>[m
[32m+[m[32m        [r.nama, formatTanggal(r.tanggalPinjam), formatTanggal(r.tanggalKembali), r.kondisi, r.keterangan].join(",")[m
[32m+[m[32m      );[m
[32m+[m[32m      const blob = new Blob([[header, ...csvRows].join("\n")], { type: "text/csv" });[m
[32m+[m[32m      const url = URL.createObjectURL(blob);[m
[32m+[m[32m      const a = document.createElement("a");[m
[32m+[m[32m      a.href = url;[m
[32m+[m[32m      a.download = "riwayat_pengembalian.csv";[m
[32m+[m[32m      a.click();[m
[32m+[m[32m      URL.revokeObjectURL(url);[m
[32m+[m[32m    }[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  /* ---- Detail ---- */[m
[32m+[m[32m  const openDetail = async (reference, row) => {[m
[32m+[m[32m    const ref = reference || row?.nomorPengajuan || row?.reference;[m
[32m+[m
[32m+[m[32m    setDetailErr("");[m
[32m+[m[32m    setDetailLoading(true);[m
[32m+[m[32m    setDetailData(null);[m
[32m+[m[32m    setDetailOpen(true);[m
[32m+[m
[32m+[m[32m    // gunakan pickNonBlank agar placeholder tidak mengunci[m
[32m+[m[32m    const resolvePetugasPenerima = (rawObj) =>[m
[32m+[m[32m      pickNonBlank([m
[32m+[m[32m        row?.petugasPenerima,[m
[32m+[m[32m        row?.petugas_penerima,[m
[32m+[m[32m        rawObj?.returned_by_name,[m
[32m+[m[32m        rawObj?.returned_by,[m
[32m+[m[32m        rawObj?.received_by_name,[m
[32m+[m[32m        rawObj?.receiver_name,[m
[32m+[m[32m        rawObj?.petugas_penerima,[m
[32m+[m[32m        localStorage.getItem("namaPetugas"),[m
[32m+[m[32m        adminName[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m    const resolvePetugasPenyerah = (rawObj) =>[m
[32m+[m[32m      pickNonBlank([m
[32m+[m[32m        row?.petugasPenyerah,[m
[32m+[m[32m        row?.petugas_penyerah,[m
[32m+[m[32m        row?.petugasSerah,[m
[32m+[m[32m        row?.petugas_serah,[m
[32m+[m[32m        rawObj?.issued_by_name,[m
[32m+[m[32m        rawObj?.issued_by,[m
[32m+[m[32m        rawObj?.performed_by_name,[m
[32m+[m[32m        rawObj?.performed_by,[m
[32m+[m[32m        rawObj?.issuer_name,[m
[32m+[m[32m        localStorage.getItem("namaPetugas"),[m
[32m+[m[32m        adminName[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m    const resolveTanggalTerima = (rawObj) =>[m
[32m+[m[32m      row?.tanggalPinjam || rawObj?.issued_at || rawObj?.start_date || rawObj?.created_at || rawObj?.card_transaction?.issued_at || null;[m
[32m+[m
[32m+[m[32m    const resolveTanggalSerah = (rawObj) =>[m
[32m+[m[32m      row?.tanggalKembali || rawObj?.returned_at || rawObj?.actual_return_date || rawObj?.card_transaction?.returned_at || rawObj?.updated_at || null;[m
[32m+[m
[32m+[m[32m    const resolveKondisi = (rawObj) => normalizeCondition([m
[32m+[m[32m      row?.kondisi || rawObj?.kondisi || rawObj?.card_condition || rawObj?.condition ||[m
[32m+[m[32m      rawObj?.transaction_condition || rawObj?.card_transaction?.return_condition || rawObj?.card_transaction?.card_condition || ""[m
     );[m
[31m-    const csv = [header, ...rows].join("\n");[m
[31m-    const blob = new Blob([csv], { type: "text/csv" });[m
[31m-    const url = URL.createObjectURL(blob);[m
[31m-[m
[31m-    const a = document.createElement("a");[m
[31m-    a.href = url;[m
[31m-    a.download = "riwayat_pengembalian.csv";[m
[31m-    a.click();[m
[31m-    URL.revokeObjectURL(url);[m
[32m+[m
[32m+[m[32m    if (ref) {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const res = await getVerificationDetail({ reference_number: ref, reference: ref });[m
[32m+[m[32m        const raw = res?.data?.data || res?.data || {};[m
[32m+[m[32m        const nama = raw.applicant_name || raw.full_name || raw.name || row?.nama || "-";[m
[32m+[m[32m        const instansi = resolveInstansi(raw);[m
[32m+[m[32m        const noKtp = raw.national_id || raw.nik || "-";[m
[32m+[m[32m        const email = raw.email || raw.applicant_email || "-";[m
[32m+[m[32m        const tanggal = raw.visit_date || raw.visit_start_date || raw.date || row?.tanggalPinjam || null;[m
[32m+[m[32m        const selesaiKunjungan = raw.visit_end_date || raw.end_date || raw.due_date || row?.tanggalKembali || null;[m
[32m+[m[32m        const noPengajuan = raw.reference_number || raw.reference || ref || row?.nomorPengajuan || "-";[m
[32m+[m[32m        const handphone = raw.phone || raw.phone_number || raw.applicant_phone || "-";[m
[32m+[m[32m        const stasiun = typeof raw.station === "object" ? (raw.station?.name || "-") : (raw.station_name || raw.station || "-");[m
[32m+[m[32m        const tujuan = raw.purpose || raw.visit_purpose || raw.reason || raw.description || "-";[m
[32m+[m
[32m+[m[32m        const docRaw =[m
[32m+[m[32m          raw.document_url || raw.attachment_url || raw.document_path || raw.document ||[m
[32m+[m[32m          (Array.isArray(raw.documents) ? (raw.documents[0]?.url || raw.documents[0]) : "");[m
[32m+[m[32m        const dokumenUrl = docRaw ? toFileURL(docRaw) : "";[m
[32m+[m[32m        const dokumenNama = raw.document_original_name || raw.original_name || (typeof docRaw === "string" ? docRaw.split("/").pop() : "-");[m
[32m+[m
[32m+[m[32m        const statusLabel = (raw.status || raw.approval_status || raw.application_status || "").toString().toLowerCase();[m
[32m+[m[32m        const status =[m
[32m+[m[32m          statusLabel.includes("approve") || statusLabel === "approved" ? "Disetujui" :[m
[32m+[m[32m          statusLabel.includes("reject") || statusLabel === "rejected" ? "Ditolak" :[m
[32m+[m[32m          "Menunggu";[m
[32m+[m
[32m+[m[32m        const petugasPenerima = resolvePetugasPenerima(raw);[m
[32m+[m[32m        const petugasPenyerah = resolvePetugasPenyerah(raw);[m
[32m+[m[32m        const tanggalTerima = resolveTanggalTerima(raw);[m
[32m+[m[32m        const tanggalSerah = resolveTanggalSerah(raw);[m
[32m+[m[32m        const kondisi = resolveKondisi(raw);[m
[32m+[m
[32m+[m[32m        setDetailData({[m
[32m+[m[32m          nama, instansi, noKtp, email, tanggal, selesaiKunjungan, noPengajuan, handphone,[m
[32m+[m[32m          stasiun, tujuan, dokumenUrl, dokumenNama, status, raw,[m
[32m+[m[32m          petugasPenerima, petugasPenyerah, tanggalTerima, tanggalSerah, kondisi,[m
[32m+[m[32m        });[m
[32m+[m[32m      } catch (e) {[m
[32m+[m[32m        setDetailErr(e?.response?.data?.message || e?.message || "Gagal memuat detail.");[m
[32m+[m[32m      } finally { setDetailLoading(false); }[m
[32m+[m[32m      return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // fallback: gunakan row.raw / row data[m
[32m+[m[32m    try {[m
[32m+[m[32m      const raw = row?.raw || row || {};[m
[32m+[m[32m      const nama = raw.applicant_name || raw.full_name || raw.name || row?.nama || "-";[m
[32m+[m[32m      const instansi = resolveInstansi(raw);[m
[32m+[m[32m      const noKtp = raw.national_id || raw.nik || "-";[m
[32m+[m[32m      const email = raw.email || raw.applicant_email || "-";[m
[32m+[m[32m      const tanggal = raw.visit_date || raw.visit_start_date || raw.date || row?.tanggalPinjam || null;[m
[32m+[m[32m      const selesaiKunjungan = raw.visit_end_date || raw.end_date || raw.due_date || row?.tanggalKembali || null;[m
[32m+[m[32m      const noPengajuan = raw.reference_number || raw.reference || row?.nomorPengajuan || "-";[m
[32m+[m[32m      const handphone = raw.phone || raw.phone_number || raw.applicant_phone || "-";[m
[32m+[m[32m      const stasiun = (raw.station && (typeof raw.station === "string" ? raw.station : raw.station.name)) || raw.station_name || row?.stasiun || "-";[m
[32m+[m[32m      const tujuan = raw.purpose || raw.visit_purpose || raw.reason || raw.description || "-";[m
[32m+[m
[32m+[m[32m      const docRaw =[m
[32m+[m[32m        raw.document_url || raw.attachment_url || raw.document_path || raw.document ||[m
[32m+[m[32m        (Array.isArray(raw.documents) ? (raw.documents[0]?.url || raw.documents[0]) : "");[m
[32m+[m[32m      const dokumenUrl = docRaw ? toFileURL(docRaw) : "";[m
[32m+[m[32m      const dokumenNama = raw.document_original_name || raw.original_name || (typeof docRaw === "string" ? docRaw.split("/").pop() : "-");[m
[32m+[m
[32m+[m[32m      const statusLabel = (raw.status || raw.approval_status || raw.application_status || "").toString().toLowerCase();[m
[32m+[m[32m      const status =[m
[32m+[m[32m        statusLabel.includes("approve") || statusLabel === "approved" ? "Disetujui" :[m
[32m+[m[32m        statusLabel.includes("reject") || statusLabel === "rejected" ? "Ditolak" :[m
[32m+[m[32m        "Menunggu";[m
[32m+[m
[32m+[m[32m      const petugasPenerima = resolvePetugasPenerima(raw);[m
[32m+[m[32m      const petugasPenyerah = resolvePetugasPenyerah(raw);[m
[32m+[m[32m      const tanggalTerima = resolveTanggalTerima(raw);[m
[32m+[m[32m      const tanggalSerah = resolveTanggalSerah(raw);[m
[32m+[m[32m      const kondisi = normalizeCondition([m
[32m+[m[32m        row?.kondisi || raw?.kondisi || raw?.card_condition || raw?.condition ||[m
[32m+[m[32m        raw?.transaction_condition || raw?.card_transaction?.return_condition || raw?.card_transaction?.card_condition || ""[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m      setDetailData({[m
[32m+[m[32m        nama, instansi, noKtp, email, tanggal, selesaiKunjungan, noPengajuan, handphone,[m
[32m+[m[32m        stasiun, tujuan, dokumenUrl, dokumenNama, status, raw,[m
[32m+[m[32m        petugasPenerima, petugasPenyerah, tanggalTerima, tanggalSerah, kondisi,[m
[32m+[m[32m      });[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      setDetailErr("Gagal menampilkan detail.");[m
[32m+[m[32m    } finally { setDetailLoading(false); }[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  const handleOpenDocument = async (pathOrUrl) => {[m
[32m+[m[32m    if (!pathOrUrl) return;[m
[32m+[m[32m    try {[m
[32m+[m[32m      const resp = await fetchDocumentBlob(pathOrUrl);[m
[32m+[m[32m      const fileUrl = URL.createObjectURL(resp.data);[m
[32m+[m[32m      window.open(fileUrl, "_blank", "noopener,noreferrer");[m
[32m+[m[32m      const name = filenameFromHeaders(resp, "dokumen");[m
[32m+[m[32m      try { const a = document.createElement("a"); a.href = fileUrl; a.download = name; } catch {}[m
[32m+[m[32m    } catch {[m
[32m+[m[32m      window.open(toFileURL(pathOrUrl), "_blank", "noopener,noreferrer");[m
[32m+[m[32m    }[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  /* ---- Popup Laporan Rusak/Hilang ---- */[m
[32m+[m[32m  const openLaporanReadonly = async (row) => {[m
[32m+[m[32m    const meta = getMetaForRow(row);[m
[32m+[m[32m    // 1) isi cepat dari row/raw[m
[32m+[m[32m    let instansiNow =[m
[32m+[m[32m      (row?.instansi && row.instansi !== "-") ? row.instansi : resolveInstansi(row?.raw || {});[m
[32m+[m[32m    setLaporanData({[m
[32m+[m[32m      nama: row?.nama || "-",[m
[32m+[m[32m      instansi: instansiNow || "-",[m
[32m+[m[32m      tanggal: row?.tanggalPinjam || null,[m
[32m+[m[32m      kondisi: row?.kondisi || meta.kondisi || "Baik",[m
[32m+[m[32m      alasan: meta.alasan || "-",[m
[32m+[m[32m      penanganan: meta.penanganan || "-",[m
[32m+[m[32m    });[m
[32m+[m[32m    setLaporanOpen(true);[m
[32m+[m
[32m+[m[32m    // 2) fallback ke API detail jika masih "-"[m
[32m+[m[32m    if (!instansiNow || instansiNow === "-") {[m
[32m+[m[32m      const ref = row?.reference || row?.nomorPengajuan;[m
[32m+[m[32m      if (ref) {[m
[32m+[m[32m        try {[m
[32m+[m[32m          const res = await getVerificationDetail({ reference_number: ref, reference: ref });[m
[32m+[m[32m          const raw = res?.data?.data || res?.data || {};[m
[32m+[m[32m          const fromDetail = resolveInstansi(raw);[m
[32m+[m[32m          if (fromDetail && fromDetail !== "-") {[m
[32m+[m[32m            setLaporanData((prev) => ({ ...prev, instansi: fromDetail }));[m
[32m+[m[32m          }[m
[32m+[m[32m        } catch {[m
[32m+[m[32m          // biarkan "-"[m
[32m+[m[32m        }[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
   };[m
 [m
   return ([m
     <div className="min-h-screen flex bg-[#6A8BB0] font-poppins">[m
       {/* Sidebar */}[m
[31m-      <aside[m
[31m-        className="bg-[#E6E6E6] flex flex-col py-8 px-7 border-r border-[#eaeaea] h-screen fixed top-0 left-0 z-20"[m
[31m-        style={{ width: 360 }}[m
[31m-      >[m
[32m+[m[32m      <aside className="bg-[#E6E6E6] flex flex-col py-8 px-7 border-r border-[#eaeaea] h-screen fixed top-0 left-0 z-20" style={{ width: 360 }}>[m
         <img src={kaiLogo} alt="KAI Logo" className="w-[120px] mb-6 mx-auto" />[m
         <div className="text-[18px] font-poppins font-medium text-[#242424] text-center mb-7 leading-[20px]">[m
           Admin Panel Kartu Visitor[m
         </div>[m
         <div className="w-full flex justify-center mb-12">[m
[31m-          <div[m
[31m-            style={{[m
[31m-              width: "100%",[m
[31m-              height: 2,[m
[31m-              background: "#C4C4C4",[m
[31m-              borderRadius: 2,[m
[31m-              margin: "0 auto",[m
[31m-            }}[m
[31m-          />[m
[32m+[m[32m          <div style={{ width: "100%", height: 2, background: "#C4C4C4", borderRadius: 2, margin: "0 auto" }} />[m
         </div>[m
         <nav className="flex flex-col gap-4 mt-2">[m
[31m-          {menuItems.map((item) => {[m
[31m-            const isActive = location.pathname === item.path;[m
[32m+[m[32m          {[[m
[32m+[m[32m            { label: "Dashboard", icon: "streamline-plump:user-pin-remix", path: "/admin/dashboard" },[m
[32m+[m[32m            { label: "Verifikasi & Persetujuan", icon: "streamline-sharp:time-lapse-solid", path: "/admin/verifikasi" },[m
[32m+[m[32m            { label: "Kartu Visitor", icon: "solar:card-recive-outline", path: "/admin/kartu-visitor" },[m
[32m+[m[32m            { label: "Riwayat Pengembalian", icon: "solar:card-search-broken", path: "/admin/riwayat" },[m
[32m+[m[32m          ].map((m) => {[m
[32m+[m[32m            const active = location.pathname === m.path;[m
             return ([m
               <button[m
[31m-                key={item.label}[m
[31m-                onClick={() => handleMenuClick(item.path)}[m
[31m-                className={`flex items-center gap-4 px-4 py-2 text-left transition-all hover:opacity-80[m
[31m-                  ${isActive[m
[31m-                    ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]"[m
[31m-                    : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"[m
[31m-                  } text-[17px]`}[m
[31m-                style={isActive ? { boxShadow: "0 2px 8px rgba(90,90,140,0.07)" } : {}}[m
[32m+[m[32m                key={m.label}[m
[32m+[m[32m                onClick={() => navigate(m.path)}[m
[32m+[m[32m                className={`flex items-center gap-4 px-4 py-2 text-left transition-all hover:opacity-80 ${active ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]" : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"} text-[17px]`}[m
[32m+[m[32m                style={active ? { boxShadow: "0 2px 8px rgba(90,90,140,0.07)" } : {}}[m
               >[m
[31m-                <span className="flex items-center">[m
[31m-                  <Icon icon={item.icon} width={32} height={32} />[m
[31m-                </span>[m
[31m-                {item.label}[m
[32m+[m[32m                <span className="flex items-center"><Icon icon={m.icon} width={32} height={32} /></span>[m
[32m+[m[32m                {m.label}[m
               </button>[m
             );[m
           })}[m
         </nav>[m
       </aside>[m
 [m
[31m-      {/* Main Content */}[m
[31m-      <main[m
[31m-        className="flex-1 flex flex-col px-2 md:px-12 py-10 transition-all"[m
[31m-        style={{ marginLeft: 360, minHeight: "100vh", width: "100%" }}[m
[31m-      >[m
[31m-        {/* Kotak atas (JANGAN DIUBAH) */}[m
[32m+[m[32m      {/* Main */}[m
[32m+[m[32m      <main className="flex-1 flex flex-col px-2 md:px-12 py-10 transition-all" style={{ marginLeft: 360, minHeight: "100vh", width: "100%" }}>[m
         <div className="flex gap-8 mb-10 flex-wrap">[m
[31m-          <div[m
[31m-            className="w-full max-w-[900px] flex items-center bg-white rounded-[20px] shadow-md px-8 py-4 relative mx-auto"[m
[31m-            style={{ minHeight: 70 }}[m
[31m-          >[m
[31m-            <span className="font-poppins font-semibold text-[24px] text-[#474646]">[m
[31m-              Riwayat Pengembalian[m
[31m-            </span>[m
[31m-            {/* Profile section */}[m
[31m-            <div[m
[31m-              className="relative ml-auto"[m
[31m-              style={{ minWidth: 200 }}[m
[31m-              ref={dropdownRef}[m
[31m-            >[m
[31m-              <div[m
[31m-                className="absolute top-0 left-0 w-full h-full"[m
[31m-                style={{[m
[31m-                  background: "rgba(106,139,176,0.13)",[m
[31m-                  borderRadius: 15,[m
[31m-                  zIndex: 0,[m
[31m-                }}[m
[31m-              ></div>[m
[31m-              <button[m
[31m-                className="relative flex items-center gap-2 px-5 py-2 cursor-pointer z-10 hover:opacity-80 transition-opacity"[m
[31m-                style={{[m
[31m-                  borderRadius: 15,[m
[31m-                  background: "transparent",[m
[31m-                }}[m
[31m-                onClick={() => setShowDropdown((prev) => !prev)}[m
[31m-              >[m
[32m+[m[32m          <div className="w-full max-w-[900px] flex items-center bg-white rounded-[20px] shadow-md px-8 py-4 relative mx-auto" style={{ minHeight: 70 }}>[m
[32m+[m[32m            <span className="font-poppins font-semibold text-[24px] text-[#474646]">Riwayat Pengembalian</span>[m
[32m+[m[32m            <div className="relative ml-auto" style={{ minWidth: 200 }} ref={dropdownRef}>[m
[32m+[m[32m              <div className="absolute top-0 left-0 w-full h-full" style={{ background: "rgba(106,139,176,0.13)", borderRadius: 15, zIndex: 0 }} />[m
[32m+[m[32m              <button className="relative flex items-center gap-2 px-5 py-2 cursor-pointer z-10 hover:opacity-80 transition-opacity" style={{ borderRadius: 15, background: "transparent" }} onClick={() => setShowDropdown((p) => !p)}>[m
                 <span className="w-[38px] h-[38px] rounded-full bg-[#6A8BB0] flex items-center justify-center text-white text-[24px] font-poppins font-semibold mr-2">[m
[31m-                  {adminName[0]}[m
[31m-                </span>[m
[31m-                <span className="font-poppins font-medium text-[18px] leading-[36px] text-[#474646]">[m
[31m-                  {adminName}[m
[32m+[m[32m                  {(adminName[0] || "A").toUpperCase()}[m
                 </span>[m
[32m+[m[32m                <span className="font-poppins font-medium text-[18px] leading-[36px] text-[#474646]">{adminName}</span>[m
               </button>[m
[31m-              {showDropdown && ([m
[31m-                <div className="absolute top-[62px] right-0 bg-white rounded-[12px] shadow-lg px-6 py-3 z-20 border min-w-[146px] flex items-center gap-3">[m
[31m-                  <Icon icon="ic:round-logout" width={34} color="#d61d1d" />[m
[31m-                  <button[m
[31m-                    className="w-full text-left text-[#474646] font-poppins font-medium text-[18px] py-2 hover:bg-[#F1F2F6] rounded-md transition-colors"[m
[31m-                    onClick={handleLogout}[m
[31m-                  >[m
[31m-                    Log Out[m
[31m-                  </button>[m
[31m-                </div>[m
[31m-              )}[m
             </div>[m
           </div>[m
         </div>[m
 [m
[31m-        {/* Data Card Riwayat */}[m
[32m+[m[32m        {/* Table */}[m
         <div className="w-full max-w-[900px] mx-auto">[m
           <div className="bg-white rounded-[20px] shadow-md px-0 py-0">[m
[31m-            {/* Search & Export */}[m
[31m-            <div className="flex items-center px-8 pt-8 pb-3 justify-between">[m
[31m-              <div className="flex items-center flex-1 bg-white px-4 py-2 rounded-[11px] border border-[#E4E4E4]"[m
[31m-                style={{ maxWidth: 360, background: "#F4F4F4" }}>[m
[32m+[m[32m            <div className="flex items-center px-8 pt-8 pb-3">[m
[32m+[m[32m              <div className="flex items-center bg-white px-4 py-2 rounded-[11px] border border-[#E4E4E4] mr-3" style={{ maxWidth: 360, background: "#F4F4F4" }}>[m
                 <Icon icon="ic:round-search" width={28} color="#474646" className="mr-2" />[m
                 <input[m
                   type="text"[m
                   placeholder="cari berdasarkan nama pemohon"[m
                   value={query}[m
[31m-                  onChange={e => setQuery(e.target.value)}[m
[32m+[m[32m                  onChange={(e) => setQuery(e.target.value)}[m
                   className="flex-1 outline-none bg-transparent border-0 text-[17px] font-poppins font-light italic text-[#474646]"[m
                   style={{ fontStyle: "italic", fontWeight: 300 }}[m
                 />[m
               </div>[m
[31m-              <div className="flex-1 flex justify-end">[m
[31m-                <button[m
[31m-                  className="px-5 py-2 rounded-[8px] font-poppins font-medium text-white"[m
[31m-                  style={{[m
[31m-                    background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
[31m-                    fontWeight: 500,[m
[31m-                  }}[m
[31m-                  onClick={exportLaporan}[m
[31m-                >[m
[31m-                  Export Laporan[m
[31m-                </button>[m
[31m-              </div>[m
[32m+[m[32m              <button[m
[32m+[m[32m                className="px-5 py-2 rounded-[8px] font-poppins font-medium text-white ml-auto"[m
[32m+[m[32m                style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)", fontWeight: 500 }}[m
[32m+[m[32m                onClick={exportLaporan}[m
[32m+[m[32m              >[m
[32m+[m[32m                Export Laporan[m
[32m+[m[32m              </button>[m
             </div>[m
[31m-            {/* Table */}[m
[32m+[m
             <div className="overflow-x-auto pb-8 px-8">[m
               <table className="w-full min-w-[730px]">[m
                 <thead>[m
                   <tr style={{ background: "#F4F4F4" }}>[m
[31m-                    <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Nama Pemohon</th>[m
[31m-                    <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Tanggal Pinjam</th>[m
[31m-                    <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Tanggal Kembali</th>[m
[31m-                    <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Kondisi Kartu</th>[m
[32m+[m[32m                    <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Nama<br/>Pemohon</th>[m
[32m+[m[32m                    <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Tanggal<br/>Pinjam</th>[m
[32m+[m[32m                    <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Tanggal<br/>Kembali</th>[m
[32m+[m[32m                    <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Kondisi<br/>Kartu</th>[m
                     <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Keterangan</th>[m
                     <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Aksi</th>[m
                   </tr>[m
                 </thead>[m
                 <tbody>[m
[31m-                  {filteredData.map((row, idx) => ([m
[31m-                    <tr key={idx} className={idx % 2 === 0 ? "" : "bg-[#F8F8F8]"}>[m
[31m-                      <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">[m
[31m-                        {row.nama}[m
[31m-                      </td>[m
[31m-                      <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">[m
[31m-                        {formatTanggal(row.tanggalPinjam)}[m
[31m-                      </td>[m
[31m-                      <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">[m
[31m-                        {formatTanggal(row.tanggalKembali)}[m
[31m-                      </td>[m
[31m-                      <td className="py-2 px-2 text-center font-poppins font-medium text-[15px] text-[#474646]">[m
[31m-                        {row.kondisi}[m
[31m-                      </td>[m
[31m-                      <td className="py-2 px-2 text-center">[m
[31m-                        <span[m
[31m-                          className="font-poppins font-semibold rounded-[7px] px-5 py-1 text-white"[m
[31m-                          style={{[m
[31m-                            background: "#34C331",[m
[31m-                            fontWeight: 600,[m
[31m-                            display: "inline-block",[m
[31m-                            borderRadius: 7,[m
[31m-                            fontSize: 15,[m
[31m-                            minWidth: 90,[m
[31m-                          }}[m
[31m-                        >[m
[31m-                          Selesai[m
[31m-                        </span>[m
[31m-                      </td>[m
[31m-                      <td className="py-2 px-2 text-center">[m
[31m-                        <button[m
[31m-                          className="font-poppins font-semibold rounded-[8px] px-5 py-1 text-white"[m
[31m-                          style={{[m
[31m-                            background: "#8E8E8E",[m
[31m-                            fontWeight: 600,[m
[31m-                            fontSize: 15,[m
[31m-                            borderRadius: 8,[m
[31m-                            minWidth: 110,[m
[31m-                          }}[m
[31m-                          onClick={() => navigate("/admin/detail-kerusakan", { state: { nama: row.nama } [m
[31m-                          })}[m
[31m-                        >[m
[31m-                          Lihat Detail[m
[31m-                        </button>[m
[31m-                      </td>[m
[31m-                    </tr>[m
[31m-                  ))}[m
[31m-                  {filteredData.length === 0 && ([m
[31m-                    <tr>[m
[31m-                      <td colSpan={6} className="text-center py-6 text-[#aaa] font-poppins font-medium">[m
[31m-                        Tidak ada data ditemukan.[m
[31m-                      </td>[m
[31m-                    </tr>[m
[32m+[m[32m                  {loading ? ([m
[32m+[m[32m                    <tr><td colSpan={6} className="py-6 text-center text-[#6b7280]">Memuatâ€¦</td></tr>[m
[32m+[m[32m                  ) : err ? ([m
[32m+[m[32m                    <tr><td colSpan={6} className="py-6 text-center text-red-600">{err}</td></tr>[m
[32m+[m[32m                  ) : filtered.length === 0 ? ([m
[32m+[m[32m                    <tr><td colSpan={6} className="py-6 text-center text-[#6b7280]">Tidak ada data.</td></tr>[m
[32m+[m[32m                  ) : ([m
[32m+[m[32m                    filtered.map((r, idx) => ([m
[32m+[m[32m                      <tr key={r.key ?? idx} className={idx % 2 === 0 ? "" : "bg-[#F8F8F8]"}>[m
[32m+[m[32m                        <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">{r.nama}</td>[m
[32m+[m[32m                        <td className="py-2 px-2 text-center font-poppins font-medium text-[15px] text-[#474646]">{formatTanggal(r.tanggalPinjam)}</td>[m
[32m+[m[32m                        <td className="py-2 px-2 text-center font-poppins font-medium text-[15px] text-[#474646]">{formatTanggal(r.tanggalKembali)}</td>[m
[32m+[m[32m                        <td className="py-2 px-2 text-center">[m
[32m+[m[32m                          {r.kondisi === "Baik" ? ([m
[32m+[m[32m                            <span className="font-poppins font-medium rounded-[7px] inline-flex items-center justify-center" style={{ background: (kondisiBadge[r.kondisi] || "#ACB3BB") + "99", color: "#212529", minWidth: 90, height: 36, padding: "0 12px", cursor: "default" }} title="Kondisi Baik">[m
[32m+[m[32m                              {r.kondisi}[m
[32m+[m[32m                            </span>[m
[32m+[m[32m                          ) : ([m
[32m+[m[32m                            <button className="font-poppins font-medium rounded-[7px] inline-flex items-center justify-center" style={{ background: (kondisiBadge[r.kondisi] || "#ACB3BB") + "99", color: "#212529", minWidth: 90, height: 36, padding: "0 12px" }} onClick={() => openLaporanReadonly(r)} title="Lihat laporan kondisi">[m
[32m+[m[32m                              {r.kondisi}[m
[32m+[m[32m                            </button>[m
[32m+[m[32m                          )}[m
[32m+[m[32m                        </td>[m
[32m+[m[32m                        <td className="py-2 px-2 text-center">[m
[32m+[m[32m                          <span className="font-poppins font-semibold rounded-[7px] px-6 py-2 text-white" style={{ background: "#2f8bf5ff" }}>{r.keterangan || "Selesai"}</span>[m
[32m+[m[32m                        </td>[m
[32m+[m[32m                        <td className="py-2 px-2 text-center">[m
[32m+[m[32m                          <button className="px-5 py-2 rounded-[8px] font-poppins font-medium text-white" style={{ background: "#6A8BB0" }} onClick={() => openDetail(r.reference, r)} title="Lihat Detail">[m
[32m+[m[32m                            Detail[m
[32m+[m[32m                          </button>[m
[32m+[m[32m                        </td>[m
[32m+[m[32m                      </tr>[m
[32m+[m[32m                    ))[m
                   )}[m
                 </tbody>[m
               </table>[m
             </div>[m
           </div>[m
         </div>[m
[31m-        <style>{`[m
[31m-          @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');[m
[31m-          .font-poppins { font-family: 'Poppins', sans-serif; }[m
[31m-          input::placeholder { font-family: 'Poppins', sans-serif; font-weight: 300; font-style: italic; }[m
[31m-        `}</style>[m
       </main>[m
[32m+[m
[32m+[m[32m      {/* Detail Modal */}[m
[32m+[m[32m      {detailOpen && ([m
[32m+[m[32m        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-30" onClick={() => setDetailOpen(false)}>[m
[32m+[m[32m          <div className="bg-white rounded-[14px] shadow-xl w-[95%] max-w-[760px] min-w-[360px] relative flex flex-col" onClick={(e) => e.stopPropagation()} style={{ maxHeight: "85vh", overflow: "hidden" }}>[m
[32m+[m[32m            <div className="px-6 py-4 flex items-center justify-between" style={{ background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)", position: "sticky", top: 0, zIndex: 30 }}>[m
[32m+[m[32m              <div style={{ display: "flex", alignItems: "center", gap: 12 }}>[m
[32m+[m[32m                <div className="w-10 h-10 rounded-full bg-white/15 flex items-center justify-center">[m
[32m+[m[32m                  <Icon icon="material-symbols:id-card-rounded" width={20} color="#fff" />[m
[32m+[m[32m                </div>[m
[32m+[m[32m                <div>[m
[32m+[m[32m                  <div className="font-poppins font-semibold text-white text-[18px]">Detail Pengajuan</div>[m
[32m+[m[32m                  <div className="text-white/90 text-sm" style={{ opacity: 0.92 }}>Informasi ringkas pengajuan & petugas</div>[m
[32m+[m[32m                </div>[m
[32m+[m[32m              </div>[m
[32m+[m[32m              <button onClick={() => setDetailOpen(false)} aria-label="Tutup" style={{ color: "#fff", fontSize: 20, background: "transparent", border: "none" }}>[m
[32m+[m[32m                Ã—[m
[32m+[m[32m              </button>[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div className="px-6 py-4 overflow-y-auto" style={{ flex: "1 1 auto" }}>[m
[32m+[m[32m              {detailLoading ? ([m
[32m+[m[32m                <div className="text-center py-8">Memuat detailâ€¦</div>[m
[32m+[m[32m              ) : detailErr ? ([m
[32m+[m[32m                <div className="text-red-600">{detailErr}</div>[m
[32m+[m[32m              ) : detailData ? ([m
[32m+[m[32m                <>[m
[32m+[m[32m                  <div className="flex items-start justify-between mb-4">[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-[22px] font-poppins font-semibold text-[#222]">{detailData.nama}</div>[m
[32m+[m[32m                      <div className="text-[16px] text-[#666] mt-1">{detailData.noPengajuan}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div style={{ display: "flex", alignItems: "center", gap: 10 }}>[m
[32m+[m[32m                      <div style={{ padding: "6px 12px", borderRadius: 8, background: detailData.status === "Disetujui" ? "#E7FEED" : detailData.status === "Ditolak" ? "#FFDEDB" : "#FEF5E7", color: detailData.status === "Disetujui" ? "#047A16" : detailData.status === "Ditolak" ? "#A80000" : "#A06B00", fontWeight: 600 }}>[m
[32m+[m[32m                        {detailData.status}[m
[32m+[m[32m                      </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                  </div>[m
[32m+[m
[32m+[m[32m                  {/* Kondisi Kartu dihapus sesuai permintaan */}[m
[32m+[m
[32m+[m[32m                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Instansi</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.instansi || "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Nomor KTP</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.noKtp || "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Email</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.email || "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Nomor HP</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.handphone || "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Tanggal Kunjungan</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.tanggal ? formatTanggal(detailData.tanggal) : "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Selesai Kunjungan</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.selesaiKunjungan ? formatTanggal(detailData.selesaiKunjungan) : "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    <div className="md:col-span-1">[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Stasiun</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.stasiun || "-"}</div>[m
[32m+[m[32m                      {detailData.dokumenUrl && ([m
[32m+[m[32m                        <div className="mt-3">[m
[32m+[m[32m                          <div className="text-sm text-[#666] mb-1">Dokumen</div>[m
[32m+[m[32m                          <div className="text-sm">[m
[32m+[m[32m                            <a href="#" onClick={(e) => { e.preventDefault(); handleOpenDocument(detailData.raw?.document_path || detailData.dokumenUrl); }} style={{ textDecoration: "underline", color: "#1E3A8A", fontWeight: 600 }}>[m
[32m+[m[32m                              Lihat[m
[32m+[m[32m                            </a>[m
[32m+[m[32m                          </div>[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                      )}[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    <div className="md:col-span-1">[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Tujuan</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.tujuan || "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                  </div>[m
[32m+[m
[32m+[m[32m                  <div style={{ height: 1, background: "#E6E6E9", margin: "8px 0 16px 0" }} />[m
[32m+[m
[32m+[m[32m                  {/* Petugas & Tanggal */}[m
[32m+[m[32m                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Petugas Penerima</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">[m
[32m+[m[32m                        {isBlank(detailData.petugasPenerima) ? adminName : detailData.petugasPenerima}[m
[32m+[m[32m                      </div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Petugas Penyerah</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">[m
[32m+[m[32m                        {isBlank(detailData.petugasPenyerah) ? adminName : detailData.petugasPenyerah}[m
[32m+[m[32m                      </div>[m
[32m+[m[32m                    </div>[m
[32m+[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Tanggal Terima</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.tanggalTerima ? formatTanggal(detailData.tanggalTerima) : "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                    <div>[m
[32m+[m[32m                      <div className="text-sm text-[#666] mb-1">Tanggal Serah</div>[m
[32m+[m[32m                      <div className="font-poppins font-medium">{detailData.tanggalSerah ? formatTanggal(detailData.tanggalSerah) : "-"}</div>[m
[32m+[m[32m                    </div>[m
[32m+[m[32m                  </div>[m
[32m+[m[32m                </>[m
[32m+[m[32m              ) : ([m
[32m+[m[32m                <div>Tidak ada detail.</div>[m
[32m+[m[32m              )}[m
[32m+[m[32m            </div>[m
[32m+[m
[32m+[m[32m            <div className="px-6 py-4" style={{ borderTop: "1px solid #EEF0F2", position: "sticky", bottom: 0, background: "#fff", zIndex: 40 }}>[m
[32m+[m[32m              <div className="flex justify-end">[m
[32m+[m[32m                <button className="px-4 py-2 rounded-[8px] font-poppins font-medium" style={{ background: "#E3E3E3", color: "#474646" }} onClick={() => setDetailOpen(false)}>[m
[32m+[m[32m                  Tutup[m
[32m+[m[32m                </button>[m
[32m+[m[32m              </div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m          </div>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      )}[m
[32m+[m
[32m+[m[32m      {/* Popup Laporan Read-only (Rusak/Hilang) */}[m
[32m+[m[32m      <Popup show={laporanOpen} onClose={() => setLaporanOpen(false)} title="Laporan Kartu Rusak/Hilang">[m
[32m+[m[32m        <div className="rounded-[10px] overflow-hidden mb-4" style={{ background: "rgba(100,115,175,0.07)", border: "1px solid rgba(208,205,205,0.56)" }}>[m
[32m+[m[32m          <div className="px-4 pt-3 pb-2">[m
[32m+[m[32m            <div className="font-poppins font-medium text-[#919090] text-[14px]">Laporan Kartu</div>[m
[32m+[m[32m          </div>[m
[32m+[m[32m          <div style={{ height: 2, background: "rgba(208,205,205,0.56)" }} />[m
[32m+[m[32m          <div className="px-4 py-1">[m
[32m+[m[32m            <div className="py-2 flex gap-2 text-[14.5px]" style={{ borderBottom: "1px solid rgba(208,205,205,0.56)" }}>[m
[32m+[m[32m              <div className="min-w-[150px] text-[#474646] font-poppins font-medium">Nama Lengkap</div>[m
[32m+[m[32m              <div className="text-[#474646] font-poppins font-medium">: {laporanData.nama}</div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div className="py-2 flex gap-2 text-[14.5px]" style={{ borderBottom: "1px solid rgba(208,205,205,0.56)" }}>[m
[32m+[m[32m              <div className="min-w-[150px] text-[#474646] font-poppins font-medium">Instansi</div>[m
[32m+[m[32m              <div className="text-[#474646] font-poppins font-medium">: {laporanData.instansi || "-"}</div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div className="py-2 flex gap-2 text-[14.5px]" style={{ borderBottom: "1px solid rgba(208,205,205,0.56)" }}>[m
[32m+[m[32m              <div className="min-w-[150px] text-[#474646] font-poppins font-medium">Tanggal Kunjungan</div>[m
[32m+[m[32m              <div className="text-[#474646] font-poppins font-medium">: {laporanData.tanggal ? formatTanggal(laporanData.tanggal) : "-"}</div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m            <div className="py-2 flex gap-2 text-[14.5px]" style={{ borderBottom: "1px solid rgba(208,205,205,0.56)" }}>[m
[32m+[m[32m              <div className="min-w-[150px] text-[#474646] font-poppins font-medium">Kondisi Kartu</div>[m
[32m+[m[32m              <div className="text-[#474646] font-poppins font-medium">: {laporanData.kondisi}</div>[m
[32m+[m[32m            </div>[m
[32m+[m[32m          </div>[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div className="mb-2 font-poppins font-medium" style={{ color: "#474646" }}>Alasan :</div>[m
[32m+[m[32m        <div className="p-3 rounded-[7px] mb-3" style={{ background: "#F7F7F7", border: "1px solid rgba(208,205,205,0.56)", whiteSpace: "pre-wrap" }}>[m
[32m+[m[32m          {laporanData.alasan || "-"}[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <div className="mb-2 font-poppins font-medium" style={{ color: "#474646" }}>Penanganan :</div>[m
[32m+[m[32m        <div className="p-3 rounded-[7px]" style={{ background: "#F7F7F7", border: "1px solid rgba(208,205,205,0.56)", whiteSpace: "pre-wrap" }}>[m
[32m+[m[32m          {laporanData.penanganan || "-"}[m
[32m+[m[32m        </div>[m
[32m+[m
[32m+[m[32m        <div className="flex justify-end gap-3 mt-5">[m
[32m+[m[32m          <button className="px-7 py-2 rounded-[7px] font-poppins font-medium text-white" style={{ background: "#ACB3BB" }} onClick={() => setLaporanOpen(false)}>[m
[32m+[m[32m            Tutup[m
[32m+[m[32m          </button>[m
[32m+[m[32m        </div>[m
[32m+[m[32m      </Popup>[m
[32m+[m
[32m+[m[32m      <style>{`[m
[32m+[m[32m        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');[m
[32m+[m[32m        .font-poppins { font-family: 'Poppins', sans-serif; }[m
[32m+[m[32m      `}</style>[m
     </div>[m
   );[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
[1mdiff --git a/src/admin/VerifikasiPersetujuan.jsx b/src/admin/VerifikasiPersetujuan.jsx[m
[1mindex 6fc974b..d8a255c 100644[m
[1m--- a/src/admin/VerifikasiPersetujuan.jsx[m
[1m+++ b/src/admin/VerifikasiPersetujuan.jsx[m
[36m@@ -1,150 +1,239 @@[m
[31m-[m
[31m-import React, { useState, useRef } from "react";[m
[32m+[m[32m// src/admin/VerifikasiPersetujuan.jsx[m
[32m+[m[32mimport React, { useState, useRef, useEffect, useMemo } from "react";[m
 import { useNavigate, useLocation } from "react-router-dom";[m
 import { Icon } from "@iconify/react";[m
 import kaiLogo from "../assets/KAI-logo.png";[m
 [m
[31m-const STATUS_KEY = "status_pengajuan_azida";[m
[32m+[m[32mimport {[m
[32m+[m[32m  getVerificationsAll,[m
[32m+[m[32m  getVisitTypeMap,[m
[32m+[m[32m  adminLogout,[m
[32m+[m[32m  ORIGIN,[m
[32m+[m[32m  fetchDocumentBlob,[m
[32m+[m[32m  filenameFromHeaders,[m
[32m+[m[32m} from "../api";[m
[32m+[m
[32m+[m[32m/* =========================================================[m
[32m+[m[32m * Utils[m
[32m+[m[32m * ========================================================= */[m
[32m+[m
[32m+[m[32mconst statusConfig = {[m
[32m+[m[32m  Menunggu:  { bg: "#FEF5E7", color: "#D69E2E", label: "Menunggu" },[m
[32m+[m[32m  Disetujui: { bg: "#E7FEED", color: "#47D62E", label: "Disetujui" },[m
[32m+[m[32m  Ditolak:   { bg: "#FFDEDB", color: "#FF0000", label: "Ditolak" },[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32m// Normalisasi status backend -> ID (longgar)[m
[32m+[m[32mfunction mapStatusID(raw) {[m
[32m+[m[32m  if (raw === 1 || raw === "1" || String(raw).toLowerCase() === "true") return "Disetujui";[m
[32m+[m[32m  if (raw === 2 || raw === "2") return "Ditolak";[m
[32m+[m[32m  if (raw === 0 || raw === "0") return "Menunggu";[m
[32m+[m
[32m+[m[32m  const s = String(raw || "").trim().toLowerCase();[m
[32m+[m[32m  if ([m
[32m+[m[32m    s.includes("approve") || s.includes("accepted") || s === "accept" ||[m
[32m+[m[32m    s.includes("disetujui") || s === "setuju"[m
[32m+[m[32m  ) return "Disetujui";[m
[32m+[m[32m  if ([m
[32m+[m[32m    s.includes("reject") || s.includes("declin") ||[m
[32m+[m[32m    s.includes("ditolak") || s === "tolak"[m
[32m+[m[32m  ) return "Ditolak";[m
[32m+[m[32m  if ([m
[32m+[m[32m    s === "" ||[m
[32m+[m[32m    s.includes("pending") ||[m
[32m+[m[32m    s.includes("process") ||[m
[32m+[m[32m    s.includes("proses") ||[m
[32m+[m[32m    s.includes("menunggu") ||[m
[32m+[m[32m    s.includes("waiting") ||[m
[32m+[m[32m    s.includes("review")[m
[32m+[m[32m  ) return "Menunggu";[m
 [m
[31m-// Ambil status dari localStorage dan fallback ke "Menunggu" kalau kosong/null/spasi[m
[31m-function getAzidaStatus() {[m
[31m-  const raw = localStorage.getItem(STATUS_KEY);[m
[31m-  return raw && raw.trim() !== "" ? raw : "Menunggu";[m
[32m+[m[32m  return "Menunggu";[m
 }[m
 [m
[31m-// Dummy data [m
[31m-const dummyPengajuan = [[m
[31m-  {[m
[31m-    nama: "Azida Kautsar",[m
[31m-    jenis: "Magang",[m
[31m-    tanggal: "08 Agustus 2025",[m
[31m-    dokumen: "dummy.pdf",[m
[31m-    status: getAzidaStatus(),[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Milano Sitanggang",[m
[31m-    jenis: "Vendor",[m
[31m-    tanggal: "09 Agustus 2025",[m
[31m-    dokumen: "dummy.png",[m
[31m-    status: "Menunggu",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Maula Azkadina",[m
[31m-    jenis: "Magang",[m
[31m-    tanggal: "09 Agustus 2025",[m
[31m-    dokumen: "dummy.jpg",[m
[31m-    status: "Diterima",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Yudhita Meika",[m
[31m-    jenis: "Inspeksi",[m
[31m-    tanggal: "10 Agustus 2025",[m
[31m-    dokumen: "dummy.docx",[m
[31m-    status: "Diterima",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Ahmad Arfan",[m
[31m-    jenis: "Vendor",[m
[31m-    tanggal: "11 Agustus 2025",[m
[31m-    dokumen: "dummy.pdf",[m
[31m-    status: "Diterima",[m
[31m-  },[m
[31m-  {[m
[31m-    nama: "Gading Subagio",[m
[31m-    jenis: "Inspeksi",[m
[31m-    tanggal: "11 Agustus 2025",[m
[31m-    dokumen: "dummy.png",[m
[31m-    status: "Ditolak",[m
[31m-  },[m
[32m+[m[32mfunction toFileURL(v) {[m
[32m+[m[32m  if (!v) return null;[m
[32m+[m[32m  if (/^https?:\/\//i.test(v)) return v;[m
[32m+[m[32m  const clean = String(v).replace(/^\/+/, "");[m
[32m+[m[32m  const finalPath =[m
[32m+[m[32m    clean.startsWith("storage/") || clean.startsWith("uploads/")[m
[32m+[m[32m      ? clean[m
[32m+[m[32m      : `storage/${clean}`;[m
[32m+[m[32m  return `${ORIGIN}/${finalPath}`;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfunction filenameOf(v, fallback = "-") {[m
[32m+[m[32m  if (!v) return fallback;[m
[32m+[m[32m  try {[m
[32m+[m[32m    const u = new URL(v);[m
[32m+[m[32m    const last = u.pathname.split("/").filter(Boolean).pop();[m
[32m+[m[32m    return decodeURIComponent(last || fallback);[m
[32m+[m[32m  } catch {[m
[32m+[m[32m    const last = String(v).split("/").filter(Boolean).pop();[m
[32m+[m[32m    return last || fallback;[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mconst MONTHS = [[m
[32m+[m[32m  "Januari","Februari","Maret","April","Mei","Juni",[m
[32m+[m[32m  "Juli","Agustus","September","Oktober","November","Desember",[m
 ];[m
[32m+[m[32mfunction formatTanggal(val) {[m
[32m+[m[32m  if (!val) return "-";[m
[32m+[m[32m  const d = new Date(val);[m
[32m+[m[32m  if (isNaN(d)) return String(val);[m
[32m+[m[32m  return `${String(d.getDate()).padStart(2, "0")} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`;[m
[32m+[m[32m}[m
 [m
[31m-const statusConfig = {[m
[31m-  Menunggu: {[m
[31m-    bg: "#FEF5E7",[m
[31m-    color: "#D69E2E",[m
[31m-    label: "Menunggu",[m
[31m-  },[m
[31m-  Diterima: {[m
[31m-    bg: "#E7FEED",[m
[31m-    color: "#47D62E",[m
[31m-    label: "Diterima",[m
[31m-  },[m
[31m-  Ditolak: {[m
[31m-    bg: "#FFDEDB",[m
[31m-    color: "#FF0000",[m
[31m-    label: "Ditolak",[m
[31m-  },[m
[31m-};[m
[32m+[m[32m/* =========================================================[m
[32m+[m[32m * Component[m
[32m+[m[32m * ========================================================= */[m
 [m
 export default function VerifikasiPersetujuan() {[m
   const [showDropdown, setShowDropdown] = useState(false);[m
   const [query, setQuery] = useState("");[m
[31m-  const dropdownRef = useRef();[m
[32m+[m[32m  const [queryDebounced, setQueryDebounced] = useState("");[m
[32m+[m[32m  const [rows, setRows] = useState([]);[m
[32m+[m[32m  const [typesMap, setTypesMap] = useState({});[m
[32m+[m[32m  const [loading, setLoading] = useState(true);[m
[32m+[m[32m  const [err, setErr] = useState("");[m
[32m+[m[32m  const [statusFilter, setStatusFilter] = useState("Semua");[m
[32m+[m
[32m+[m[32m  const dropdownRef = useRef(null);[m
[32m+[m[32m  const lastRequestId = useRef(0);[m
   const navigate = useNavigate();[m
   const location = useLocation();[m
[31m-  const adminName = "Admin rafi";[m
[32m+[m[32m  const adminName = localStorage.getItem("adminName") || "Admin";[m
 [m
[31m-  // Untuk update status Azida live ketika kembali dari detail[m
[31m-  const [azidaStatus, setAzidaStatus] = useState(getAzidaStatus());[m
[32m+[m[32m  const menuItems = [[m
[32m+[m[32m    { label: "Dashboard",                icon: "streamline-plump:user-pin-remix",   path: "/admin/dashboard" },[m
[32m+[m[32m    { label: "Verifikasi & Persetujuan", icon: "streamline-sharp:time-lapse-solid", path: "/admin/verifikasi" },[m
[32m+[m[32m    { label: "Kartu Visitor",            icon: "solar:card-recive-outline",         path: "/admin/kartu-visitor" },[m
[32m+[m[32m    { label: "Riwayat Pengembalian",     icon: "solar:card-search-broken",          path: "/admin/riwayat" },[m
[32m+[m[32m  ];[m
 [m
[31m-  // Refresh status Azida setiap kali kembali ke halaman ini[m
[31m-  React.useEffect(() => {[m
[31m-    const handleFocus = () => setAzidaStatus(getAzidaStatus());[m
[31m-    window.addEventListener("focus", handleFocus);[m
[31m-    return () => window.removeEventListener("focus", handleFocus);[m
[32m+[m[32m  // Kamus jenis kunjungan[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    (async () => {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const map = await getVisitTypeMap();[m
[32m+[m[32m        setTypesMap(map);[m
[32m+[m[32m      } catch {[m
[32m+[m[32m        setTypesMap({});[m
[32m+[m[32m      }[m
[32m+[m[32m    })();[m
   }, []);[m
 [m
[31m-  // List data dengan status Azida yang sudah pasti tidak blank[m
[31m-  const pengajuanList = [[m
[31m-    {[m
[31m-      ...dummyPengajuan[0],[m
[31m-      status: azidaStatus,[m
[31m-    },[m
[31m-    ...dummyPengajuan.slice(1),[m
[31m-  ];[m
[32m+[m[32m  // Debounce input pencarian (250ms)[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    const t = setTimeout(() => setQueryDebounced(query.trim()), 250);[m
[32m+[m[32m    return () => clearTimeout(t);[m
[32m+[m[32m  }, [query]);[m
 [m
[31m-  const filteredData = pengajuanList.filter((item) =>[m
[31m-    item.nama.toLowerCase().includes(query.toLowerCase())[m
[31m-  );[m
[32m+[m[32m  // Ambil daftar verifikasi semua status[m
[32m+[m[32m  const fetchList = async () => {[m
[32m+[m[32m    const reqId = ++lastRequestId.current;[m
[32m+[m[32m    setLoading(true);[m
[32m+[m[32m    setErr("");[m
[32m+[m[32m    try {[m
[32m+[m[32m      const res = await getVerificationsAll({ include: "documents,visitType" });[m
[32m+[m[32m      const payload = Array.isArray(res?.data) ? res.data : res?.data?.data || [];[m
 [m
[31m-  const menuItems = [[m
[31m-    {[m
[31m-      label: "Dashboard",[m
[31m-      icon: "streamline-plump:user-pin-remix",[m
[31m-      path: "/admin/dashboard",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Verifikasi & Persetujuan",[m
[31m-      icon: "streamline-sharp:time-lapse-solid",[m
[31m-      path: "/admin/verifikasi",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Kartu Visitor",[m
[31m-      icon: "solar:card-recive-outline",[m
[31m-      path: "/admin/kartu-visitor",[m
[31m-    },[m
[31m-    {[m
[31m-      label: "Riwayat Pengembalian",[m
[31m-      icon: "solar:card-search-broken",[m
[31m-      path: "/admin/riwayat",[m
[31m-    },[m
[31m-  ];[m
[32m+[m[32m      const list = payload.map((x) => {[m
[32m+[m[32m        const reference =[m
[32m+[m[32m          x.reference_number || x.reference || x.ref_no || x.ref || x.id || "";[m
 [m
[31m-  const handleMenuClick = (path) => {[m
[31m-    navigate(path);[m
[31m-  };[m
[32m+[m[32m        const nama = x.applicant_name || x.full_name || x.name || "-";[m
 [m
[31m-  const handleLogout = () => {[m
[31m-    navigate("/admin");[m
[31m-    setShowDropdown(false);[m
[32m+[m[32m        const jenisId  = x.visit_type_id ?? x.type_id ?? x.visit_type?.id ?? null;[m
[32m+[m[32m        const jenisRaw = x.visit_type_name || x.visit_type || x.type?.name || x.category;[m
[32m+[m[32m        const jenis    = jenisRaw || (jenisId && typesMap[jenisId]) || "-";[m
[32m+[m
[32m+[m[32m        const tanggalTampil =[m
[32m+[m[32m          x.visit_date || x.visit_start_date || x.date || x.created_at;[m
[32m+[m
[32m+[m[32m        const tanggalSortRaw =[m
[32m+[m[32m          x.created_at ||[m
[32m+[m[32m          x.submitted_at ||[m
[32m+[m[32m          x.updated_at ||[m
[32m+[m[32m          x.visit_start_date ||[m
[32m+[m[32m          x.visit_date ||[m
[32m+[m[32m          x.date;[m
[32m+[m
[32m+[m[32m        const docAny =[m
[32m+[m[32m          x.document_url ||[m
[32m+[m[32m          x.attachment_url ||[m
[32m+[m[32m          x.document_path ||[m
[32m+[m[32m          (Array.isArray(x.documents) ? (x.documents[0]?.url || x.documents[0]) : "") ||[m
[32m+[m[32m          x.document;[m
[32m+[m
[32m+[m[32m        const dokumenPath = docAny || null;[m
[32m+[m[32m        const dokumenUrl  = toFileURL(docAny) || null;[m
[32m+[m[32m        const dokumenName = x.document_original_name || x.original_name || filenameOf(docAny, "-");[m
[32m+[m
[32m+[m[32m        const statusRaw =[m
[32m+[m[32m          x.status ??[m
[32m+[m[32m          x.approval_status ??[m
[32m+[m[32m          x.review_status ??[m
[32m+[m[32m          x.state ??[m
[32m+[m[32m          x.application_status ??[m
[32m+[m[32m          "";[m
[32m+[m
[32m+[m[32m        const status = mapStatusID(statusRaw);[m
[32m+[m
[32m+[m[32m        const sortKey = (() => {[m
[32m+[m[32m          const d = new Date(tanggalSortRaw || tanggalTampil);[m
[32m+[m[32m          return isNaN(d) ? 0 : d.getTime();[m
[32m+[m[32m        })();[m
[32m+[m
[32m+[m[32m        return {[m
[32m+[m[32m          reference,[m
[32m+[m[32m          nama,[m
[32m+[m[32m          jenis,[m
[32m+[m[32m          tanggal: tanggalTampil,[m
[32m+[m[32m          dokumenUrl,[m
[32m+[m[32m          dokumenName,[m
[32m+[m[32m          dokumenPath,[m
[32m+[m[32m          status,[m
[32m+[m[32m          sortKey,[m
[32m+[m[32m        };[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      list.sort((a, b) => b.sortKey - a.sortKey);[m
[32m+[m[32m      if (reqId === lastRequestId.current) setRows(list);[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      if (reqId === lastRequestId.current) {[m
[32m+[m[32m        setErr(e?.response?.data?.message || e?.message || "Gagal memuat data verifikasi");[m
[32m+[m[32m      }[m
[32m+[m[32m    } finally {[m
[32m+[m[32m      if (reqId === lastRequestId.current) setLoading(false);[m
[32m+[m[32m    }[m
   };[m
 [m
[31m-  React.useEffect(() => {[m
[31m-    function handleClickOutside(event) {[m
[31m-      if ([m
[31m-        dropdownRef.current &&[m
[31m-        !dropdownRef.current.contains(event.target)[m
[31m-      ) {[m
[32m+[m[32m  useEffect(() => { fetchList(); /* eslint-disable-line */ }, [typesMap]);[m
[32m+[m
[32m+[m[32m  // refresh saat tab fokus kembali[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    const onFocus = () => fetchList();[m
[32m+[m[32m    window.addEventListener("focus", onFocus);[m
[32m+[m[32m    return () => window.removeEventListener("focus", onFocus);[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  // refresh saat ada event perubahan (misal sesudah approve/reject dari halaman detail)[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    const onDirty = (e) => {[m
[32m+[m[32m      if (!e?.detail || e.detail.type === "verification") {[m
[32m+[m[32m        fetchList();[m
[32m+[m[32m      }[m
[32m+[m[32m    };[m
[32m+[m[32m    window.addEventListener("app:data-dirty", onDirty);[m
[32m+[m[32m    return () => window.removeEventListener("app:data-dirty", onDirty);[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  // tutup dropdown saat klik di luar[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    function handleClickOutside(e) {[m
[32m+[m[32m      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {[m
         setShowDropdown(false);[m
       }[m
     }[m
[36m@@ -152,9 +241,57 @@[m [mexport default function VerifikasiPersetujuan() {[m
     return () => document.removeEventListener("mousedown", handleClickOutside);[m
   }, []);[m
 [m
[31m-  // Untuk simulasi membuka file dummy[m
[31m-  const handleLihatDokumen = (file) => {[m
[31m-    alert(`File: ${file} terbuka (dummy)`);[m
[32m+[m[32m  // search & filter[m
[32m+[m[32m  const searched = useMemo(() => {[m
[32m+[m[32m    const qq = queryDebounced.toLowerCase();[m
[32m+[m[32m    if (!qq) return rows;[m
[32m+[m[32m    return rows.filter((r) =>[m
[32m+[m[32m      [r.nama || "", r.jenis || "", r.reference || ""][m
[32m+[m[32m        .join(" ")[m
[32m+[m[32m        .toLowerCase()[m
[32m+[m[32m        .includes(qq)[m
[32m+[m[32m    );[m
[32m+[m[32m  }, [rows, queryDebounced]);[m
[32m+[m
[32m+[m[32m  const filtered = useMemo(() => {[m
[32m+[m[32m    if (statusFilter === "Semua") return searched;[m
[32m+[m[32m    return searched.filter((r) => r.status === statusFilter);[m
[32m+[m[32m  }, [searched, statusFilter]);[m
[32m+[m
[32m+[m[32m  // stat counters[m
[32m+[m[32m  const pendingCount  = useMemo(() => rows.filter((r) => r.status === "Menunggu").length, [rows]);[m
[32m+[m[32m  const approvedCount = useMemo(() => rows.filter((r) => r.status === "Disetujui").length, [rows]);[m
[32m+[m[32m  const rejectedCount = useMemo(() => rows.filter((r) => r.status === "Ditolak").length, [rows]);[m
[32m+[m
[32m+[m[32m  const handleMenuClick = (path) => navigate(path);[m
[32m+[m
[32m+[m[32m  const handleLogout = async () => {[m
[32m+[m[32m    try { await adminLogout(); } catch {}[m
[32m+[m[32m    localStorage.removeItem("token");[m
[32m+[m[32m    localStorage.removeItem("adminName");[m
[32m+[m[32m    navigate("/admin");[m
[32m+[m[32m    setShowDropdown(false);[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  const onOpenDoc = async (row, e) => {[m
[32m+[m[32m    e.preventDefault();[m
[32m+[m[32m    if (!row?.dokumenPath && !row?.dokumenUrl) return;[m
[32m+[m
[32m+[m[32m    try {[m
[32m+[m[32m      const resp = await fetchDocumentBlob(row.dokumenPath || row.dokumenUrl);[m
[32m+[m[32m      const blobUrl = URL.createObjectURL(resp.data);[m
[32m+[m[32m      window.open(blobUrl, "_blank", "noopener,noreferrer");[m
[32m+[m
[32m+[m[32m      const name =[m
[32m+[m[32m        filenameFromHeaders(resp, row.dokumenName) || row.dokumenName || "dokumen";[m
[32m+[m[32m      try {[m
[32m+[m[32m        const a = document.createElement("a");[m
[32m+[m[32m        a.href = blobUrl;[m
[32m+[m[32m        a.download = name;[m
[32m+[m[32m      } catch {}[m
[32m+[m[32m    } catch {[m
[32m+[m[32m      if (row.dokumenUrl) window.open(row.dokumenUrl, "_blank", "noopener,noreferrer");[m
[32m+[m[32m    }[m
   };[m
 [m
   return ([m
[36m@@ -165,31 +302,30 @@[m [mexport default function VerifikasiPersetujuan() {[m
         style={{ width: 360 }}[m
       >[m
         <img src={kaiLogo} alt="KAI Logo" className="w-[120px] mb-6 mx-auto" />[m
[31m-        <div className="text-[18px] font-poppins font-medium text-[#242424] text-center mb-7 leading-[20px]">[m
[32m+[m[32m        <div className="text:[18px] font-poppins font-medium text-[#242424] text-center mb-7 leading-[20px]">[m
           Admin Panel Kartu Visitor[m
         </div>[m
         <div className="w-full flex justify-center mb-12">[m
[31m-          <div[m
[31m-            style={{[m
[31m-              width: "100%",[m
[31m-              height: 2,[m
[31m-              background: "#C4C4C4",[m
[31m-              borderRadius: 2,[m
[31m-              margin: "0 auto",[m
[31m-            }}[m
[31m-          />[m
[32m+[m[32m          <div style={{ width: "100%", height: 2, background: "#C4C4C4", borderRadius: 2, margin: "0 auto" }} />[m
         </div>[m
[32m+[m
         <nav className="flex flex-col gap-4 mt-2">[m
[31m-          {menuItems.map((item) => {[m
[32m+[m[32m          {[[m
[32m+[m[32m            { label: "Dashboard", icon: "streamline-plump:user-pin-remix", path: "/admin/dashboard" },[m
[32m+[m[32m            { label: "Verifikasi & Persetujuan", icon: "streamline-sharp:time-lapse-solid", path: "/admin/verifikasi" },[m
[32m+[m[32m            { label: "Kartu Visitor", icon: "solar:card-recive-outline", path: "/admin/kartu-visitor" },[m
[32m+[m[32m            { label: "Riwayat Pengembalian", icon: "solar:card-search-broken", path: "/admin/riwayat" },[m
[32m+[m[32m          ].map((item) => {[m
             const isActive = location.pathname === item.path;[m
             return ([m
               <button[m
                 key={item.label}[m
                 onClick={() => handleMenuClick(item.path)}[m
                 className={`flex items-center gap-4 px-4 py-2 text-left transition-all hover:opacity-80[m
[31m-                  ${isActive[m
[31m-                    ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]"[m
[31m-                    : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"[m
[32m+[m[32m                  ${[m
[32m+[m[32m                    isActive[m
[32m+[m[32m                      ? "bg-gradient-to-r from-[#6A8BB0] to-[#5E5BAD] text-white font-semibold rounded-[15px]"[m
[32m+[m[32m                      : "bg-transparent text-[#474646] font-semibold hover:bg-gray-100 rounded-[15px]"[m
                   } text-[17px]`}[m
                 style={isActive ? { boxShadow: "0 2px 8px rgba(90,90,140,0.07)" } : {}}[m
               >[m
[36m@@ -208,7 +344,7 @@[m [mexport default function VerifikasiPersetujuan() {[m
         className="flex-1 flex flex-col px-2 md:px-12 py-10 transition-all"[m
         style={{ marginLeft: 360, minHeight: "100vh", width: "100%" }}[m
       >[m
[31m-        {/* Top Card */}[m
[32m+[m[32m        {/* Header */}[m
         <div className="flex gap-8 mb-10 flex-wrap">[m
           <div[m
             className="w-full max-w-[900px] flex items-center bg-white rounded-[20px] shadow-md px-8 py-4 relative mx-auto"[m
[36m@@ -217,36 +353,27 @@[m [mexport default function VerifikasiPersetujuan() {[m
             <span className="font-poppins font-semibold text-[24px] text-[#474646]">[m
               Verifikasi & Persetujuan[m
             </span>[m
[31m-            <div[m
[31m-              className="relative ml-auto"[m
[31m-              style={{ minWidth: 200 }}[m
[31m-              ref={dropdownRef}[m
[31m-            >[m
[32m+[m
[32m+[m[32m            <div className="relative ml-auto" style={{ minWidth: 200 }} ref={dropdownRef}>[m
               <div[m
                 className="absolute top-0 left-0 w-full h-full"[m
[31m-                style={{[m
[31m-                  background: "rgba(106,139,176,0.13)",[m
[31m-                  borderRadius: 15,[m
[31m-                  zIndex: 0,[m
[31m-                }}[m
[31m-              ></div>[m
[32m+[m[32m                style={{ background: "rgba(106,139,176,0.13)", borderRadius: 15, zIndex: 0 }}[m
[32m+[m[32m              />[m
               <button[m
                 className="relative flex items-center gap-2 px-5 py-2 cursor-pointer z-10 hover:opacity-80 transition-opacity"[m
[31m-                style={{[m
[31m-                  borderRadius: 15,[m
[31m-                  background: "transparent",[m
[31m-                }}[m
[32m+[m[32m                style={{ borderRadius: 15, background: "transparent" }}[m
                 onClick={() => setShowDropdown((prev) => !prev)}[m
               >[m
                 <span className="w-[38px] h-[38px] rounded-full bg-[#6A8BB0] flex items-center justify-center text-white text-[24px] font-poppins font-semibold mr-2">[m
[31m-                  {adminName[0]}[m
[32m+[m[32m                  {(adminName[0] || "A").toUpperCase()}[m
                 </span>[m
                 <span className="font-poppins font-medium text-[18px] leading-[36px] text-[#474646]">[m
                   {adminName}[m
                 </span>[m
               </button>[m
[32m+[m
               {showDropdown && ([m
[31m-                <div className="absolute top-[62px] right-0 bg-white rounded-[12px] shadow-lg px-6 py-3 z-20 border min-w-[146px] flex items-center gap-3">[m
[32m+[m[32m                <div className="absolute top:[62px] right-0 bg-white rounded-[12px] shadow-lg px-6 py-3 z-20 border min-w-[146px] flex items-center gap-3">[m
                   <Icon icon="ic:round-logout" width={34} color="#d61d1d" />[m
                   <button[m
                     className="w-full text-left text-[#474646] font-poppins font-medium text-[18px] py-2 hover:bg-[#F1F2F6] rounded-md transition-colors"[m
[36m@@ -260,26 +387,66 @@[m [mexport default function VerifikasiPersetujuan() {[m
           </div>[m
         </div>[m
 [m
[31m-        {/* Card Table Section */}[m
[32m+[m[32m        {/* Error */}[m
[32m+[m[32m        {err && ([m
[32m+[m[32m          <div className="max-w-[900px] mx-auto w-full mb-6">[m
[32m+[m[32m            <div className="bg-red-50 text-red-700 px-4 py-3 rounded-lg border border-red-200">[m
[32m+[m[32m              {err}[m
[32m+[m[32m            </div>[m
[32m+[m[32m          </div>[m
[32m+[m[32m        )}[m
[32m+[m
[32m+[m[32m        {/* Table Section */}[m
         <div[m
           className="mx-auto bg-[#fff] rounded-[20px] shadow-md px-8 py-7"[m
           style={{ borderRadius: 20, width: "100%", maxWidth: 900 }}[m
         >[m
[31m-          {/* Search & Menunggu Count */}[m
[31m-          <div className="flex items-center mb-5">[m
[31m-            <div className="flex items-center flex-1 bg-white px-4 py-2 rounded-[11px] border border-[#E4E4E4] mr-3" style={{ maxWidth: 360 }}>[m
[31m-              <Icon icon="ic:round-search" width={28} color="#474646" className="mr-2" />[m
[32m+[m[32m          {/* Search + Status Filter + Counters */}[m
[32m+[m[32m          <div className="flex flex-col gap-3 md:flex-row md:items-center mb-5">[m
[32m+[m[32m            <div[m
[32m+[m[32m              className="flex items-center flex-1 bg-white px-4 py-2 rounded-[11px] border border-[#E4E4E4] md:mr-3"[m
[32m+[m[32m              style={{ maxWidth: 520 }}[m
[32m+[m[32m            >[m
[32m+[m[32m              <Icon icon="ic:round-search" width={28} color="#474646} " className="mr-2" />[m
               <input[m
                 type="text"[m
[31m-                placeholder="cari berdasarkan nama pemohon"[m
[32m+[m[32m                placeholder="Cari nama / jenis kunjungan / referensi"[m
                 value={query}[m
[31m-                onChange={e => setQuery(e.target.value)}[m
[32m+[m[32m                onChange={(e) => setQuery(e.target.value)}[m
                 className="flex-1 outline-none bg-transparent border-0 text-[17px] font-poppins font-light italic text-[#474646]"[m
                 style={{ fontStyle: "italic", fontWeight: 300 }}[m
               />[m
             </div>[m
[31m-            <div className="font-poppins font-medium text-[#474646] text-[18px] ml-auto">[m
[31m-              Menunggu : {pengajuanList.filter(d => d.status === "Menunggu").length}[m
[32m+[m
[32m+[m[32m            <div className="flex gap-2 flex-wrap">[m
[32m+[m[32m              {["Semua", "Menunggu", "Disetujui", "Ditolak"].map((s) => ([m
[32m+[m[32m                <button[m
[32m+[m[32m                  key={s}[m
[32m+[m[32m                  onClick={() => setStatusFilter(s)}[m
[32m+[m[32m                  className="px-3 py-1 rounded-[10px] text-[14px] font-poppins font-medium border"[m
[32m+[m[32m                  style={{[m
[32m+[m[32m                    background:[m
[32m+[m[32m                      s === "Semua"[m
[32m+[m[32m                        ? "#F4F4F4"[m
[32m+[m[32m                        : statusConfig[s]?.bg || "#F4F4F4",[m
[32m+[m[32m                    color:[m
[32m+[m[32m                      s === "Semua"[m
[32m+[m[32m                        ? "#474646"[m
[32m+[m[32m                        : statusConfig[s]?.color || "#474646",[m
[32m+[m[32m                    borderColor: s === statusFilter ? "#6A8BB0" : "#E4E4E4",[m
[32m+[m[32m                  }}[m
[32m+[m[32m                  title={`Tampilkan ${s.toLowerCase()}`}[m
[32m+[m[32m                >[m
[32m+[m[32m                  {s}[m
[32m+[m[32m                  {s === "Semua"[m
[32m+[m[32m                    ? ""[m
[32m+[m[32m                    : s === "Menunggu"[m
[32m+[m[32m                    ? ` (${pendingCount})`[m
[32m+[m[32m                    : s === "Disetujui"[m
[32m+[m[32m                    ? ` (${approvedCount})`[m
[32m+[m[32m                    : ` (${rejectedCount})`}[m
[32m+[m[32m                </button>[m
[32m+[m[32m              ))}[m
             </div>[m
           </div>[m
 [m
[36m@@ -288,61 +455,98 @@[m [mexport default function VerifikasiPersetujuan() {[m
             <table className="w-full">[m
               <thead>[m
                 <tr style={{ background: "#F4F4F4" }}>[m
[31m-                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Nama Pemohon</th>[m
[31m-                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Jenis Kunjungan</th>[m
[31m-                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Tanggal Kunjungan</th>[m
[31m-                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Dokumen</th>[m
[31m-                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Status</th>[m
[31m-                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">Aksi</th>[m
[32m+[m[32m                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[32m+[m[32m                    Nama<br />Pemohon[m
[32m+[m[32m                  </th>[m
[32m+[m[32m                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[32m+[m[32m                    Jenis<br />Kunjungan[m
[32m+[m[32m                  </th>[m
[32m+[m[32m                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[32m+[m[32m                    Tanggal<br />Kunjungan[m
[32m+[m[32m                  </th>[m
[32m+[m[32m                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[32m+[m[32m                    Dokumen[m
[32m+[m[32m                  </th>[m
[32m+[m[32m                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[32m+[m[32m                    Status[m
[32m+[m[32m                  </th>[m
[32m+[m[32m                  <th className="py-3 px-2 text-center font-poppins font-semibold text-[#474646] text-[16px]">[m
[32m+[m[32m                    Aksi[m
[32m+[m[32m                  </th>[m
                 </tr>[m
               </thead>[m
[32m+[m
               <tbody>[m
[31m-                {filteredData.map((row, idx) => ([m
[31m-                  <tr key={idx} className={idx % 2 === 0 ? '' : 'bg-[#F8F8F8]'}>[m
[31m-                    <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">{row.nama}</td>[m
[31m-                    <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">{row.jenis}</td>[m
[31m-                    <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">{row.tanggal}</td>[m
[31m-                    <td className="py-2 px-2 text-center">[m
[31m-                      <button[m
[31m-                        className="px-5 py-1 font-poppins font-semibold text-white text-[15px] rounded-[9px] transition-all"[m
[31m-                        style={{[m
[31m-                          background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
[31m-                          boxShadow: "0 2px 8px rgba(90,90,140,0.07)",[m
[31m-                        }}[m
[31m-                        onClick={() => handleLihatDokumen(row.dokumen)}[m
[31m-                      >[m
[31m-                        Lihat[m
[31m-                      </button>[m
[31m-                    </td>[m
[31m-                    <td className="py-2 px-2 text-center">[m
[31m-                      <div[m
[31m-                        className="status-btn font-poppins font-semibold text-[15px] px-5 py-1 rounded-[8px]"[m
[31m-                        style={{[m
[31m-                          background: statusConfig[row.status]?.bg || "#eee",[m
[31m-                          color: statusConfig[row.status]?.color || "#555",[m
[31m-                          minWidth: "110px",[m
[31m-                          display: "inline-flex",[m
[31m-                          justifyContent: "center",[m
[31m-                          alignItems: "center",[m
[31m-                        }}[m
[31m-                      >[m
[31m-                        {statusConfig[row.status]?.label || row.status || "-"}[m
[31m-                      </div>[m
[31m-                    </td>[m
[31m-                    <td className="py-2 px-2 text-center">[m
[31m-                      <button[m
[31m-                        className="px-5 py-1 font-poppins font-semibold text-white text-[15px] rounded-[8px] transition-all"[m
[31m-                        style={{[m
[31m-                          background: "#8E8E8E",[m
[31m-                        }}[m
[31m-                        onClick={() => navigate("/admin/form-detail")}[m
[31m-                      >[m
[31m-                        Detail[m
[31m-                      </button>[m
[31m-                    </td>[m
[31m-                  </tr>[m
[31m-                ))}[m
[31m-                {filteredData.length === 0 && ([m
[32m+[m[32m                {loading ? ([m
[32m+[m[32m                  Array.from({ length: 5 }).map((_, i) => ([m
[32m+[m[32m                    <tr key={`sk-${i}`}>[m
[32m+[m[32m                      {Array.from({ length: 6 }).map((__, j) => ([m
[32m+[m[32m                        <td key={j} className="py-3 px-2">[m
[32m+[m[32m                          <span className="block w-full h-5 bg-gray-200 animate-pulse rounded" />[m
[32m+[m[32m                        </td>[m
[32m+[m[32m                      ))}[m
[32m+[m[32m                    </tr>[m
[32m+[m[32m                  ))[m
[32m+[m[32m                ) : filtered.length > 0 ? ([m
[32m+[m[32m                  filtered.map((row, idx) => ([m
[32m+[m[32m                    <tr key={row.reference || `${row.nama}-${idx}`} className={idx % 2 === 0 ? "" : "bg-[#F8F8F8]"}>[m
[32m+[m[32m                      <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">[m
[32m+[m[32m                        {row.nama}[m
[32m+[m[32m                      </td>[m
[32m+[m[32m                      <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">[m
[32m+[m[32m                        {row.jenis}[m
[32m+[m[32m                      </td>[m
[32m+[m[32m                      <td className="py-2 px-2 text-center font-poppins font-semibold text-[15px] text-[#474646]">[m
[32m+[m[32m                        {formatTanggal(row.tanggal)}[m
[32m+[m[32m                      </td>[m
[32m+[m
[32m+[m[32m                      <td className="py-2 px-2 text-center">[m
[32m+[m[32m                        {row.dokumenUrl ? ([m
[32m+[m[32m                          <a[m
[32m+[m[32m                            href={row.dokumenUrl}[m
[32m+[m[32m                            target="_blank"[m
[32m+[m[32m                            rel="noopener noreferrer"[m
[32m+[m[32m                            onClick={(e) => onOpenDoc(row, e)}[m
[32m+[m[32m                            className="font-poppins font-semibold text-[15px]"[m
[32m+[m[32m                            style={{ color: "#1E3A8A", textDecoration: "underline" }}[m
[32m+[m[32m                            title={row.dokumenName}[m
[32m+[m[32m                          >[m
[32m+[m[32m                            Lihat[m
[32m+[m[32m                          </a>[m
[32m+[m[32m                        ) : ([m
[32m+[m[32m                          <span className="text-[#999]">-</span>[m
[32m+[m[32m                        )}[m
[32m+[m[32m                      </td>[m
[32m+[m
[32m+[m[32m                      <td className="py-2 px-2 text-center">[m
[32m+[m[32m                        <div[m
[32m+[m[32m                          className="font-poppins font-semibold text:[15px] px-5 py-1 rounded-[8px] inline-flex justify-center items-center"[m
[32m+[m[32m                          style={{[m
[32m+[m[32m                            background: statusConfig[row.status]?.bg || "#eee",[m
[32m+[m[32m                            color: statusConfig[row.status]?.color || "#555",[m
[32m+[m[32m                            minWidth: "110px",[m
[32m+[m[32m                          }}[m
[32m+[m[32m                        >[m
[32m+[m[32m                          {statusConfig[row.status]?.label || row.status || "-"}[m
[32m+[m[32m                        </div>[m
[32m+[m[32m                      </td>[m
[32m+[m
[32m+[m[32m                      <td className="py-2 px-2 text-center">[m
[32m+[m[32m                        <button[m
[32m+[m[32m                          className="px-5 py-1 font-poppins font-semibold text-white text-[15px] rounded-[8px] transition-all"[m
[32m+[m[32m                          style={{ background: "#8E8E8E" }}[m
[32m+[m[32m                          onClick={() =>[m
[32m+[m[32m                            navigate(`/admin/detail/${encodeURIComponent(row.reference || "")}`)[m
[32m+[m[32m                          }[m
[32m+[m[32m                          disabled={!row.reference}[m
[32m+[m[32m                          title={!row.reference ? "Reference tidak tersedia" : "Lihat Detail"}[m
[32m+[m[32m                        >[m
[32m+[m[32m                          Detail[m
[32m+[m[32m                        </button>[m
[32m+[m[32m                      </td>[m
[32m+[m[32m                    </tr>[m
[32m+[m[32m                  ))[m
[32m+[m[32m                ) : ([m
                   <tr>[m
                     <td colSpan={6} className="text-center py-6 text-[#aaa] font-poppins font-medium">[m
                       Tidak ada data ditemukan.[m
[36m@@ -355,13 +559,11 @@[m [mexport default function VerifikasiPersetujuan() {[m
         </div>[m
       </main>[m
 [m
[31m-      {/* Font import dan custom CSS */}[m
       <style>{`[m
         @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');[m
         .font-poppins { font-family: 'Poppins', sans-serif; }[m
         input::placeholder { font-family: 'Poppins', sans-serif; font-weight: 300; font-style: italic; }[m
         body { overflow-x: hidden; }[m
[31m-        .status-btn { min-width: 110px; text-align: center; }[m
         @media (max-width: 900px) {[m
           aside { width: 100vw !important; position: static !important; }[m
           main { margin-left: 0 !important; }[m
[36m@@ -369,4 +571,4 @@[m [mexport default function VerifikasiPersetujuan() {[m
       `}</style>[m
     </div>[m
   );[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
[1mdiff --git a/src/admin/index.js b/src/admin/index.js[m
[1mindex 81ef65f..39880d8 100644[m
[1m--- a/src/admin/index.js[m
[1m+++ b/src/admin/index.js[m
[36m@@ -1,5 +1,123 @@[m
[31m-export { default as AdminLogin } from './AdminLogin';[m
[31m-export { default as Dashboard } from './Dashboard';[m
[31m-export { default as VerifikasiPersetujuan } from './VerifikasiPersetujuan';[m
[31m-export { default as KartuVisitor } from './KartuVisitor';[m
[31m-export { default as RiwayatPengembalian } from './RiwayatPengembalian';[m
\ No newline at end of file[m
[32m+[m[32m// src/admin/index.js[m
[32m+[m[32mimport React, { Component } from "react";[m
[32m+[m[32mimport { Navigate, useLocation } from "react-router-dom";[m
[32m+[m[32mimport { loadTokenFromStorage } from "../api";[m
[32m+[m
[32m+[m[32m// Pastikan mengarah ke komponen TERBARU (all-status)[m
[32m+[m[32mexport { default as AdminLogin } from "./AdminLogin";[m
[32m+[m[32mexport { default as Dashboard } from "./Dashboard";[m
[32m+[m[32mexport { default as VerifikasiPersetujuan } from "./VerifikasiPersetujuan";[m
[32m+[m[32mexport { default as KartuVisitor } from "./KartuVisitor";[m
[32m+[m[32mexport { default as RiwayatPengembalian } from "./RiwayatPengembalian";[m
[32m+[m
[32m+[m[32m// Set Authorization header dari localStorage saat bootstrap[m
[32m+[m[32mloadTokenFromStorage();[m
[32m+[m
[32m+[m[32m/* =====================================================[m
[32m+[m[32m * Error Boundary tanpa JSX[m
[32m+[m[32m * ===================================================== */[m
[32m+[m[32mexport class ErrorBoundary extends Component {[m
[32m+[m[32m  constructor(props) {[m
[32m+[m[32m    super(props);[m
[32m+[m[32m    this.state = { hasError: false, error: null, info: null };[m
[32m+[m[32m    this.handleRetry = this.handleRetry.bind(this);[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  static getDerivedStateFromError(error) {[m
[32m+[m[32m    return { hasError: true, error };[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  componentDidCatch(error, info) {[m
[32m+[m[32m    this.setState({ info });[m
[32m+[m[32m    // (opsional) kirim ke logging/monitoring[m
[32m+[m[32m    // console.error("Page error:", error, info);[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  handleRetry() {[m
[32m+[m[32m    this.setState({ hasError: false, error: null, info: null });[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  render() {[m
[32m+[m[32m    if (this.state.hasError) {[m
[32m+[m[32m      const outerStyle = {[m
[32m+[m[32m        minHeight: "100vh",[m
[32m+[m[32m        display: "flex",[m
[32m+[m[32m        alignItems: "center",[m
[32m+[m[32m        justifyContent: "center",[m
[32m+[m[32m        background: "#f7f7fb",[m
[32m+[m[32m        padding: 24,[m
[32m+[m[32m      };[m
[32m+[m[32m      const cardStyle = {[m
[32m+[m[32m        background: "#fff",[m
[32m+[m[32m        border: "1px solid #eee",[m
[32m+[m[32m        borderRadius: 12,[m
[32m+[m[32m        padding: "20px 24px",[m
[32m+[m[32m        boxShadow: "0 2px 12px rgba(0,0,0,0.06)",[m
[32m+[m[32m        maxWidth: 520,[m
[32m+[m[32m        width: "100%",[m
[32m+[m[32m        fontFamily: "Poppins, sans-serif",[m
[32m+[m[32m        color: "#474646",[m
[32m+[m[32m      };[m
[32m+[m[32m      const titleStyle = { margin: "0 0 10px", fontWeight: 700, fontSize: 20 };[m
[32m+[m[32m      const descStyle = { fontSize: 14, marginBottom: 16 };[m
[32m+[m[32m      const btnStyle = {[m
[32m+[m[32m        padding: "10px 14px",[m
[32m+[m[32m        borderRadius: 8,[m
[32m+[m[32m        border: "none",[m
[32m+[m[32m        color: "#fff",[m
[32m+[m[32m        cursor: "pointer",[m
[32m+[m[32m        background: "linear-gradient(90deg, #6A8BB0 0%, #5E5BAD 100%)",[m
[32m+[m[32m        fontWeight: 600,[m
[32m+[m[32m      };[m
[32m+[m
[32m+[m[32m      return React.createElement([m
[32m+[m[32m        "div",[m
[32m+[m[32m        { style: outerStyle },[m
[32m+[m[32m        React.createElement([m
[32m+[m[32m          "div",[m
[32m+[m[32m          { style: cardStyle },[m
[32m+[m[32m          React.createElement("h3", { style: titleStyle }, "Terjadi kesalahan saat memuat halaman"),[m
[32m+[m[32m          React.createElement([m
[32m+[m[32m            "div",[m
[32m+[m[32m            { style: descStyle },[m
[32m+[m[32m            this.state.error && this.state.error.message[m
[32m+[m[32m              ? this.state.error.message[m
[32m+[m[32m              : "Error tidak diketahui."[m
[32m+[m[32m          ),[m
[32m+[m[32m          React.createElement([m
[32m+[m[32m            "button",[m
[32m+[m[32m            { onClick: this.handleRetry, style: btnStyle },[m
[32m+[m[32m            "Coba Lagi"[m
[32m+[m[32m          )[m
[32m+[m[32m        )[m
[32m+[m[32m      );[m
[32m+[m[32m    }[m
[32m+[m[32m    return this.props.children;[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =====================================================[m
[32m+[m[32m * HOC untuk membungkus halaman dengan ErrorBoundary (tanpa JSX)[m
[32m+[m[32m * Remount per route dengan key: location.key[m
[32m+[m[32m * ===================================================== */[m
[32m+[m[32mexport function withBoundary(ComponentToWrap) {[m
[32m+[m[32m  return function WrappedWithBoundary(props) {[m
[32m+[m[32m    const location = useLocation();[m
[32m+[m[32m    return React.createElement([m
[32m+[m[32m      ErrorBoundary,[m
[32m+[m[32m      { key: location.key },[m
[32m+[m[32m      React.createElement(ComponentToWrap, { ...props })[m
[32m+[m[32m    );[m
[32m+[m[32m  };[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m/* =====================================================[m
[32m+[m[32m * ProtectedRoute â€” tanpa side-effect saat render (tanpa JSX)[m
[32m+[m[32m * ===================================================== */[m
[32m+[m[32mexport function ProtectedRoute({ children }) {[m
[32m+[m[32m  const token = localStorage.getItem("token");[m
[32m+[m[32m  if (!token) {[m
[32m+[m[32m    return React.createElement(Navigate, { to: "/admin", replace: true });[m
[32m+[m[32m  }[m
[32m+[m[32m  return React.createElement(React.Fragment, null, children);[m
[32m+[m[32m}[m
[1mdiff --git a/src/api.js b/src/api.js[m
[1mindex ba5c4f7..66e866e 100644[m
[1m--- a/src/api.js[m
[1m+++ b/src/api.js[m
[36m@@ -1,105 +1,425 @@[m
[32m+[m[32m// src/api.js[m
 import axios from "axios";[m
 [m
[31m-const API_BASE = import.meta.env.VITE_API_BASE || "http://localhost:8000/api";[m
[31m-[m
[31m-// --- PUBLIC ENDPOINTS ---[m
[31m-export const getVisitTypes = () => axios.get(`${API_BASE}/public/visit-types`);[m
[31m-export const getStations = () => axios.get(`${API_BASE}/public/stations`);[m
[31m-export const submitVisitorCard = (data) => axios.post(`${API_BASE}/public/visitor-cards`, data);[m
[31m-export const getVisitorCard = (id) => axios.get(`${API_BASE}/public/visitor-cards/${id}`);[m
[31m-export const checkStatus = (data) => axios.post(`${API_BASE}/public/check-status`, data);[m
[31m-export const getVisitorCardDetail = (id) => axios.get(`${API_BASE}/public/visitor-cards/${id}/detail`);[m
[31m-export const getStatusLogs = () => axios.get(`${API_BASE}/public/status-logs`);[m
[31m-export const cancelApplication = (data) => axios.post(`${API_BASE}/public/cancel-application`, data);[m
[31m-export const resubmitApplication = (data) => axios.post(`${API_BASE}/public/resubmit-application`, data);[m
[31m-[m
[31m-// --- ADMIN ENDPOINTS ---[m
[31m-export const adminLogin = (data) => axios.post(`${API_BASE}/admin/login`, data);[m
[31m-export const adminLogout = () => axios.post(`${API_BASE}/admin/logout`);[m
[31m-export const getAdminMe = () => axios.get(`${API_BASE}/admin/me`);[m
[31m-[m
[31m-// Dashboard[m
[31m-export const getActiveVisitors = () => axios.get(`${API_BASE}/admin/dashboard/active-visitors`);[m
[31m-export const getPendingCount = () => axios.get(`${API_BASE}/admin/dashboard/pending-count`);[m
[31m-export const getTodayIssued = () => axios.get(`${API_BASE}/admin/dashboard/today-issued`);[m
[31m-export const getTodayReturned = () => axios.get(`${API_BASE}/admin/dashboard/today-returned`);[m
[31m-export const getDamagedCards = () => axios.get(`${API_BASE}/admin/dashboard/damaged-cards`);[m
[31m-export const getLostCards = () => axios.get(`${API_BASE}/admin/dashboard/lost-cards`);[m
[31m-[m
[31m-// Verifikasi[m
[31m-export const getPendingVerifications = () => axios.get(`${API_BASE}/admin/verification/pending`);[m
[31m-export const getVerificationDetail = (data) => axios.post(`${API_BASE}/admin/verification/detail`, data);[m
[31m-export const approveVerification = (data) => axios.post(`${API_BASE}/admin/verification/approve`, data);[m
[31m-export const rejectVerification = (data) => axios.post(`${API_BASE}/admin/verification/reject`, data);[m
[31m-export const bulkVerificationAction = (data) => axios.post(`${API_BASE}/admin/verification/bulk-action`, data);[m
[31m-[m
[31m-// Kartu Visitor[m
[31m-export const getApprovedCards = () => axios.get(`${API_BASE}/admin/cards/approved`);[m
[31m-export const getActiveCards = () => axios.get(`${API_BASE}/admin/cards/active`);[m
[31m-export const getReturnedCards = () => axios.get(`${API_BASE}/admin/cards/returned`);[m
[31m-export const issueCard = (data) => axios.post(`${API_BASE}/admin/cards/issue`, data);[m
[31m-export const returnCard = (data) => axios.post(`${API_BASE}/admin/cards/return`, data);[m
[31m-export const editCardCondition = (id, data) => axios.put(`${API_BASE}/admin/cards/${id}/condition`, data);[m
[31m-[m
[31m-// Export & Reporting[m
[31m-export const exportStationDailyFlow = () => axios.get(`${API_BASE}/admin/reports/station-daily-flow`);[m
[31m-export const exportAll = () => axios.get(`${API_BASE}/admin/reports/export-all`);[m
[31m-export const exportDailyFlow = () => axios.get(`${API_BASE}/admin/reports/daily-flow`);[m
[31m-export const exportWeeklyFlow = () => axios.get(`${API_BASE}/admin/reports/weekly-flow`);[m
[31m-export const exportMonthlyFlow = () => axios.get(`${API_BASE}/admin/reports/monthly-flow`);[m
[31m-export const exportYearlyFlow = () => axios.get(`${API_BASE}/admin/reports/yearly-flow`);[m
[31m-export const exportCardCondition = () => axios.get(`${API_BASE}/admin/reports/card-condition`);[m
[31m-[m
[31m-// CRUD Resources (admin)[m
[32m+[m[32mexport const API_BASE =[m
[32m+[m[32m  import.meta.env.VITE_API_BASE || "http://localhost:8000/api";[m
[32m+[m
[32m+[m[32mexport const ORIGIN = API_BASE.replace(/\/api\/?$/, "");[m
[32m+[m
[32m+[m[32m// Export helper untuk download blob[m
[32m+[m[32mexport const downloadBlob = (blob, filename) => {[m
[32m+[m[32m  const url = URL.createObjectURL(blob);[m
[32m+[m[32m  const a = document.createElement("a");[m
[32m+[m[32m  a.href = url;[m
[32m+[m[32m  a.download = filename;[m
[32m+[m[32m  document.body.appendChild(a);[m
[32m+[m[32m  a.click();[m
[32m+[m[32m  a.remove();[m
[32m+[m[32m  URL.revokeObjectURL(url);[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32m// storage/uploads -> absolute URL helper[m
[32m+[m[32mconst absoluteStorageURL = (path) => {[m
[32m+[m[32m  if (!path) return null;[m
[32m+[m[32m  if (/^https?:\/\//i.test(path)) return path;[m
[32m+[m[32m  const clean = String(path).replace(/^\/+/, "");[m
[32m+[m[32m  const finalPath =[m
[32m+[m[32m    clean.startsWith("storage/") || clean.startsWith("uploads/")[m
[32m+[m[32m      ? clean[m
[32m+[m[32m      : `storage/${clean}`;[m
[32m+[m[32m  return `${ORIGIN}/${finalPath}`;[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32mconst http = axios.create({[m
[32m+[m[32m  baseURL: API_BASE,[m
[32m+[m[32m  timeout: 30000,[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32m// ===== Simple in-memory GET cache (TTL) with small eviction =====[m
[32m+[m[32mconst __getCache = new Map();[m
[32m+[m[32mfunction makeKey(url, params) {[m
[32m+[m[32m  const p = params ? stableStringifyParams(params) : "";[m
[32m+[m[32m  return `${url}?${p}`;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// stable stringify for params (so order of keys tidak memengaruhi key)[m
[32m+[m[32mfunction stableStringifyParams(obj) {[m
[32m+[m[32m  if (obj == null) return "";[m
[32m+[m[32m  if (typeof obj !== "object") return String(obj);[m
[32m+[m[32m  if (Array.isArray(obj)) return JSON.stringify(obj.map(stableStringifyParams));[m
[32m+[m[32m  const keys = Object.keys(obj).sort();[m
[32m+[m[32m  const res = {};[m
[32m+[m[32m  for (const k of keys) {[m
[32m+[m[32m    res[k] = obj[k];[m
[32m+[m[32m  }[m
[32m+[m[32m  return JSON.stringify(res);[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport async function cachedGet(url, { params, ttl = 10000, cfg = {} } = {}) {[m
[32m+[m[32m  const key = makeKey(url, params);[m
[32m+[m[32m  const now = Date.now();[m
[32m+[m[32m  const hit = __getCache.get(key);[m
[32m+[m[32m  if (hit && now - hit.t <= ttl) {[m
[32m+[m[32m    return hit.res;[m
[32m+[m[32m  }[m
[32m+[m[32m  const res = await http.get(url, { params, ...cfg });[m
[32m+[m[32m  __getCache.set(key, { t: now, res });[m
[32m+[m[32m  // Simple eviction[m
[32m+[m[32m  const MAX_CACHE = 200;[m
[32m+[m[32m  if (__getCache.size > MAX_CACHE) {[m
[32m+[m[32m    const firstKey = __getCache.keys().next().value;[m
[32m+[m[32m    __getCache.delete(firstKey);[m
[32m+[m[32m  }[m
[32m+[m[32m  return res;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport const setAuthToken = (token) => {[m
[32m+[m[32m  if (token) {[m
[32m+[m[32m    localStorage.setItem("token", token);[m
[32m+[m[32m    http.defaults.headers.common["Authorization"] = `Bearer ${token}`;[m
[32m+[m[32m  } else {[m
[32m+[m[32m    localStorage.removeItem("token");[m
[32m+[m[32m    delete http.defaults.headers.common["Authorization"];[m
[32m+[m[32m  }[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32mexport const loadTokenFromStorage = () => {[m
[32m+[m[32m  const t = localStorage.getItem("token");[m
[32m+[m[32m  if (t) http.defaults.headers.common["Authorization"] = `Bearer ${t}`;[m
[32m+[m[32m  return t;[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32m// Pastikan saat module diimport token langsung dibaca dari localStorage[m
[32m+[m[32mloadTokenFromStorage();[m
[32m+[m
[32m+[m[32m// Interceptor request[m
[32m+[m[32mhttp.interceptors.request.use((config) => {[m
[32m+[m[32m  config.headers = config.headers || {};[m
[32m+[m[32m  if (!config.headers.Authorization && !config.headers["Authorization"]) {[m
[32m+[m[32m    const t = localStorage.getItem("token");[m
[32m+[m[32m    if (t) {[m
[32m+[m[32m      config.headers.Authorization = `Bearer ${t}`;[m
[32m+[m[32m      config.headers["Authorization"] = `Bearer ${t}`;[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m[32m  return config;[m
[32m+[m[32m});[m
[32m+[m
[32m+[m[32m// Interceptor response[m
[32m+[m[32mhttp.interceptors.response.use([m
[32m+[m[32m  (res) => res,[m
[32m+[m[32m  (err) => {[m
[32m+[m[32m    if (err?.response?.status === 401) {[m
[32m+[m[32m      setAuthToken(null);[m
[32m+[m[32m    }[m
[32m+[m[32m    return Promise.reject(err);[m
[32m+[m[32m  }[m
[32m+[m[32m);[m
[32m+[m
[32m+[m[32m// Document fetching helper[m
[32m+[m[32mexport async function fetchDocumentBlob(pathOrId, cfg = {}) {[m
[32m+[m[32m  if (!pathOrId) throw new Error("Path dokumen kosong.");[m
[32m+[m
[32m+[m[32m  const candidates = [[m
[32m+[m[32m    ["/admin/documents/download", { path: pathOrId }],[m
[32m+[m[32m    ["/public/documents/download", { path: pathOrId }],[m
[32m+[m[32m  ];[m
[32m+[m
[32m+[m[32m  for (const [endpoint, params] of candidates) {[m
[32m+[m[32m    try {[m
[32m+[m[32m      return await http.get(endpoint, {[m
[32m+[m[32m        ...cfg,[m
[32m+[m[32m        params,[m
[32m+[m[32m        responseType: "blob",[m
[32m+[m[32m      });[m
[32m+[m[32m    } catch {[m
[32m+[m[32m      // try next[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  const token = localStorage.getItem("token");[m
[32m+[m[32m  const url = absoluteStorageURL(pathOrId);[m
[32m+[m[32m  return axios.get(url, {[m
[32m+[m[32m    responseType: "blob",[m
[32m+[m[32m    headers: token ? { Authorization: `Bearer ${token}` } : {},[m
[32m+[m[32m    ...cfg,[m
[32m+[m[32m  });[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport function filenameFromHeaders(resp, fallback = "dokumen") {[m
[32m+[m[32m  const cd =[m
[32m+[m[32m    resp?.headers?.["content-disposition"] ||[m
[32m+[m[32m    resp?.headers?.["Content-Disposition"];[m
[32m+[m[32m  if (cd) {[m
[32m+[m[32m    const m = /filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(cd);[m
[32m+[m[32m    if (m) return decodeURIComponent(m[1] || m[2]);[m
[32m+[m[32m  }[m
[32m+[m[32m  return fallback;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexport async function getVisitTypeMap() {[m
[32m+[m[32m  const res = await getVisitTypes();[m
[32m+[m[32m  const arr = Array.isArray(res?.data) ? res.data : res?.data?.data || [];[m
[32m+[m[32m  const map = {};[m
[32m+[m[32m  arr.forEach((t) => {[m
[32m+[m[32m    if (t?.id != null)[m
[32m+[m[32m      map[String(t.id)] = t.name || t.title || t.nama || t.type_name || "-";[m
[32m+[m[32m  });[m
[32m+[m[32m  return map;[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32m// public[m
[32m+[m[32mexport const getVisitTypes = () => http.get(`/public/visit-types`);[m
[32m+[m[32mexport const getStations = () => http.get(`/public/stations`);[m
[32m+[m[32mexport const submitVisitorCard = (data) =>[m
[32m+[m[32m  http.post(`/public/visitor-cards`, data);[m
[32m+[m[32mexport const getVisitorCard = (id) =>[m
[32m+[m[32m  http.get(`/public/visitor-cards/${id}`);[m
[32m+[m[32mexport const checkStatus = (data) => http.post(`/public/check-status`, data);[m
[32m+[m[32mexport const getVisitorCardDetail = (id) =>[m
[32m+[m[32m  http.get(`/public/visitor-cards/${id}/detail`);[m
[32m+[m[32mexport const getStatusLogs = () => http.get(`/public/status-logs`);[m
[32m+[m[32mexport const cancelApplication = (data) =>[m
[32m+[m[32m  http.post(`/public/cancel-application`, data);[m
[32m+[m[32mexport const resubmitApplication = (data) =>[m
[32m+[m[32m  http.post(`/public/resubmit-application`, data);[m
[32m+[m
[32m+[m[32m// admin[m
[32m+[m[32mexport const adminLogin = (data) => http.post(`/admin/login`, data);[m
[32m+[m[32mexport const adminLogout = () => http.post(`/admin/logout`);[m
[32m+[m[32mexport const getAdminMe = () => http.get(`/admin/me`);[m
[32m+[m
[32m+[m[32mexport const getActiveVisitors = () =>[m
[32m+[m[32m  http.get(`/admin/dashboard/active-visitors`);[m
[32m+[m[32mexport const getPendingCount = () =>[m
[32m+[m[32m  http.get(`/admin/dashboard/pending-count`);[m
[32m+[m[32mexport const getTodayIssued = () =>[m
[32m+[m[32m  cachedGet(`/admin/dashboard/today-issued`, { ttl: 10000 });[m
[32m+[m[32mexport const getTodayReturned = () =>[m
[32m+[m[32m  cachedGet(`/admin/dashboard/today-returned`, { ttl: 10000 });[m
[32m+[m
[32m+[m[32m/* ======================= BYPASS CACHE COUNTERS ======================= */[m
[32m+[m[32mexport const getDamagedCards = (opts = {}) => {[m
[32m+[m[32m  const ttl = opts.ttl ?? 0;[m
[32m+[m[32m  if (typeof cachedGet === "function") {[m
[32m+[m[32m    return cachedGet(`/admin/dashboard/damaged-cards`, {[m
[32m+[m[32m      ttl,[m
[32m+[m[32m      params: { _ts: Date.now() },[m
[32m+[m[32m      cfg: { headers: { "Cache-Control": "no-cache" } },[m
[32m+[m[32m    });[m
[32m+[m[32m  }[m
[32m+[m[32m  const url = `/admin/dashboard/damaged-cards?_ts=${Date.now()}`;[m
[32m+[m[32m  return http.get(url, { headers: { "Cache-Control": "no-cache" } }).then((r) => r);[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32mexport const getLostCards = (opts = {}) => {[m
[32m+[m[32m  const ttl = opts.ttl ?? 0;[m
[32m+[m[32m  if (typeof cachedGet === "function") {[m
[32m+[m[32m    return cachedGet(`/admin/dashboard/lost-cards`, {[m
[32m+[m[32m      ttl,[m
[32m+[m[32m      params: { _ts: Date.now() },[m
[32m+[m[32m      cfg: { headers: { "Cache-Control": "no-cache" } },[m
[32m+[m[32m    });[m
[32m+[m[32m  }[m
[32m+[m[32m  const url = `/admin/dashboard/lost-cards?_ts=${Date.now()}`;[m
[32m+[m[32m  return http.get(url, { headers: { "Cache-Control": "no-cache" } }).then((r) => r);[m
[32m+[m[32m};[m
[32m+[m[32m/* ===================== END BYPASS CACHE COUNTERS ===================== */[m
[32m+[m
[32m+[m[32m/* ======================= BYPASS CACHE LIST KARTU ===================== */[m
[32m+[m[32m/** list kartu APPROVED sering berubah -> selalu fresh */[m
[32m+[m[32mexport const getApprovedCards = (opts = {}) => {[m
[32m+[m[32m  const ttl = opts.ttl ?? 0;[m
[32m+[m[32m  const params = { _ts: Date.now(), ...(opts.params || {}) };[m
[32m+[m[32m  if (typeof cachedGet === "function") {[m
[32m+[m[32m    return cachedGet(`/admin/cards/approved`, {[m
[32m+[m[32m      ttl,[m
[32m+[m[32m      params,[m
[32m+[m[32m      cfg: { headers: { "Cache-Control": "no-cache" } },[m
[32m+[m[32m    });[m
[32m+[m[32m  }[m
[32m+[m[32m  return http.get(`/admin/cards/approved`, {[m
[32m+[m[32m    params,[m
[32m+[m[32m    headers: { "Cache-Control": "no-cache" },[m
[32m+[m[32m  });[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32m/** list kartu ACTIVE sering berubah -> selalu fresh */[m
[32m+[m[32mexport const getActiveCards = (opts = {}) => {[m
[32m+[m[32m  const ttl = opts.ttl ?? 0;[m
[32m+[m[32m  const params = { _ts: Date.now(), ...(opts.params || {}) };[m
[32m+[m[32m  if (typeof cachedGet === "function") {[m
[32m+[m[32m    return cachedGet(`/admin/cards/active`, {[m
[32m+[m[32m      ttl,[m
[32m+[m[32m      params,[m
[32m+[m[32m      cfg: { headers: { "Cache-Control": "no-cache" } },[m
[32m+[m[32m    });[m
[32m+[m[32m  }[m
[32m+[m[32m  return http.get(`/admin/cards/active`, {[m
[32m+[m[32m    params,[m
[32m+[m[32m    headers: { "Cache-Control": "no-cache" },[m
[32m+[m[32m  });[m
[32m+[m[32m};[m
[32m+[m[32m/* ===================== END BYPASS CACHE LIST KARTU ==================== */[m
[32m+[m
[32m+[m[32mexport const getVerifications = (params) =>[m
[32m+[m[32m  http.get(`/admin/verification`, { params });[m
[32m+[m[32mexport const getPendingVerifications = () =>[m
[32m+[m[32m  http.get(`/admin/verification/pending`);[m
[32m+[m
[32m+[m[32m// ===== Helpers untuk penggabungan list =====[m
[32m+[m[32mconst _unwrapList = (res) =>[m
[32m+[m[32m  Array.isArray(res?.data) ? res.data : res?.data?.data || [];[m
[32m+[m
[32m+[m[32mconst _pushUnique = (bucket, seen, items) => {[m
[32m+[m[32m  for (const it of items || []) {[m
[32m+[m[32m    const key =[m
[32m+[m[32m      it?.reference_number ||[m
[32m+[m[32m      it?.reference ||[m
[32m+[m[32m      it?.ref_no ||[m
[32m+[m[32m      it?.id ||[m
[32m+[m[32m      JSON.stringify(it);[m
[32m+[m[32m    if (!seen.has(key)) {[m
[32m+[m[32m      seen.add(key);[m
[32m+[m[32m      bucket.push(it);[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32m/**[m
[32m+[m[32m * Ambil semua verifikasi lintas status[m
[32m+[m[32m */[m
[32m+[m[32mexport const getVerificationsAll = async (extraParams = {}) => {[m
[32m+[m[32m  const results = [];[m
[32m+[m[32m  const seen = new Set();[m
[32m+[m
[32m+[m[32m  const settled = await Promise.allSettled([[m
[32m+[m[32m    cachedGet(`/admin/verification/pending`, {[m
[32m+[m[32m      params: { ...extraParams },[m
[32m+[m[32m      ttl: 10000,[m
[32m+[m[32m    }),[m
[32m+[m[32m    cachedGet(`/admin/verification/approved`, {[m
[32m+[m[32m      params: { ...extraParams },[m
[32m+[m[32m      ttl: 10000,[m
[32m+[m[32m    }),[m
[32m+[m[32m    cachedGet(`/admin/verification/rejected`, {[m
[32m+[m[32m      params: { ...extraParams },[m
[32m+[m[32m      ttl: 10000,[m
[32m+[m[32m    }),[m
[32m+[m[32m  ]);[m
[32m+[m
[32m+[m[32m  for (const s of settled) {[m
[32m+[m[32m    if (s.status === "fulfilled") {[m
[32m+[m[32m      _pushUnique(results, seen, _unwrapList(s.value));[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  if (results.length === 0) {[m
[32m+[m[32m    try {[m
[32m+[m[32m      const r = await cachedGet(`/admin/verification`, {[m
[32m+[m[32m        params: { ...extraParams },[m
[32m+[m[32m        ttl: 10000,[m
[32m+[m[32m      });[m
[32m+[m[32m      _pushUnique(results, seen, _unwrapList(r));[m
[32m+[m[32m    } catch {}[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  return { data: results };[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32mexport const getVerificationDetail = (data) =>[m
[32m+[m[32m  http.post(`/admin/verification/detail`, data);[m
[32m+[m[32mexport const approveVerification = (data) =>[m
[32m+[m[32m  http.post(`/admin/verification/approve`, data);[m
[32m+[m[32mexport const rejectVerification = (data) =>[m
[32m+[m[32m  http.post(`/admin/verification/reject`, data);[m
[32m+[m[32mexport const bulkVerificationAction = (data) =>[m
[32m+[m[32m  http.post(`/admin/verification/bulk-action`, data);[m
[32m+[m
[32m+[m[32mexport const getApprovedCardsLegacy = () => http.get(`/admin/cards/approved`); // (opsional) kalau perlu[m
[32m+[m[32mexport const getReturnedCards = () => http.get(`/admin/cards/returned`);[m
[32m+[m[32mexport const issueCard = (data) => http.post(`/admin/cards/issue`, data);[m
[32m+[m[32mexport const returnCard = (data) => http.post(`/admin/cards/return`, data);[m
[32m+[m[32mexport const editCardCondition = (id, data) =>[m
[32m+[m[32m  http.put(`/admin/cards/${id}/condition`, data);[m
[32m+[m
[32m+[m[32m// fallback untuk update visitor-card[m
[32m+[m[32mexport const updateVisitorCard = (id, data) =>[m
[32m+[m[32m  http.put(`/admin/visitor-cards/${id}`, data);[m
[32m+[m
[32m+[m[32m// Export report endpoints[m
[32m+[m[32mconst blobOpts = { responseType: "blob" };[m
[32m+[m
[32m+[m[32mexport const exportStationDailyFlow = () =>[m
[32m+[m[32m  http.get(`/admin/reports/station-daily-flow`, blobOpts);[m
[32m+[m[32mexport const exportAll = () => http.get(`/admin/reports/export-all`, blobOpts);[m
[32m+[m[32mexport const exportDailyFlow = () => http.get(`/admin/reports/daily-flow`, blobOpts);[m
[32m+[m[32mexport const exportWeeklyFlow = () =>[m
[32m+[m[32m  http.get(`/admin/reports/weekly-flow`, blobOpts);[m
[32m+[m[32mexport const exportMonthlyFlow = () =>[m
[32m+[m[32m  http.get(`/admin/reports/monthly-flow`, blobOpts);[m
[32m+[m[32mexport const exportYearlyFlow = () =>[m
[32m+[m[32m  http.get(`/admin/reports/yearly-flow`, blobOpts);[m
[32m+[m[32mexport const exportCardCondition = () =>[m
[32m+[m[32m  http.get(`/admin/reports/card-condition`, blobOpts);[m
[32m+[m
[32m+[m[32m// Resource-like collections[m
 export const adminVisitorCards = {[m
[31m-  list: () => axios.get(`${API_BASE}/admin/visitor-cards`),[m
[31m-  get: (id) => axios.get(`${API_BASE}/admin/visitor-cards/${id}`),[m
[31m-  create: (data) => axios.post(`${API_BASE}/admin/visitor-cards`, data),[m
[31m-  update: (id, data) => axios.put(`${API_BASE}/admin/visitor-cards/${id}`, data),[m
[31m-  delete: (id) => axios.delete(`${API_BASE}/admin/visitor-cards/${id}`),[m
[32m+[m[32m  list: () => http.get(`/admin/visitor-cards`),[m
[32m+[m[32m  get: (id) => http.get(`/admin/visitor-cards/${id}`),[m
[32m+[m[32m  create: (data) => http.post(`/admin/visitor-cards`, data),[m
[32m+[m[32m  update: (id, data) => http.put(`/admin/visitor-cards/${id}`, data),[m
[32m+[m[32m  delete: (id) => http.delete(`/admin/visitor-cards/${id}`),[m
 };[m
[32m+[m
 export const adminCardTransactions = {[m
[31m-  list: () => axios.get(`${API_BASE}/admin/card-transactions`),[m
[31m-  get: (id) => axios.get(`${API_BASE}/admin/card-transactions/${id}`),[m
[31m-  create: (data) => axios.post(`${API_BASE}/admin/card-transactions`, data),[m
[31m-  update: (id, data) => axios.put(`${API_BASE}/admin/card-transactions/${id}`, data),[m
[31m-  delete: (id) => axios.delete(`${API_BASE}/admin/card-transactions/${id}`),[m
[32m+[m[32m  list: () => http.get(`/admin/card-transactions`),[m
[32m+[m[32m  get: (id) => http.get(`/admin/card-transactions/${id}`),[m
[32m+[m[32m  create: (data) => http.post(`/admin/card-transactions`, data),[m
[32m+[m[32m  update: (id, data) => http.put(`/admin/card-transactions/${id}`, data),[m
[32m+[m[32m  delete: (id) => http.delete(`/admin/card-transactions/${id}`),[m
 };[m
[32m+[m
 export const adminStatusLogs = {[m
[31m-  list: () => axios.get(`${API_BASE}/admin/status-logs`),[m
[31m-  get: (id) => axios.get(`${API_BASE}/admin/status-logs/${id}`),[m
[31m-  create: (data) => axios.post(`${API_BASE}/admin/status-logs`, data),[m
[31m-  update: (id, data) => axios.put(`${API_BASE}/admin/status-logs/${id}`, data),[m
[31m-  delete: (id) => axios.delete(`${API_BASE}/admin/status-logs/${id}`),[m
[32m+[m[32m  list: () => http.get(`/admin/status-logs`),[m
[32m+[m[32m  get: (id) => http.get(`/admin/status-logs/${id}`),[m
[32m+[m[32m  create: (data) => http.post(`/admin/status-logs`, data),[m
[32m+[m[32m  update: (id, data) => http.put(`/admin/status-logs/${id}`, data),[m
[32m+[m[32m  delete: (id) => http.delete(`/admin/status-logs/${id}`),[m
 };[m
[32m+[m
 export const adminStations = {[m
[31m-  list: () => axios.get(`${API_BASE}/admin/stations`),[m
[31m-  get: (id) => axios.get(`${API_BASE}/admin/stations/${id}`),[m
[31m-  create: (data) => axios.post(`${API_BASE}/admin/stations`, data),[m
[31m-  update: (id, data) => axios.put(`${API_BASE}/admin/stations/${id}`, data),[m
[31m-  delete: (id) => axios.delete(`${API_BASE}/admin/stations/${id}`),[m
[32m+[m[32m  list: () => http.get(`/admin/stations`),[m
[32m+[m[32m  get: (id) => http.get(`/admin/stations/${id}`),[m
[32m+[m[32m  create: (data) => http.post(`/admin/stations`, data),[m
[32m+[m[32m  update: (id, data) => http.put(`/admin/stations/${id}`, data),[m
[32m+[m[32m  delete: (id) => http.delete(`/admin/stations/${id}`),[m
 };[m
[32m+[m
 export const adminVisitTypes = {[m
[31m-  list: () => axios.get(`${API_BASE}/admin/visit-types`),[m
[31m-  get: (id) => axios.get(`${API_BASE}/admin/visit-types/${id}`),[m
[31m-  create: (data) => axios.post(`${API_BASE}/admin/visit-types`, data),[m
[31m-  update: (id, data) => axios.put(`${API_BASE}/admin/visit-types/${id}`, data),[m
[31m-  delete: (id) => axios.delete(`${API_BASE}/admin/visit-types/${id}`),[m
[32m+[m[32m  list: () => http.get(`/admin/visit-types`),[m
[32m+[m[32m  get: (id) => http.get(`/admin/visit-types/${id}`),[m
[32m+[m[32m  create: (data) => http.post(`/admin/visit-types`, data),[m
[32m+[m[32m  update: (id, data) => http.put(`/admin/visit-types/${id}`),[m
[32m+[m[32m  delete: (id) => http.delete(`/admin/visit-types/${id}`),[m
 };[m
[32m+[m
 export const adminUsers = {[m
[31m-  list: () => axios.get(`${API_BASE}/admin/users`),[m
[31m-  get: (id) => axios.get(`${API_BASE}/admin/users/${id}`),[m
[31m-  create: (data) => axios.post(`${API_BASE}/admin/users`, data),[m
[31m-  update: (id, data) => axios.put(`${API_BASE}/admin/users/${id}`, data),[m
[31m-  delete: (id) => axios.delete(`${API_BASE}/admin/users/${id}`),[m
[32m+[m[32m  list: () => http.get(`/admin/users`),[m
[32m+[m[32m  get: (id) => http.get(`/admin/users/${id}`),[m
[32m+[m[32m  create: (data) => http.post(`/admin/users`, data),[m
[32m+[m[32m  update: (id, data) => http.put(`/admin/users/${id}`, data),[m
[32m+[m[32m  delete: (id) => http.delete(`/admin/users/${id}`),[m
 };[m
[32m+[m
 export const adminNotifications = {[m
[31m-  list: () => axios.get(`${API_BASE}/admin/notifications`),[m
[31m-  get: (id) => axios.get(`${API_BASE}/admin/notifications/${id}`),[m
[31m-  create: (data) => axios.post(`${API_BASE}/admin/notifications`, data),[m
[31m-  update: (id, data) => axios.put(`${API_BASE}/admin/notifications/${id}`, data),[m
[31m-  delete: (id) => axios.delete(`${API_BASE}/admin/notifications/${id}`),[m
[32m+[m[32m  list: () => http.get(`/admin/notifications`),[m
[32m+[m[32m  get: (id) => http.get(`/admin/notifications/${id}`),[m
[32m+[m[32m  create: (data) => http.post(`/admin/notifications`, data),[m
[32m+[m[32m  update: (id, data) => http.put(`/admin/notifications/${id}`),[m
[32m+[m[32m  delete: (id) => http.delete(`/admin/notifications/${id}`),[m
 };[m
 [m
[31m-// Health check[m
[31m-export const healthCheck = () => axios.get(`${API_BASE}/health`);[m
[32m+[m[32mexport const healthCheck = () => http.get(`/health`);[m
[32m+[m
[32m+[m[32mexport default http;[m
[1mdiff --git a/src/pages/HasilCek.jsx b/src/pages/HasilCek.jsx[m
[1mindex f336b25..a2d7a30 100644[m
[1m--- a/src/pages/HasilCek.jsx[m
[1m+++ b/src/pages/HasilCek.jsx[m
[36m@@ -1,9 +1,9 @@[m
 import React, { useEffect, useState } from 'react';[m
 import { useLocation } from 'react-router-dom';[m
 import { getVisitorCardDetail, checkStatus, getStations } from '../api';[m
[32m+[m[32mimport { Icon } from '@iconify/react';[m
 import './HasilCek.css';[m
 import CheckIcon from '../assets/CheckIcon.svg';[m
[31m-import CheckBox from '../assets/checkbox.svg';[m
 import DetailInfo from '../assets/detailinfo.svg';[m
 [m
 const HasilCek = () => {[m
[36m@@ -16,206 +16,210 @@[m [mconst HasilCek = () => {[m
   const [loading, setLoading] = useState(true);[m
   const [error, setError] = useState('');[m
 [m
[32m+[m[32m  // === NORMALIZER ===[m
   const normalizeDateString = (t) => {[m
[31m-    if (t === null || t === undefined) return '';[m
[32m+[m[32m    if (!t) return '';[m
     const s = String(t).trim();[m
     if (!s || /^null|undefined$/i.test(s)) return '';[m
[31m-[m
     if (/^\d{10}$/.test(s)) return new Date(Number(s) * 1000).toISOString();[m
     if (/^\d{13}$/.test(s)) return new Date(Number(s)).toISOString();[m
[31m-[m
[31m-    const isoMicro = s.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})\.(\d+)(Z|[+\-]\d{2}:\d{2})$/);[m
[31m-    if (isoMicro) {[m
[31m-      const ms = isoMicro[2].slice(0, 3).padEnd(3, '0');[m
[31m-      return `${isoMicro[1]}.${ms}${isoMicro[3]}`;[m
[31m-    }[m
[31m-[m
[31m-    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(Z|[+\-]\d{2}:\d{2})?$/.test(s)) {[m
[31m-      if (/[Z+\-]\d{2}:\d{2}$/.test(s)) return s;[m
[31m-      return `${s}+07:00`;[m
[31m-    }[m
[31m-[m
[31m-    if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(s)) {[m
[31m-      return s.replace(' ', 'T') + '+07:00';[m
[31m-    }[m
[31m-[m
[31m-    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {[m
[31m-      return `${s}T00:00:00+07:00`;[m
[31m-    }[m
[31m-[m
[32m+[m[32m    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return `${s}T00:00:00+07:00`;[m
[32m+[m[32m    if (/^\d{4}-\d{2}-\d{2} /.test(s)) return s.replace(' ', 'T') + '+07:00';[m
     return s;[m
   };[m
 [m
   const fmtFull = (t) => {[m
[31m-    const norm = normalizeDateString(t);[m
[31m-    if (!norm) return '-';[m
[31m-    const d = new Date(norm);[m
[31m-    if (isNaN(d.getTime())) return '-';[m
[31m-    try {[m
[31m-      const parts = new Intl.DateTimeFormat('en-GB', {[m
[31m-        timeZone: 'Asia/Jakarta',[m
[31m-        hour12: false,[m
[31m-        year: 'numeric',[m
[31m-        month: '2-digit',[m
[31m-        day: '2-digit',[m
[31m-        hour: '2-digit',[m
[31m-        minute: '2-digit',[m
[31m-        second: '2-digit',[m
[31m-      }).formatToParts(d);[m
[31m-      const get = (type) => parts.find((p) => p.type === type)?.value || '';[m
[31m-      return `${get('hour')}:${get('minute')}:${get('second')}, ${get('day')}/${get('month')}/${get('year')}`;[m
[31m-    } catch {[m
[31m-      const pad = (n) => String(n).padStart(2, '0');[m
[31m-      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}, ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;[m
[31m-    }[m
[32m+[m[32m    const d = new Date(normalizeDateString(t));[m
[32m+[m[32m    if (isNaN(d)) return '-';[m
[32m+[m[32m    return d.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });[m
   };[m
 [m
   const fmtDate = (t) => {[m
[31m-    const norm = normalizeDateString(t);[m
[31m-    if (!norm) return '-';[m
[31m-    const d = new Date(norm);[m
[31m-    if (isNaN(d.getTime())) return '-';[m
[31m-    return new Intl.DateTimeFormat('id-ID', {[m
[31m-      timeZone: 'Asia/Jakarta',[m
[32m+[m[32m    const d = new Date(normalizeDateString(t));[m
[32m+[m[32m    if (isNaN(d)) return '-';[m
[32m+[m[32m    return d.toLocaleDateString('id-ID', {[m
       day: 'numeric',[m
       month: 'long',[m
       year: 'numeric',[m
[31m-    }).format(d);[m
[32m+[m[32m      timeZone: 'Asia/Jakarta',[m
[32m+[m[32m    });[m
   };[m
[31m-n[m
[32m+[m
[32m+[m[32m  // ==== Map stasiun (lebih toleran: id/code/station_code/nama -> nama) ====[m
   useEffect(() => {[m
[31m-    let mounted = true;[m
     (async () => {[m
[31m-      [m
       try {[m
         const res = await getStations();[m
[31m-        const raw = Array.isArray(res?.data) ? res.data : Array.isArray(res?.data?.data) ? res.data.data : [];[m
[31m-        const m = new Map();[m
[32m+[m[32m        const raw = Array.isArray(res?.data)[m
[32m+[m[32m          ? res.data[m
[32m+[m[32m          : Array.isArray(res?.data?.data)[m
[32m+[m[32m          ? res.data.data[m
[32m+[m[32m          : [];[m
[32m+[m[32m        const map = new Map();[m
         raw.forEach((it, idx) => {[m
[31m-          const id  = (typeof it?.id === 'number') ? it.id : (it?.code ?? it?.station_code ?? idx);[m
[31m-          const nm  = it?.name ?? it?.station_name ?? it?.nama ?? it?.title ?? it?.label ?? `Stasiun ${idx+1}`;[m
[31m-          if (id !== undefined && id !== null) m.set(String(id), String(nm));[m
[31m-          if (it?.code)         m.set(String(it.code), String(nm));[m
[31m-          if (it?.station_code) m.set(String(it.station_code), String(nm));[m
[31m-          m.set(String(nm), String(nm));[m
[32m+[m[32m          const id =[m
[32m+[m[32m            typeof it?.id === 'number'[m
[32m+[m[32m              ? it.id[m
[32m+[m[32m              : it?.code ?? it?.station_code ?? idx;[m
[32m+[m[32m          const nm =[m
[32m+[m[32m            it?.name ??[m
[32m+[m[32m            it?.station_name ??[m
[32m+[m[32m            it?.nama ??[m
[32m+[m[32m            it?.title ??[m
[32m+[m[32m            it?.label ??[m
[32m+[m[32m            `Stasiun ${idx + 1}`;[m
[32m+[m[32m          if (id !== undefined && id !== null) map.set(String(id), String(nm));[m
[32m+[m[32m          if (it?.code) map.set(String(it.code), String(nm));[m
[32m+[m[32m          if (it?.station_code) map.set(String(it.station_code), String(nm));[m
[32m+[m[32m          // Simpan juga nama sebagai key â†’ bila API sudah kirim nama langsung[m
[32m+[m[32m          map.set(String(nm), String(nm));[m
         });[m
[31m-        if (mounted) setStationsMap(m);[m
[31m-      } catch {}[m
[32m+[m[32m        setStationsMap(map);[m
[32m+[m[32m      } catch {[m
[32m+[m[32m        // abaikan error pemuatan daftar stasiun[m
[32m+[m[32m      }[m
     })();[m
[31m-    return () => { mounted = false; };[m
   }, []);[m
 [m
[32m+[m[32m  // ==== Resolver stasiun: pakai map, jika non-numeric & tidak kosong -> pakai langsung ====[m
   const resolveStationName = (d) => {[m
[31m-    const candidates = [ d?.station_name, d?.visit_station, d?.station, d?.station_code, d?.station_id ][m
[31m-      .filter(v => v !== undefined && v !== null);[m
[32m+[m[32m    const candidates = [[m
[32m+[m[32m      d?.station_name,[m
[32m+[m[32m      d?.visit_station,[m
[32m+[m[32m      d?.station,[m
[32m+[m[32m      d?.station_code,[m
[32m+[m[32m      d?.station_id,[m
[32m+[m[32m    ].filter((v) => v !== undefined && v !== null);[m
[32m+[m
     for (const c of candidates) {[m
       const key = String(c);[m
       if (stationsMap.has(key)) return stationsMap.get(key);[m
[32m+[m[32m      // kalau sudah berupa nama (bukan angka/kode), gunakan langsung[m
       if (isNaN(Number(key)) && key.trim()) return key;[m
     }[m
     return '-';[m
   };[m
 [m
[31m-  const resolveVisitType = (d) => {[m
[31m-    const candidates = [[m
[31m-      d?.visit_type_label, d?.visit_type_name, d?.visit_type, d?.visitor_type,[m
[31m-      d?.jenis_kunjungan, d?.jenisKunjunganLabel, d?.type_name, d?.type[m
[31m-    ].filter(v => v !== undefined && v !== null);[m
[31m-    for (const c of candidates) {[m
[31m-      const s = String(c).trim();[m
[31m-      if (s) return s;[m
[31m-    }[m
[31m-    return '-';[m
[31m-  };[m
[32m+[m[32m  const resolveVisitType = (d) =>[m
[32m+[m[32m    d?.visit_type_label || d?.visit_type || d?.visitor_type || '-';[m
 [m
[32m+[m[32m  // Fetch data[m
   async function fetchDetail(n) {[m
[31m-    try { const r1 = await getVisitorCardDetail(n);            const d1 = r1?.data?.data ?? r1?.data ?? null; if (d1) return d1; } catch {}[m
[31m-    try { const r2 = await getVisitorCardDetail({ reference_number: n }); const d2 = r2?.data?.data ?? r2?.data ?? null; if (d2) return d2; } catch {}[m
[31m-    try { const r3 = await checkStatus({ reference_number: n });         const d3 = r3?.data?.data ?? r3?.data ?? null; if (d3) return d3; } catch (e) { throw e; }[m
[31m-    return null;[m
[32m+[m[32m    try {[m
[32m+[m[32m      const r = await getVisitorCardDetail(n);[m
[32m+[m[32m      return r?.data?.data ?? r?.data ?? null;[m
[32m+[m[32m    } catch {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const r2 = await checkStatus({ reference_number: n });[m
[32m+[m[32m        return r2?.data?.data ?? r2?.data ?? null;[m
[32m+[m[32m      } catch {[m
[32m+[m[32m        return null;[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
   }[m
 [m
   useEffect(() => {[m
[31m-    let mounted = true;[m
[31m-    if (!nomor) {[m
[31m-      setError('Nomor referensi tidak ditemukan. Silahkan kembali dan masukkan nomor Anda.');[m
[31m-      setLoading(false);[m
[31m-      return;[m
[31m-    }[m
     (async () => {[m
[31m-      setLoading(true); setError('');[m
[32m+[m[32m      if (!nomor) return setError('Nomor referensi tidak ditemukan.');[m
       try {[m
         const d = await fetchDetail(nomor);[m
[31m-        if (!mounted) return;[m
[31m-        if (!d) setError('Data tidak ditemukan. Pastikan nomor referensi benar.');[m
[31m-        else setData(d);[m
[31m-      } catch (e) {[m
[31m-        if (!mounted) return;[m
[31m-        const status = e?.response?.status;[m
[31m-        if (status === 404) setError('Data tidak ditemukan (404). Periksa nomor referensi Anda.');[m
[31m-        else if (status === 401 || status === 403) setError('Tidak memiliki akses ke data (401/403).');[m
[31m-        else setError('Gagal memuat data dari server.');[m
[32m+[m[32m        if (!d) return setError('Data tidak ditemukan.');[m
[32m+[m[32m        setData(d);[m
[32m+[m[32m      } catch {[m
[32m+[m[32m        setError('Gagal memuat data.');[m
       } finally {[m
[31m-        if (mounted) setLoading(false);[m
[32m+[m[32m        setLoading(false);[m
       }[m
     })();[m
[31m-    return () => { mounted = false; };[m
[31m-  }, [nomor]);[m
[31m-[m
[31m-  useEffect(() => {[m
[31m-    if (!nomor) return;[m
[31m-    const id = setInterval(() => {[m
[31m-      fetchDetail(nomor).then((d) => d && setData(d)).catch(() => {});[m
[31m-    }, 30000);[m
[31m-    return () => clearInterval(id);[m
   }, [nomor]);[m
 [m
   if (loading) return <div>Loading...</div>;[m
[31m-  if (error)   return <div className="text-red-500 p-4">{error}</div>;[m
[31m-  if (!data)   return <div className="p-4">Data kosong.</div>;[m
[32m+[m[32m  if (error) return <div className="text-red-500 p-4">{error}</div>;[m
[32m+[m[32m  if (!data) return <div>Data kosong.</div>;[m
 [m
   const lastUpdated =[m
[31m-    data?.last_updated_at ?? data?.last_updated ?? data?.lastUpdateAt ??[m
[31m-    data?.updated_at ?? data?.processed_at ?? data?.approved_at ?? data?.rejected_at ??[m
[31m-    data?.created_at ?? '';[m
[32m+[m[32m    data.last_updated_at ||[m
[32m+[m[32m    data.updated_at ||[m
[32m+[m[32m    data.processed_at ||[m
[32m+[m[32m    data.created_at ||[m
[32m+[m[32m    '';[m
[32m+[m
[32m+[m[32m  const status = (data.status || '').toLowerCase();[m
[32m+[m[32m  const isApproved = status === 'approved';[m
[32m+[m[32m  const isRejected = status === 'rejected';[m
 [m
[31m-  const stationName   = resolveStationName(data);[m
[31m-  const visitTypeName = resolveVisitType(data);[m
[32m+[m[32m  const green = '#14AE5C';[m
[32m+[m[32m  const red = '#E54000';[m
 [m
[31m-  let statusText = '', statusDesc = '', catatanTitle = '', catatanNote = '';[m
[31m-  if (data.status === 'approved') {[m
[32m+[m[32m  let statusText = '',[m
[32m+[m[32m    statusDesc = '',[m
[32m+[m[32m    catatanTitle = '',[m
[32m+[m[32m    catatanNote = '';[m
[32m+[m
[32m+[m[32m  if (isApproved) {[m
     statusText = 'Permohonan Disetujui';[m
[31m-    statusDesc = 'Kartu visitor Anda telah disetujui dan siap diambil';[m
[32m+[m[32m    statusDesc = 'Kartu visitor Anda telah disetujui dan siap diambil.';[m
     catatanTitle = 'Catatan Persetujuan';[m
[31m-    catatanNote = data.approval_notes || 'Semua dokumen telah diverifikasi dan memenuhi persyaratan. Silakan ambil kartu visitor pada petugas keamanan dengan membawa kartu identitas asli.';[m
[31m-  } else if (data.status === 'rejected') {[m
[32m+[m[32m    catatanNote =[m
[32m+[m[32m      data.approval_notes ||[m
[32m+[m[32m      'Semua dokumen telah diverifikasi dan memenuhi persyaratan.';[m
[32m+[m[32m  } else if (isRejected) {[m
     statusText = 'Permohonan Ditolak';[m
[31m-    statusDesc = 'Permohonan anda tidak dapat diproses lebih lanjut';[m
[32m+[m[32m    statusDesc = 'Permohonan Anda tidak dapat diproses lebih lanjut.';[m
     catatanTitle = 'Alasan Penolakan';[m
[31m-    catatanNote = data.rejection_reason || 'Dokumen tidak sesuai persyaratan atau ada data yang belum lengkap.';[m
[32m+[m[32m    catatanNote =[m
[32m+[m[32m      data.rejection_reason ||[m
[32m+[m[32m      'Dokumen tidak sesuai persyaratan atau ada data yang belum lengkap.';[m
   } else {[m
     statusText = 'Permohonan Sedang Diproses';[m
[31m-    statusDesc = 'Permohonan anda sedang dalam tahap verifikasi';[m
[32m+[m[32m    statusDesc = 'Permohonan Anda sedang dalam tahap verifikasi.';[m
     catatanTitle = 'Informasi Status';[m
[31m-    catatanNote = 'Permohonan Anda sedang dalam tahap verifikasi. Tim kami sedang meninjau dokumen yang diajukan untuk memastikan kelengkapan dan kesesuaian dengan persyaratan.';[m
[32m+[m[32m    catatanNote =[m
[32m+[m[32m      'Permohonan Anda sedang dalam tahap verifikasi oleh tim kami.';[m
   }[m
 [m
   return ([m
[31m-    <div className="page-wrapper-hasil">[m
[31m-      <div className="main-card-container">[m
[32m+[m[32m    <div[m
[32m+[m[32m      className="page-wrapper-hasil"[m
[32m+[m[32m      style={{[m
[32m+[m[32m        background: isApproved ? '#e5e7eb;' : isRejected ? '#FFF5F5' : '#EBF1F8',[m
[32m+[m[32m      }}[m
[32m+[m[32m    >[m
[32m+[m[32m      <div[m
[32m+[m[32m        className="main-card-container"[m
[32m+[m[32m        style={{[m
[32m+[m[32m          borderTop: `5px solid ${isApproved ? green : isRejected ? red : '#28a745'}`,[m
[32m+[m[32m        }}[m
[32m+[m[32m      >[m
[32m+[m[32m        {/* Header */}[m
         <div className="status-header">[m
[31m-          <img src={CheckIcon} alt="Check Icon" className="check-icon" />[m
[31m-          <div className="status-text">[m
[31m-            <h3>{statusText}</h3>[m
[32m+[m[32m          {isApproved ? ([m
[32m+[m[32m            <Icon icon="mingcute:check-2-fill" color={green} width={90} height={90} />[m
[32m+[m[32m          ) : isRejected ? ([m
[32m+[m[32m            <Icon icon="solar:danger-triangle-bold" color={red} width={75} height={75} />[m
[32m+[m[32m          ) : ([m
[32m+[m[32m            <img src={CheckIcon} alt="Status" className="check-icon" />[m
[32m+[m[32m          )}[m
[32m+[m
[32m+[m[32m          <div[m
[32m+[m[32m            className="status-text"[m
[32m+[m[32m            style={{ color: isApproved ? green : isRejected ? red : '#333' }}[m
[32m+[m[32m          >[m
[32m+[m[32m            <h3 style={{ color: isApproved ? green : isRejected ? red : undefined }}>[m
[32m+[m[32m              {statusText}[m
[32m+[m[32m            </h3>[m
             <p>{statusDesc}</p>[m
             <p className="last-updated">Terakhir diperbarui: {fmtFull(lastUpdated)}</p>[m
           </div>[m
         </div>[m
 [m
[32m+[m[32m        {/* Info Grid */}[m
         <div className="info-grid">[m
           <div className="info-item">[m
             <span className="info-label">NOMOR REFERENSI</span>[m
[31m-            <span className="info-value">{data.reference_number || data.id || '-'}</span>[m
[32m+[m[32m            <span className="info-value">[m
[32m+[m[32m              {data.reference_number || data.id || '-'}[m
[32m+[m[32m            </span>[m
           </div>[m
           <div className="info-item">[m
             <span className="info-label">NAMA PEMOHON</span>[m
[36m@@ -227,10 +231,11 @@[m [mn[m
           </div>[m
           <div className="info-item">[m
             <span className="info-label">STASIUN KUNJUNGAN</span>[m
[31m-            <span className="info-value">{stationName}</span>[m
[32m+[m[32m            <span className="info-value">{resolveStationName(data)}</span>[m
           </div>[m
         </div>[m
 [m
[32m+[m[32m        {/* Detail */}[m
         <div className="detail-section">[m
           <div className="detail-header">[m
             <img src={DetailInfo} alt="Detail Info" className="detail-info-icon" />[m
[36m@@ -240,33 +245,75 @@[m [mn[m
           <div className="date-status-grid">[m
             <div className="date-item">[m
               <span className="date-label">Tanggal Mulai Berlaku</span>[m
[31m-              <span className="date-value">{fmtDate(data.visit_start_date || data.start_date)}</span>[m
[32m+[m[32m              <span className="date-value">[m
[32m+[m[32m                {fmtDate(data.visit_start_date || data.start_date)}[m
[32m+[m[32m              </span>[m
             </div>[m
             <div className="date-item">[m
               <span className="date-label">Tanggal Berakhir</span>[m
[31m-              <span className="date-value">{fmtDate(data.visit_end_date || data.end_date)}</span>[m
[32m+[m[32m              <span className="date-value">[m
[32m+[m[32m                {fmtDate(data.visit_end_date || data.end_date)}[m
[32m+[m[32m              </span>[m
             </div>[m
             <div className="date-item">[m
               <span className="date-label">Jenis Visitor</span>[m
[31m-              <span className="date-value">{visitTypeName}</span>[m
[32m+[m[32m              <span className="date-value">{resolveVisitType(data)}</span>[m
             </div>[m
             <div className="status-item">[m
               <span className="status-label">Status Saat Ini</span>[m
[31m-              <span className="status-value-disetujui">{data.status || '-'}</span>[m
[32m+[m[32m              <span[m
[32m+[m[32m                className="status-value-disetujui"[m
[32m+[m[32m                style={{ color: isApproved ? green : isRejected ? red : '#28a745' }}[m
[32m+[m[32m              >[m
[32m+[m[32m                {isApproved ? 'Diterima' : isRejected ? 'Ditolak' : data.status || '-'}[m
[32m+[m[32m              </span>[m
             </div>[m
           </div>[m
         </div>[m
 [m
[31m-        <div className="approval-note-box">[m
[31m-          <img src={CheckBox} alt="Check Icon" className="note-check-icon" />[m
[32m+[m[32m        {/* Catatan */}[m
[32m+[m[32m        <div[m
[32m+[m[32m          className="approval-note-box"[m
[32m+[m[32m          style={{[m
[32m+[m[32m            border: `1px solid ${isApproved ? green : isRejected ? red : '#28a745'}`,[m
[32m+[m[32m            background: isApproved ? '#EAFBF3' : isRejected ? '#FFECEC' : '#f1f8f3',[m
[32m+[m[32m          }}[m
[32m+[m[32m        >[m
[32m+[m[32m          <Icon[m
[32m+[m[32m            icon={[m
[32m+[m[32m              isApproved[m
[32m+[m[32m                ? 'material-symbols:check-box-rounded'[m
[32m+[m[32m                : isRejected[m
[32m+[m[32m                ? 'solar:danger-triangle-bold'[m
[32m+[m[32m                : 'material-symbols:info'[m
[32m+[m[32m            }[m
[32m+[m[32m            color={isApproved ? green : isRejected ? red : '#28a745'}[m
[32m+[m[32m            width={28}[m
[32m+[m[32m            height={28}[m
[32m+[m[32m          />[m
           <div className="note-content">[m
[31m-            <h5 className="note-title">{catatanTitle}</h5>[m
[32m+[m[32m            <h5[m
[32m+[m[32m              className="note-title"[m
[32m+[m[32m              style={{ color: isApproved ? green : isRejected ? red : '#28a745' }}[m
[32m+[m[32m            >[m
[32m+[m[32m              {catatanTitle}[m
[32m+[m[32m            </h5>[m
             <p className="note-text">{catatanNote}</p>[m
           </div>[m
         </div>[m
 [m
[32m+[m[32m        {/* Kontak */}[m
         <button className="contact-button">[m
[31m-          <svg className="phone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">[m
[32m+[m[32m          <svg[m
[32m+[m[32m            className="phone-icon"[m
[32m+[m[32m            xmlns="http://www.w3.org/2000/svg"[m
[32m+[m[32m            viewBox="0 0 24 24"[m
[32m+[m[32m            fill="none"[m
[32m+[m[32m            stroke="#3b82f6"[m
[32m+[m[32m            strokeWidth="2"[m
[32m+[m[32m            strokeLinecap="round"[m
[32m+[m[32m            strokeLinejoin="round"[m
[32m+[m[32m          >[m
             <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>[m
           </svg>[m
           <span>Hubungi Keamanan</span>[m
[1mdiff --git a/src/pages/HasilTolak.jsx b/src/pages/HasilTolak.jsx[m
[1mindex 37e5b1f..27e01df 100644[m
[1m--- a/src/pages/HasilTolak.jsx[m
[1m+++ b/src/pages/HasilTolak.jsx[m
[36m@@ -1,12 +1,13 @@[m
 import React, { useEffect, useState } from 'react';[m
[31m-import { useLocation } from 'react-router-dom';[m
[32m+[m[32mimport { useLocation, useNavigate } from 'react-router-dom';[m
 import { getVisitorCardDetail, checkStatus, getStations } from '../api';[m
[32m+[m[32mimport { Icon } from '@iconify/react';[m
 import './HasilTolak.css';[m
[31m-import CrossIcon from '../assets/silang.svg';[m
 import DetailInfoIcon from '../assets/detailinfo.svg';[m
 [m
 const HasilTolak = () => {[m
   const location = useLocation();[m
[32m+[m[32m  const navigate = useNavigate();[m
   const rawNomor = location.state?.nomor;[m
   const nomor = (rawNomor ?? '').toString().trim();[m
 [m
[36m@@ -14,33 +15,21 @@[m [mconst HasilTolak = () => {[m
   const [stationsMap, setStationsMap] = useState(new Map());[m
   const [loading, setLoading] = useState(true);[m
   const [error, setError] = useState('');[m
[32m+[m
[32m+[m[32m  // hover state untuk tombol Ajukan Ulang[m
[32m+[m[32m  const [hovered, setHovered] = useState(false);[m
[32m+[m
[32m+[m[32m  const red = '#E54000';[m
[32m+[m
[32m+[m[32m  // === Normalizer WIB ===[m
   const normalizeDateString = (t) => {[m
[31m-    if (t === null || t === undefined) return '';[m
[32m+[m[32m    if (!t) return '';[m
     const s = String(t).trim();[m
     if (!s || /^null|undefined$/i.test(s)) return '';[m
[31m-[m
     if (/^\d{10}$/.test(s)) return new Date(Number(s) * 1000).toISOString();[m
     if (/^\d{13}$/.test(s)) return new Date(Number(s)).toISOString();[m
[31m-[m
[31m-    const isoMicro = s.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})\.(\d+)(Z|[+\-]\d{2}:\d{2})$/);[m
[31m-    if (isoMicro) {[m
[31m-      const ms = isoMicro[2].slice(0, 3).padEnd(3, '0');[m
[31m-      return `${isoMicro[1]}.${ms}${isoMicro[3]}`;[m
[31m-    }[m
[31m-[m
[31m-    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(Z|[+\-]\d{2}:\d{2})?$/.test(s)) {[m
[31m-      if (/[Z+\-]\d{2}:\d{2}$/.test(s)) return s;[m
[31m-      return `${s}+07:00`;[m
[31m-    }[m
[31m-[m
[31m-    if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(s)) {[m
[31m-      return s.replace(' ', 'T') + '+07:00';[m
[31m-    }[m
[31m-[m
[31m-    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {[m
[31m-      return `${s}T00:00:00+07:00`;[m
[31m-    }[m
[31m-[m
[32m+[m[32m    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return `${s}T00:00:00+07:00`;[m
[32m+[m[32m    if (/^\d{4}-\d{2}-\d{2} /.test(s)) return s.replace(' ', 'T') + '+07:00';[m
     return s;[m
   };[m
 [m
[36m@@ -49,23 +38,7 @@[m [mconst HasilTolak = () => {[m
     if (!norm) return '-';[m
     const d = new Date(norm);[m
     if (isNaN(d.getTime())) return '-';[m
[31m-    try {[m
[31m-      const parts = new Intl.DateTimeFormat('en-GB', {[m
[31m-        timeZone: 'Asia/Jakarta',[m
[31m-        hour12: false,[m
[31m-        year: 'numeric',[m
[31m-        month: '2-digit',[m
[31m-        day: '2-digit',[m
[31m-        hour: '2-digit',[m
[31m-        minute: '2-digit',[m
[31m-        second: '2-digit',[m
[31m-      }).formatToParts(d);[m
[31m-      const get = (type) => parts.find((p) => p.type === type)?.value || '';[m
[31m-      return `${get('hour')}:${get('minute')}:${get('second')}, ${get('day')}/${get('month')}/${get('year')}`;[m
[31m-    } catch {[m
[31m-      const pad = (n) => String(n).padStart(2, '0');[m
[31m-      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}, ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;[m
[31m-    }[m
[32m+[m[32m    return d.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });[m
   };[m
 [m
   const fmtDate = (t) => {[m
[36m@@ -81,132 +54,189 @@[m [mconst HasilTolak = () => {[m
     }).format(d);[m
   };[m
 [m
[32m+[m[32m  // === Map stasiun (id/code/station_code/station_id/nama -> nama) ===[m
   useEffect(() => {[m
     let mounted = true;[m
     (async () => {[m
       try {[m
         const res = await getStations();[m
[31m-        const raw = Array.isArray(res?.data) ? res.data : Array.isArray(res?.data?.data) ? res.data.data : [];[m
[32m+[m[32m        const raw = Array.isArray(res?.data)[m
[32m+[m[32m          ? res.data[m
[32m+[m[32m          : Array.isArray(res?.data?.data)[m
[32m+[m[32m          ? res.data.data[m
[32m+[m[32m          : [];[m
         const m = new Map();[m
         raw.forEach((it, idx) => {[m
[31m-          const id  = (typeof it?.id === 'number') ? it.id : (it?.code ?? it?.station_code ?? idx);[m
[31m-          const nm  = it?.name ?? it?.station_name ?? it?.nama ?? it?.title ?? it?.label ?? `Stasiun ${idx+1}`;[m
[31m-          if (id !== undefined && id !== null) m.set(String(id), String(nm));[m
[31m-          if (it?.code)         m.set(String(it.code), String(nm));[m
[31m-          if (it?.station_code) m.set(String(it.station_code), String(nm));[m
[31m-          m.set(String(nm), String(nm));[m
[32m+[m[32m          const nm =[m
[32m+[m[32m            it?.name ??[m
[32m+[m[32m            it?.station_name ??[m
[32m+[m[32m            it?.nama ??[m
[32m+[m[32m            it?.title ??[m
[32m+[m[32m            it?.label ??[m
[32m+[m[32m            `Stasiun ${idx + 1}`;[m
[32m+[m[32m          const keys = [it?.id, it?.code, it?.station_code, it?.station_id, nm];[m
[32m+[m[32m          keys.forEach((k) => {[m
[32m+[m[32m            if (k !== undefined && k !== null && String(k).trim() !== '') {[m
[32m+[m[32m              m.set(String(k), String(nm));[m
[32m+[m[32m            }[m
[32m+[m[32m          });[m
         });[m
         if (mounted) setStationsMap(m);[m
[31m-      } catch {}[m
[32m+[m[32m      } catch {[m
[32m+[m[32m        // biarkan kosong jika gagal[m
[32m+[m[32m      }[m
     })();[m
[31m-    return () => { mounted = false; };[m
[32m+[m[32m    return () => {[m
[32m+[m[32m      mounted = false;[m
[32m+[m[32m    };[m
   }, []);[m
 [m
[32m+[m[32m  // === Resolver stasiun (pakai map; kalau sudah nama, pakai langsung) ===[m
   const resolveStationName = (d) => {[m
[31m-    const candidates = [ d?.station_name, d?.visit_station, d?.station, d?.station_code, d?.station_id ][m
[31m-      .filter(v => v !== undefined && v !== null);[m
[31m-    for (const c of candidates) {[m
[32m+[m[32m    const cands = [[m
[32m+[m[32m      d?.station_name,[m
[32m+[m[32m      d?.visit_station,[m
[32m+[m[32m      d?.station,[m
[32m+[m[32m      d?.station_code,[m
[32m+[m[32m      d?.station_id,[m
[32m+[m[32m    ].filter((v) => v !== undefined && v !== null);[m
[32m+[m[32m    for (const c of cands) {[m
       const key = String(c);[m
       if (stationsMap.has(key)) return stationsMap.get(key);[m
[31m-      if (isNaN(Number(key)) && key.trim()) return key;[m
[32m+[m[32m      if (isNaN(Number(key)) && key.trim()) return key; // sudah nama[m
     }[m
     return '-';[m
   };[m
 [m
[31m-  // === Jenis Visitor ===[m
   const resolveVisitType = (d) => {[m
[31m-    const candidates = [[m
[31m-      d?.visit_type_label, d?.visit_type_name, d?.visit_type, d?.visitor_type,[m
[31m-      d?.jenis_kunjungan, d?.type_name, d?.type[m
[31m-    ].filter(v => v !== undefined && v !== null);[m
[31m-    for (const c of candidates) {[m
[32m+[m[32m    const cands = [[m
[32m+[m[32m      d?.visit_type_label,[m
[32m+[m[32m      d?.visit_type,[m
[32m+[m[32m      d?.visitor_type,[m
[32m+[m[32m      d?.jenis_kunjungan,[m
[32m+[m[32m      d?.type_name,[m
[32m+[m[32m      d?.type,[m
[32m+[m[32m    ].filter(Boolean);[m
[32m+[m[32m    for (const c of cands) {[m
       const s = String(c).trim();[m
       if (s) return s;[m
     }[m
     return '-';[m
   };[m
 [m
[32m+[m[32m  // === Ambil detail ===[m
   async function fetchDetail(n) {[m
[31m-    try { const r1 = await getVisitorCardDetail(n);            const d1 = r1?.data?.data ?? r1?.data ?? null; if (d1) return d1; } catch {}[m
[31m-    try { const r2 = await getVisitorCardDetail({ reference_number: n }); const d2 = r2?.data?.data ?? r2?.data ?? null; if (d2) return d2; } catch {}[m
[31m-    try { const r3 = await checkStatus({ reference_number: n });         const d3 = r3?.data?.data ?? r3?.data ?? null; if (d3) return d3; } catch (e) { throw e; }[m
[32m+[m[32m    try {[m
[32m+[m[32m      const r1 = await getVisitorCardDetail(n);[m
[32m+[m[32m      const d1 = r1?.data?.data ?? r1?.data ?? null;[m
[32m+[m[32m      if (d1) return d1;[m
[32m+[m[32m    } catch {}[m
[32m+[m[32m    try {[m
[32m+[m[32m      const r2 = await checkStatus({ reference_number: n });[m
[32m+[m[32m      const d2 = r2?.data?.data ?? r2?.data ?? null;[m
[32m+[m[32m      if (d2) return d2;[m
[32m+[m[32m    } catch {}[m
     return null;[m
   }[m
 [m
[32m+[m[32m  // === Fetch awal ===[m
   useEffect(() => {[m
     let mounted = true;[m
     if (!nomor) {[m
[31m-      setError('Nomor referensi tidak ditemukan. Silakan kembali dan masukkan nomor Anda.');[m
[32m+[m[32m      setError('Nomor referensi tidak ditemukan.');[m
       setLoading(false);[m
       return;[m
     }[m
     (async () => {[m
[31m-      setLoading(true); setError('');[m
       try {[m
         const d = await fetchDetail(nomor);[m
         if (!mounted) return;[m
[31m-        if (!d) setError('Data tidak ditemukan. Pastikan nomor referensi benar.');[m
[32m+[m[32m        if (!d) setError('Data tidak ditemukan.');[m
         else setData(d);[m
[31m-      } catch (e) {[m
[32m+[m[32m      } catch {[m
         if (!mounted) return;[m
[31m-        const status = e?.response?.status;[m
[31m-        if (status === 404) setError('Data tidak ditemukan (404). Periksa nomor referensi Anda.');[m
[31m-        else if (status === 401 || status === 403) setError('Tidak memiliki akses ke data (401/403).');[m
[31m-        else setError('Gagal memuat data dari server.');[m
[32m+[m[32m        setError('Gagal memuat data dari server.');[m
       } finally {[m
         if (mounted) setLoading(false);[m
       }[m
     })();[m
[31m-    return () => { mounted = false; };[m
[31m-  }, [nomor]);[m
[31m-[m
[31m-  useEffect(() => {[m
[31m-    if (!nomor) return;[m
[31m-    const id = setInterval(() => {[m
[31m-      fetchDetail(nomor).then((d) => d && setData(d)).catch(() => {});[m
[31m-    }, 30000);[m
[31m-    return () => clearInterval(id);[m
[32m+[m[32m    return () => {[m
[32m+[m[32m      mounted = false;[m
[32m+[m[32m    };[m
   }, [nomor]);[m
 [m
   if (loading) return <div>Loading...</div>;[m
[31m-  if (error)   return <div className="text-red-500 p-4">{error}</div>;[m
[31m-  if (!data)   return <div className="p-4">Data kosong.</div>;[m
[32m+[m[32m  if (error) return <div className="text-red-500 p-4">{error}</div>;[m
[32m+[m[32m  if (!data) return <div>Data kosong.</div>;[m
 [m
   const lastUpdated =[m
[31m-    data?.last_updated_at ??[m
[31m-    data?.updated_at ??[m
[31m-    data?.rejected_at ?? data?.processed_at ??[m
[31m-    data?.created_at ?? '';[m
[32m+[m[32m    data?.last_updated_at ||[m
[32m+[m[32m    data?.updated_at ||[m
[32m+[m[32m    data?.rejected_at ||[m
[32m+[m[32m    data?.processed_at ||[m
[32m+[m[32m    data?.created_at ||[m
[32m+[m[32m    '';[m
 [m
[31m-  const stationName   = resolveStationName(data);[m
[32m+[m[32m  const stationName = resolveStationName(data);[m
   const visitTypeName = resolveVisitType(data);[m
[31m-  const reason        = data.rejection_reason || data.reason || '-';[m
[32m+[m[32m  const reason = data.rejection_reason || data.reason || '-';[m
[32m+[m
[32m+[m[32m  // === Handler Ajukan Ulang ===[m
[32m+[m[32m  const goApply = () => {[m
[32m+[m[32m    navigate('/apply', {[m
[32m+[m[32m      state: {[m
[32m+[m[32m        from: 'hasil-tolak',[m
[32m+[m[32m        previous_reference: data?.reference_number ?? nomor,[m
[32m+[m[32m        full_name: data?.full_name,[m
[32m+[m[32m        visit_purpose: data?.visit_purpose,[m
[32m+[m[32m        station_name: stationName,[m
[32m+[m[32m      },[m
[32m+[m[32m      replace: false,[m
[32m+[m[32m    });[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  // Style tombol dinamis berdasarkan hover[m
[32m+[m[32m  const btnStyle = {[m
[32m+[m[32m    border: `1px solid ${red}`,[m
[32m+[m[32m    color: hovered ? '#FFFFFF' : red,[m
[32m+[m[32m    fontWeight: 600,[m
[32m+[m[32m    borderRadius: 8,[m
[32m+[m[32m    padding: '10px 20px',[m
[32m+[m[32m    display: 'flex',[m
[32m+[m[32m    alignItems: 'center',[m
[32m+[m[32m    gap: 8,[m
[32m+[m[32m    background: hovered ? red : 'white',[m
[32m+[m[32m    cursor: 'pointer',[m
[32m+[m[32m    transition: 'background 120ms ease, color 120ms ease',[m
[32m+[m[32m    userSelect: 'none',[m
[32m+[m[32m  };[m
 [m
   return ([m
[31m-    <div className="page-wrapper-hasil">[m
[31m-      <div className="main-card-container">[m
[32m+[m[32m    <div className="page-wrapper-hasil" style={{ background: '#EBF1F8' }}>[m
[32m+[m[32m      <div className="main-card-container" style={{ borderTop: `5px solid ${red}` }}>[m
         {/* Header */}[m
         <div className="status-header">[m
[31m-          <img src={CrossIcon} alt="Rejected Icon" className="cross-icon-tolak" />[m
[31m-          <div className="status-text-tolak">[m
[32m+[m[32m          <Icon icon="ep:close-bold" color={red} width={90} height={90} />[m
[32m+[m[32m          <div className="status-text-tolak" style={{ color: red }}>[m
             <h3>Permohonan Ditolak</h3>[m
[31m-            <p>Mohon periksa kembali data/dokumen Anda sesuai catatan berikut</p>[m
[32m+[m[32m            <p>Permohonan anda tidak dapat diproses lebih lanjut</p>[m
             <p className="last-updated-tolak">Terakhir diperbarui: {fmtFull(lastUpdated)}</p>[m
           </div>[m
         </div>[m
 [m
[32m+[m[32m        {/* Info Grid */}[m
         <div className="info-grid-tolak">[m
           <div className="info-item-tolak">[m
             <span className="info-label-tolak">NOMOR REFERENSI</span>[m
[31m-            <span className="info-value-tolak">{data.reference_number}</span>[m
[32m+[m[32m            <span className="info-value-tolak">{data.reference_number || '-'}</span>[m
           </div>[m
           <div className="info-item-tolak">[m
             <span className="info-label-tolak">NAMA PEMOHON</span>[m
[31m-            <span className="info-value-tolak">{data.full_name}</span>[m
[32m+[m[32m            <span className="info-value-tolak">{data.full_name || '-'}</span>[m
           </div>[m
           <div className="info-item-tolak">[m
             <span className="info-label-tolak">TUJUAN KUNJUNGAN</span>[m
[31m-            <span className="info-value-tolak">{data.visit_purpose}</span>[m
[32m+[m[32m            <span className="info-value-tolak">{data.visit_purpose || '-'}</span>[m
           </div>[m
           <div className="info-item-tolak">[m
             <span className="info-label-tolak">STASIUN KUNJUNGAN</span>[m
[36m@@ -224,11 +254,15 @@[m [mconst HasilTolak = () => {[m
           <div className="date-status-grid-tolak">[m
             <div className="date-item-tolak">[m
               <span className="date-label-tolak">Tanggal Mulai Berlaku</span>[m
[31m-              <span className="date-value-tolak">{fmtDate(data.visit_start_date || data.start_date)}</span>[m
[32m+[m[32m              <span className="date-value-tolak">[m
[32m+[m[32m                {fmtDate(data.visit_start_date || data.start_date)}[m
[32m+[m[32m              </span>[m
             </div>[m
             <div className="date-item-tolak">[m
               <span className="date-label-tolak">Tanggal Berakhir</span>[m
[31m-              <span className="date-value-tolak">{fmtDate(data.visit_end_date || data.end_date)}</span>[m
[32m+[m[32m              <span className="date-value-tolak">[m
[32m+[m[32m                {fmtDate(data.visit_end_date || data.end_date)}[m
[32m+[m[32m              </span>[m
             </div>[m
             <div className="date-item-tolak">[m
               <span className="date-label-tolak">Jenis Visitor</span>[m
[36m@@ -236,20 +270,50 @@[m [mconst HasilTolak = () => {[m
             </div>[m
             <div className="status-item-tolak">[m
               <span className="status-label-tolak">Status Saat Ini</span>[m
[31m-              <span className="status-value-tolak">{data.status || 'rejected'}</span>[m
[32m+[m[32m              <span className="status-value-tolak" style={{ color: red, fontWeight: 600 }}>[m
[32m+[m[32m                Ditolak[m
[32m+[m[32m              </span>[m
             </div>[m
           </div>[m
         </div>[m
 [m
[31m-        <div className="rejection-note-box-tolak">[m
[32m+[m[32m        {/* Alasan Penolakan */}[m
[32m+[m[32m        <div[m
[32m+[m[32m          className="rejection-note-box-tolak"[m
[32m+[m[32m          style={{[m
[32m+[m[32m            border: `1px solid ${red}`,[m
[32m+[m[32m            background: '#FFECEC',[m
[32m+[m[32m            borderRadius: 8,[m
[32m+[m[32m            padding: 24,[m
[32m+[m[32m            display: 'flex',[m
[32m+[m[32m            gap: 16,[m
[32m+[m[32m            alignItems: 'flex-start',[m
[32m+[m[32m          }}[m
[32m+[m[32m        >[m
[32m+[m[32m          <Icon icon="solar:danger-triangle-bold" color={red} width={28} height={28} />[m
           <div className="note-content-tolak">[m
[31m-            <h5>Alasan Penolakan</h5>[m
[31m-            <p>{reason}</p>[m
[32m+[m[32m            <h5 style={{ color: red, margin: 0 }}>Alasan Penolakan</h5>[m
[32m+[m[32m            <p style={{ marginTop: 6 }}>{reason}</p>[m
           </div>[m
         </div>[m
 [m
[31m-        <div className="button-group-tolak">[m
[31m-          <button className="re-apply-button-tolak">Ajukan Ulang</button>[m
[32m+[m[32m        {/* Tombol Ajukan Ulang (hover -> merah, teks+icon putih) */}[m
[32m+[m[32m        <div className="button-group-tolak" style={{ marginTop: 24 }}>[m
[32m+[m[32m          <button[m
[32m+[m[32m            className="re-apply-button-tolak"[m
[32m+[m[32m            style={btnStyle}[m
[32m+[m[32m            onMouseEnter={() => setHovered(true)}[m
[32m+[m[32m            onMouseLeave={() => setHovered(false)}[m
[32m+[m[32m            onClick={goApply}[m
[32m+[m[32m          >[m
[32m+[m[32m            <Icon[m
[32m+[m[32m              icon="mingcute:repeat-line"[m
[32m+[m[32m              color={hovered ? '#FFFFFF' : red}[m
[32m+[m[32m              width={20}[m
[32m+[m[32m              height={20}[m
[32m+[m[32m            />[m
[32m+[m[32m            <span style={{ color: hovered ? '#FFFFFF' : red }}>Ajukan Ulang</span>[m
[32m+[m[32m          </button>[m
         </div>[m
       </div>[m
     </div>[m
